(()=>{"use strict";var e={77:(e,t,n)=>{const r=require("http");var a=n.n(r);const o=require("throng");var i=n.n(o);const s=require("bunyan");var c=n.n(s);const d=JSON.parse('{"u2":"inv-mannager","i8":"1.7.0"}');n(142).config();var u=d.u2,p=d.i8,l=function(e,t,n){return c().createLogger({name:"".concat(e,":").concat(t),level:n})};const m={development:{PORT:process.env.PORT,mongoKey:process.env.MONGO_KEY,tinyKey:process.env.TINY_KEY,jwtKey:process.env.JWT_KEY,jwtLogin:process.env.JWT_LOGIN,jwtGoogleLogin:process.env.JWT_GOOGLE_LOGIN,awsID:process.env.AWS_ID,awsKey:process.env.AWS_KEY,bucket:process.env.S3_BUCKET,sunatToken:process.env.SUNAT_TOKEN,googleClientID:process.env.GOOGLE_CLIENT_ID,googleClientSecret:process.env.GOOGLE_CLIENT_SECRET,callBackUrl:process.env.CALLBACK_URL_TEST,BHOST:process.env.HOST_SENDIBLUE,BPORT:process.env.PORT_SENDIBLUE,BUSER:process.env.USER_SENDIBLUE,BPASS:process.env.PASSWORD_SENDIBLUE,nbfToken:process.env.NBF_TOKEN,reToken:process.env.RE_TOKEN,emailFrom:"loginmanager@siriodinar.com",version:p,link:"http://localhost:5000/",link_front:"http://localhost:4000/",origin:["http://localhost:4200","http://localhost:4000"],log:function(){return l(u,p,"debug")}},production:{PORT:process.env.PORT,mongoKey:process.env.MONGO_KEY,tinyKey:process.env.TINY_KEY,jwtKey:process.env.JWT_KEY,jwtLogin:process.env.JWT_LOGIN,jwtGoogleLogin:process.env.JWT_GOOGLE_LOGIN,awsID:process.env.AWS_ID,awsKey:process.env.AWS_KEY,bucket:process.env.S3_BUCKET,sunatToken:process.env.SUNAT_TOKEN,googleClientID:process.env.GOOGLE_CLIENT_ID,googleClientSecret:process.env.GOOGLE_CLIENT_SECRET,callBackUrl:process.env.CALLBACK_URL,BHOST:process.env.HOST_SENDIBLUE,BPORT:process.env.PORT_SENDIBLUE,BUSER:process.env.USER_SENDIBLUE,BPASS:process.env.PASSWORD_SENDIBLUE,nbfToken:process.env.NBF_TOKEN,reToken:process.env.RE_TOKEN,version:p,emailFrom:"loginmanager@siriodinar.com",link:"https://inventario-sirio-dinar.herokuapp.com/",link_front:"https://inventario.siriodinar.com/",origin:["https://inventario.siriodinar.com","https://sirio-inventario-front.herokuapp.com"],log:function(){return l(u,p,"debug")}}},g=require("compression");var f=n.n(g);const y=require("cookie-parser");var b=n.n(y);const h=require("cors");var v=n.n(h);const $=require("express");var x=n.n($);const w=require("helmet");var S=n.n(w);const C=require("jsonwebtoken");var V=n.n(C);const k=require("path");var T=n.n(k);const j=require("tinify");var N=n.n(j);const O=require("@babel/runtime/helpers/asyncToGenerator");var A=n.n(O);const I=require("@babel/runtime/regenerator");var _=n.n(I);const P=require("fs"),E=require("nodemailer");var D=n.n(E);const q=require("util");var G=m.production,M=(0,q.promisify)(P.readFile),R=D().createTransport({host:G.BHOST,port:G.BPORT,secure:!1,auth:{user:G.BUSER,pass:G.BPASS}}),L=function(){var e=A()(_().mark((function e(t,n){var r,a,o;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,M(T().resolve("server/lib/emailContacto.html"),{encoding:"utf8"});case 3:return r=e.sent,a=r.replace("#replaceWithLinkOne","Mensaje de ".concat(t.body.nombre," ").concat(t.body.apellido,", su correo es: ").concat(t.body.email)),o=a.replace("#replaceWithLinkTwo",t.body.mensaje),e.next=8,R.sendMail({from:"siriodinar-no-replay@siriodinar.com",to:G.BUSER,subject:"Mensaje Contacto",html:o});case 8:n.json({enviado:!0}),e.next=14;break;case 11:return e.prev=11,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 14:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(t,n){return e.apply(this,arguments)}}(),U=function(){var e=A()(_().mark((function e(t,n){var r,a,o;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,M(T().resolve("server/lib/email.html"),{encoding:"utf8"});case 3:return r=e.sent,t.savedUSer.hashPassword=void 0,a="".concat(G.link,"auth/confirmacion/").concat(t.savedUSer._id),o=r.replace("#replaceWithLink",'<a style="width: 400px; font-size: 20px; text-align: center; margin-top: 0.67em" href="'.concat(a,'" target="_blank">').concat(a,"</a>")),e.next=9,R.sendMail({from:"siriodinar-no-replay@siriodinar.com",to:t.savedUSer.email,subject:"Confimar registro de cuenta en Sirio Dinar",html:o});case 9:n.json(t.savedUSer),e.next=15;break;case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({link:!1}));case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t,n){return e.apply(this,arguments)}}();const B=require("bcrypt");var F=n.n(B);const z=require("mongoose");var W=n.n(z);const K=require("passport");var J=n.n(K);const H=require("passport-google-oauth20");var Y=n.n(H),Q=new z.Schema({username:{type:String,required:!0,unique:!0,lowercase:!0,trim:!0},hashPassword:{type:String},type:{type:String,required:!0,trim:!0},created_date:{type:Date,default:Date.now},displayName:{type:String,required:!0,trim:!0},email:{type:String,trim:!0,unique:!0},dirOne:{type:String,trim:!0},dirTwo:{type:String,trim:!0},reference:{type:String,trim:!0},ciudad:{type:String,trim:!0},nombre:{type:String,trim:!0},apellido:{type:String,trim:!0},nomape:{type:String},googleCod:{type:String,unique:!0},documento:{type:String,trim:!0},tipoPersona:{type:String},verified:{type:Boolean,default:!1},celular:{type:String},ventaActiva:{type:[String],default:[]},carrito:{type:String,default:"not"}});Q.methods.comparePassword=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,F().compare(t,n);case 3:return r=e.sent,e.abrupt("return",r);case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",e.t0);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}();var Z=W().model("User",Q),X=Y().Strategy,ee=J().use(new X({clientID:m.production.googleClientID,clientSecret:m.production.googleClientSecret,callbackURL:m.production.callBackUrl},(function(e,t,n,r){return r(null,n)}))),te=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=e.split(" ").join("");return e.startsWith("+")||(t="+51"+e.split(" ").join("")),t},ne=function(){var e=A()(_().mark((function e(t,n,r){var a,o,i;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=t.body.displayName.toLowerCase(),(o=new Z(t.body)).celular=te(t.body.celular),o.username=a,e.next=7,F().hash(t.body.password,10);case 7:return o.hashPassword=e.sent,o.type="low",o.nombre=t.body.nombre.toUpperCase(),o.apellido=t.body.apellido.toUpperCase(),e.next=13,o.save();case 13:(i=e.sent).hashPassword=void 0,t.savedUSer=i,r(),e.next=22;break;case 19:return e.prev=19,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 22:case"end":return e.stop()}}),e,null,[[0,19]])})));return function(t,n,r){return e.apply(this,arguments)}}(),re=function(){var e=A()(_().mark((function e(t,n){return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findById(t.body.idUser);case 3:if(!1!==e.sent.verified){e.next=6;break}return e.abrupt("return",n.json({reload:!1}));case 6:return e.abrupt("return",n.json({reload:!0}));case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 12:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t,n){return e.apply(this,arguments)}}(),ae=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findById(t.params.idUser);case 3:if(!1!==(r=e.sent).verified){e.next=9;break}return a=V().sign({_id:r._id},m.production.jwtLogin,{expiresIn:"120s"}),e.next=8,Z.findByIdAndUpdate(r._id,{verified:!0},{useFindAndModify:!1});case 8:return e.abrupt("return",n.redirect("".concat(m.production.link_front,"login/auto/").concat(a)));case 9:return e.abrupt("return",n.status(202).send("<h1>Este usuario ya esta verificado.</h1>"));case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t,n){return e.apply(this,arguments)}}(),oe=function(){var e=A()(_().mark((function e(t,n,r){return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:V().verify(t.body.loginToken,m.production.jwtLogin,(function(e,a){if(e)return"TokenExpiredError"===e.name?n.status(400).json({error:"Token Expirado"}):n.status(500).json({error:e.message});t.logintoken=a,r()}));case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),ie=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findById(t.logintoken._id);case 3:return r=e.sent,e.abrupt("return",n.json({displayName:r.displayName,username:r.username,success:!0,message:"Success",type:r.type,token:V().sign({aud:r.username+" "+r.type,_id:r.id},m.production.jwtKey)}));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),se=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.exists({username:t.params.username.toLowerCase()});case 3:return r=e.sent,e.abrupt("return",n.json({exists:r}));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),ce=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.exists({email:t.params.email.toLowerCase()});case 3:return r=e.sent,e.abrupt("return",n.json({exists:r}));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),de=function(){var e=A()(_().mark((function e(t,n,r){var a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.exists({email:t.user._json.email});case 3:if(!e.sent){e.next=6;break}return e.abrupt("return",r());case 6:return a=V().sign(t.user._json,m.production.jwtGoogleLogin,{expiresIn:"30s"}),e.abrupt("return",n.redirect("".concat(m.production.link_front,"login/registro/").concat(a)));case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,n,r){return e.apply(this,arguments)}}(),ue=function(){var e=A()(_().mark((function e(t,n,r){var a,o;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findOneAndUpdate({email:t.user._json.email},{verified:!0},{new:!0,useFindAndModify:!1});case 3:return a=e.sent,o=V().sign({_id:a._id},m.production.jwtLogin,{expiresIn:"120s"}),e.next=7,Z.findByIdAndUpdate(a._id,{verified:!0},{useFindAndModify:!1});case 7:return e.abrupt("return",n.redirect("".concat(m.production.link_front,"login/auto/").concat(o)));case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,n,r){return e.apply(this,arguments)}}(),pe=function(){var e=A()(_().mark((function e(t,n){return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:V().verify(t.body.loginToken,m.production.jwtGoogleLogin,(function(e,t){return e?"TokenExpiredError"===e.name?n.status(400).json({error:"Token Expirado"}):n.status(500).json({error:e.message}):n.json(t)}));case 1:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),le=function(e,t,n){if(!e.user||"admin"!==e.user.aud.split(" ")[1])return t.status(401).json({message:"Usuario No Autorizado"});n()},me=function(e,t,n){if(!e.user||"low"!==e.user.aud.split(" ")[1])return t.status(401).json({message:"Usuario No Autorizado"});n()},ge=function(e,t,n){if(!e.user||"vent"!==e.user.aud.split(" ")[1]&&"admin"!==e.user.aud.split(" ")[1]&&"contador"!==e.user.aud.split(" ")[1])return t.status(401).json({message:"Usuario No Autorizado"});n()},fe=function(e,t,n){if(!e.user||"vent"!==e.user.aud.split(" ")[1]&&"admin"!==e.user.aud.split(" ")[1])return t.status(401).json({message:"Usuario No Autorizado"});n()},ye=function(e,t,n){if(!e.user)return t.status(401).json({message:"Usuario No Autorizado"});n()},be=function(){var e=A()(_().mark((function e(t,n){var r,a,o;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=t.body.username,(a=new Z(t.body)).displayName=r,a.username=r.toLowerCase(),e.next=7,F().hash(t.body.password,10);case 7:return a.hashPassword=e.sent,e.next=10,a.save();case 10:return(o=e.sent).hashPassword=void 0,e.abrupt("return",n.json(o));case 15:return e.prev=15,e.t0=e.catch(0),e.abrupt("return",n.status(e.t0.status||400).send({message:e.t0}));case 18:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(t,n){return e.apply(this,arguments)}}(),he=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findOne({username:t.body.username.toLowerCase()});case 3:if(r=e.sent){e.next=6;break}return e.abrupt("return",n.status(400).json({username:t.body.username,success:!1,message:"Usuario no encontrado",token:null}));case 6:return e.next=8,r.comparePassword(t.body.password,r.hashPassword);case 8:if(e.sent){e.next=12;break}return e.abrupt("return",n.status(400).json({username:t.body.username,success:!1,message:"Contraseña incorrecta",token:null}));case 12:return e.abrupt("return",n.json({displayName:r.displayName,username:r.username,success:!0,message:"Success",type:r.type,token:V().sign({aud:r.username+" "+r.type,_id:r.id},m.production.jwtKey)}));case 13:e.next=18;break;case 15:throw e.prev=15,e.t0=e.catch(0),e.t0;case 18:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(t,n){return e.apply(this,arguments)}}(),ve=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findOne({username:t.params.username.toLowerCase()});case 3:(r=e.sent).hashPassword=void 0,n.json(r),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),$e=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findOne({username:t.user.aud.split(" ")[0]});case 3:(r=e.sent).hashPassword=void 0,n.json(r),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),xe=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findOneAndUpdate({_id:t.body.id},{celular:te(t.body.celular)},{useFindAndModify:!1,new:!0});case 3:(r=e.sent).hashPassword=void 0,n.json(r),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),we=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findOneAndUpdate({_id:t.body.id},{dirOne:t.body.dirOne,dirTwo:t.body.dirTwo||"",reference:t.body.reference,city:"Trujillo, La Libertad. Perú"},{useFindAndModify:!1,new:!0});case 3:(r=e.sent).hashPassword=void 0,n.json(r),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),Se=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findOneAndUpdate({_id:t.body.id},{documento:t.body.documento,tipoPersona:t.body.tipoPersona},{useFindAndModify:!1,new:!0});case 3:(r=e.sent).hashPassword=void 0,n.json(r),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),Ce=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findById(t.body.id);case 3:return r=e.sent,e.next=6,r.comparePassword(t.body.oldPassword,r.hashPassword);case 6:if(e.sent){e.next=8;break}return e.abrupt("return",n.json({valid:!1}));case 8:n.json({valid:!0}),e.next=14;break;case 11:return e.prev=11,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 14:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(t,n){return e.apply(this,arguments)}}(),Ve=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findById(t.body.id);case 3:return r=e.sent,e.next=6,r.comparePassword(t.body.passwordOld,r.hashPassword);case 6:if(e.sent){e.next=8;break}return e.abrupt("return",n.json({changed:!1}));case 8:return e.next=10,F().hash(t.body.password,10);case 10:return a=e.sent,e.next=13,Z.findByIdAndUpdate(t.body.id,{hashPassword:a},{new:!0,useFindAndModify:!1});case 13:return e.abrupt("return",n.json({changed:!0}));case 16:return e.prev=16,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 19:case"end":return e.stop()}}),e,null,[[0,16]])})));return function(t,n){return e.apply(this,arguments)}}(),ke=function(){var e=A()(_().mark((function e(t,n){return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findOneAndUpdate({username:t.user.aud.split(" ")[0]},{$push:{ventaActiva:t.saveResult.codigo}},{useFindAndModify:!1});case 3:if(void 0!==t.saveResult&&null!==t.saveResult){e.next=5;break}return e.abrupt("return",n.status(400).json({message:"No se pudo generar la venta"}));case 5:return e.abrupt("return",n.json({message:"Venta generada con el código: ".concat(t.saveResult.codigo),venta:t.saveResult}));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),Te=function(){var e=A()(_().mark((function e(t,n,r){var a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findOne({username:t.user.aud.split(" ")[0]});case 3:a=e.sent,n.json(a.ventaActiva),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n,r){return e.apply(this,arguments)}}(),je=function(){var e=A()(_().mark((function e(t,n,r){var a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Z.findOne({username:t.user.aud.split(" ")[0]});case 3:a=e.sent,t.ventaCod=a.ventaActiva,r(),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n,r){return e.apply(this,arguments)}}(),Ne=function(){var e=A()(_().mark((function e(t,n,r){var a,o,i;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=t.body.displayName.toLowerCase(),(o=new Z(t.body)).celular=te(t.body.celular),o.username=a,e.next=7,F().hash(t.body.password,10);case 7:return o.hashPassword=e.sent,o.type="low",o.nombre=t.body.nombre.toUpperCase(),o.apellido=t.body.apellido.toUpperCase(),o.verified=!0,e.next=14,o.save();case 14:return(i=e.sent).hashPassword=void 0,e.abrupt("return",n.json({displayName:i.displayName,username:i.username,success:!0,message:"Success",type:i.type,token:V().sign({aud:i.username+" "+i.type,_id:i.id},m.production.jwtKey)}));case 19:return e.prev=19,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrio un error inesperado. Intentelo denuevo"}));case 22:case"end":return e.stop()}}),e,null,[[0,19]])})));return function(t,n,r){return e.apply(this,arguments)}}(),Oe=new $.Router;Oe.use(ee.initialize()),Oe.post("/cambiarContrasena",ye,Ve),Oe.post("/confirmarContr",ye,Ce),Oe.put("/actCelular",ye,xe),Oe.post("/agregarDireccion",ye,we),Oe.post("/agregarDocumento",ye,Se),Oe.post("/register",be),Oe.get("/google/callback",ee.authenticate("google",{failureRedirect:"/failed",session:!1}),de,ue),Oe.get("/google",ee.authenticate("google",{scope:["profile","email"],session:!1})),Oe.post("/login",he),Oe.get("/userEx/:username",se),Oe.get("/emailEx/:email",ce),Oe.post("/registerlow",ne,U),Oe.post("/isValid",re),Oe.get("/confirmacion/:idUser",ae),Oe.post("/loginfast",oe,ie),Oe.post("/loginGoogleRegistro",Ne),Oe.post("/getLoginInfoFromToken",pe),Oe.get("/getUserInfo/:username",ye,ve),Oe.get("/getOwnUser",ye,$e);const Ae=Oe,Ie=require("@babel/runtime/helpers/defineProperty");var _e=n.n(Ie),Pe=new z.Schema({name:{type:String},nameSecond:{type:String},cantidadDisponible:{type:Number},cantidadVenta:{type:Number}},{_id:!1}),Ee=new z.Schema({codigo:{type:String,required:!0,trim:!0},tipo:{type:String,trim:!0,default:"producto"},name:{type:String,trim:!0},descripcion:{type:String,trim:!0},priceIGV:{type:Number,required:!0,trim:!0},priceNoIGV:{type:Number,required:!0,trim:!0},priceCosto:{type:Number,default:0},cantidad:{type:Number,required:!0,trim:!0,min:0},cantidadSC:{type:[Pe],default:[]},totalPrice:{type:Number},totalPriceNoIGV:{type:Number},unidadDeMedida:{type:String},photo:{type:String},ventaCod:{type:String}},{_id:!1}),De=new z.Schema({type:{type:String,required:!0},name:{type:String,trim:!0,default:""},codigo:{type:String,trim:!0},direccion:{type:String}},{_id:!1}),qe=new z.Schema({user:{type:String,trim:!0},rating:{type:Number,default:0},date:{type:Date,default:Date.now}},{_id:!1}),Ge=new z.Schema({name:{type:String,trim:!0,required:!0},nameSecond:{type:String,trim:!0},cantidad:{type:Number,min:0}},{_id:!1}),Me=new z.Schema({name:{type:String,trim:!0,required:!0},nameSecond:{type:String,trim:!0},order:{type:[Ge]}},{_id:!1}),Re=new z.Schema({date:{type:Date,default:Date.now},cantidad:{type:Number,default:0,min:0},tipo:{type:Boolean,default:!1},comentario:{type:String,trim:!0},costoVar:{type:Number},cantidadSC:{type:[Pe],default:[]},usuario:{type:String,default:"desconocido"}},{_id:!1}),Le=new z.Schema({name:{type:String,required:!0,trim:!0,unique:!0},nameLowerCase:{type:String,trim:!0,lowercase:!0},priceIGV:{type:Number,required:!0},priceNoIGV:{type:Number},cantidad:{type:Number,default:0,min:0},subConteo:{type:Me},variaciones:{type:[Re]},codigo:{type:String,required:!0,trim:!0,unique:!0},tipo:{type:String,required:!0,trim:!0},subTipo:{type:String,default:"noone",trim:!0},unidadDeMedida:{type:String,default:"UND",trim:!0},oferta:{type:Number,default:0},date:{type:Date,default:Date.now},description:{type:String,trim:!0},photo:{type:String,trim:!0,default:"noPhoto.jpg"},ficha:{type:Boolean,default:!1},marca:{type:String,default:"noone"},costoPropio:{type:Number},multiSearchParams:{type:String,trim:!0},deleted:{type:Boolean,default:!1},tags:{type:[String],default:[]},caracteristicas:{type:[String],default:[]},orderNumber:{type:Number,default:-1},reviews:{type:[qe],default:[]},googleCategory:{type:String,default:"2047"}});Le.index({nameLowerCase:"text",tipo:"text",subTipo:"text",marca:"text",description:"text",tags:"text"});const Ue=Le;var Be=new z.Schema({cuota:{type:Number,required:!0},fecha_de_pago:{type:String,required:!0},importe:{type:Number,required:!0}},{_id:!1}),Fe=new z.Schema({serie:{type:String,required:!0},numero:{type:Number,required:!0},tipoComprobante:{type:Number,required:!0}},{_id:!1}),ze=new z.Schema({cuota:{type:Number,required:!0},fecha_de_pago:{type:String,required:!0},importe:{type:Number,required:!0},pagado:{type:Boolean,required:!0,default:!1}},{_id:!1});const We=new z.Schema({codigo:{type:String,required:!0,trim:!0,unique:!0},tipoVenta:{type:String,required:!0,trim:!0},totalPrice:{type:Number,trim:!0,required:!0},totalPriceNoIGV:{type:Number,trim:!0,required:!0},estado:{type:String,trim:!0,required:!0},documento:{type:De},itemsVendidos:{type:[Ee],required:!0},date:{type:Date,default:Date.now},vendedor:{type:String},tipoVendedor:{type:String,default:"admin"},medio_de_pago:{type:String},fechaDeVencimiento:{type:String},linkComprobanteAnulado:{type:String},linkComprobante:{type:String},serie:{type:String},tipoComprobante:{type:String},numero:{type:Number},cliente_email:{type:String},guias:{type:[Fe],default:[]},carrito_venta:{type:Boolean,default:!1},estado_carrito_comprando:{type:Boolean,default:!1},credits:{type:[Be],default:[]},contratoAprobado:{type:Boolean,default:!1},pagosDeContrato:{type:[ze],default:[]}});function Ke(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Je(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ke(Object(n),!0).forEach((function(t){_e()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ke(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var He=W().model("Item",Ue),Ye=W().model("Venta",We),Qe=W().model("User",Q),Ze=[{cod:0,mensaje:"Item Eliminado"},{cod:1,mensaje:"Cambio de precio"},{cod:2,mensaje:"Cantidad agotada"}],Xe=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s,c,d,u,p,l,m,g,f,y,b,h,v,$,x,w,S,C,V,k;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W().startSession();case 2:return(r=e.sent).startTransaction(),e.prev=4,e.next=7,Qe.findOne({username:t.user.aud.split(" ")[0]});case 7:return a=e.sent,e.next=10,He.findOne({codigo:t.body.codigo});case 10:if((o=e.sent).subConteo&&(i=""!==o.subConteo.nameSecond?o.subConteo.order.find((function(e){return e.name===t.body.orderToAdd.name&&e.nameSecond===t.body.orderToAdd.nameSecond})):o.subConteo.order.find((function(e){return e.name===t.body.orderToAdd.name}))),!o.deleted){e.next=19;break}return e.next=15,r.abortTransaction();case 15:return r.endSession(),e.abrupt("return",n.status(410).json({errorMSG:"El item ha sido elminado"}));case 19:if(o.priceIGV===t.body.priceIGV){e.next=26;break}return e.next=22,r.abortTransaction();case 22:return r.endSession(),e.abrupt("return",n.status(409).json({errorMSG:"El precio del producto ha cambiado"}));case 26:if(!(o.cantidad<t.body.cantidad)){e.next=33;break}return e.next=29,r.abortTransaction();case 29:return r.endSession(),e.abrupt("return",n.status(409).json({errorMSG:"Ya no contamos con la cantidad deseada"}));case 33:if(!o.subConteo){e.next=39;break}if(!(i.cantidad<t.body.cantidad)){e.next=39;break}return e.next=37,r.abortTransaction();case 37:return r.endSession(),e.abrupt("return",n.status(409).json({errorMSG:"Ya no contamos con la cantidad deseada"}));case 39:if("not"!==a.carrito){e.next=54;break}return(s=new Ye({totalPrice:t.body.cantidad*o.priceIGV,totalPriceNoIGV:t.body.cantidad*o.priceNoIGV,estado:"pendiente",vendedor:t.user.aud.split(" ")[0],tipoVendedor:"low",medio_de_pago:"efectivo",cliente_email:a.email,itemsVendidos:[],carrito_venta:!0})).itemsVendidos.push({codigo:o.codigo,tipo:"producto",descripcion:o.description,name:o.name,priceIGV:o.priceIGV,priceNoIGV:o.priceNoIGV,priceCosto:o.costoPropio,cantidad:t.body.cantidad,cantidadSC:[],totalPrice:t.body.cantidad*o.priceIGV,totalPriceNoIGV:t.body.cantidad*o.priceNoIGV,unidadDeMedida:o.unidadDeMedida,photo:o.photo}),o.subConteo&&(""!==o.subConteo.nameSecond?s.itemsVendidos[0].cantidadSC.push({name:i.name,nameSecond:i.nameSecond,cantidadDisponible:i.cantidad,cantidadVenta:t.body.cantidad}):s.itemsVendidos[0].cantidadSC.push({name:i.name,nameSecond:void 0,cantidadDisponible:i.cantidad,cantidadVenta:t.body.cantidad})),e.next=45,et();case 45:return c=e.sent,s.codigo=c,e.next=49,s.save();case 49:return t.ventaGenerada=e.sent,e.next=52,Qe.findOneAndUpdate({username:t.user.aud.split(" ")[0]},{carrito:t.ventaGenerada.codigo},{useFindAndModify:!1,new:!0});case 52:e.next=100;break;case 54:return e.next=56,Ye.findOne({codigo:a.carrito});case 56:if(d=e.sent,-1!==(u=d.itemsVendidos.findIndex((function(e){return e.codigo===o.codigo})))){e.next=66;break}return p={codigo:o.codigo,tipo:"producto",descripcion:o.description,name:o.name,priceIGV:o.priceIGV,priceNoIGV:o.priceNoIGV,priceCosto:o.costoPropio,cantidad:t.body.cantidad,cantidadSC:[],totalPrice:t.body.cantidad*o.priceIGV,totalPriceNoIGV:t.body.cantidad*o.priceNoIGV,unidadDeMedida:o.unidadDeMedida,photo:o.photo},o.subConteo&&(""!==o.subConteo.nameSecond?p.cantidadSC.push({name:i.name,nameSecond:i.nameSecond,cantidadDisponible:i.cantidad,cantidadVenta:t.body.cantidad}):p.cantidadSC.push({name:i.name,nameSecond:void 0,cantidadDisponible:i.cantidad,cantidadVenta:t.body.cantidad})),e.next=63,Ye.findOneAndUpdate({codigo:a.carrito},{$push:{itemsVendidos:p},$inc:{totalPrice:p.totalPrice,totalPriceNoIGV:p.totalPriceNoIGV}},{useFindAndModify:!1,new:!0});case 63:t.ventaGenerada=e.sent,e.next=100;break;case 66:if(!(u>-1)){e.next=100;break}if(!o.subConteo){e.next=93;break}if(l=-1,-1!==(l=""===o.subConteo.nameSecond?d.itemsVendidos[u].cantidadSC.findIndex((function(e){return e.name===i.name})):d.itemsVendidos[u].cantidadSC.findIndex((function(e){return e.name===i.name&&e.nameSecond===i.nameSecond})))){e.next=81;break}return m=d.itemsVendidos[u].cantidad+t.body.cantidad,g=o.priceIGV*m,f=o.priceNoIGV*m,y=d.totalPrice-d.itemsVendidos[u].totalPrice+g,b=d.totalPriceNoIGV-d.itemsVendidos[u].totalPriceNoIGV+f,e.next=78,Ye.findOneAndUpdate({codigo:a.carrito,"itemsVendidos.codigo":o.codigo},{totalPrice:y,totalPriceNoIGV:b,$set:{"itemsVendidos.$.priceIGV":o.priceIGV,"itemsVendidos.$.priceNoIGV":o.priceNoIGV,"itemsVendidos.$.priceCosto":o.costoPropio,"itemsVendidos.$.cantidad":m,"itemsVendidos.$.totalPriceNoIGV":f,"itemsVendidos.$.totalPrice":g},$push:{"itemsVendidos.$.cantidadSC":{name:i.name,nameSecond:i.nameSecond||void 0,cantidadDisponible:i.cantidad,cantidadVenta:t.body.cantidad}}},{useFindAndModify:!1,new:!0});case 78:t.ventaGenerada=e.sent,e.next=91;break;case 81:return h=d.itemsVendidos[u].cantidad-d.itemsVendidos[u].cantidadSC[l].cantidadVenta+t.body.cantidad,v=o.priceIGV*h,$=o.priceNoIGV*h,x=d.totalPrice-d.itemsVendidos[u].totalPrice+v,w=d.totalPriceNoIGV-d.itemsVendidos[u].totalPriceNoIGV+$,d.itemsVendidos[u].cantidadSC[l].cantidadDisponible=i.cantidad,d.itemsVendidos[u].cantidadSC[l].cantidadVenta=t.body.cantidad,e.next=90,Ye.findOneAndUpdate({codigo:a.carrito,"itemsVendidos.codigo":o.codigo},{totalPrice:x,totalPriceNoIGV:w,$set:{"itemsVendidos.$.priceIGV":o.priceIGV,"itemsVendidos.$.priceNoIGV":o.priceNoIGV,"itemsVendidos.$.priceCosto":o.costoPropio,"itemsVendidos.$.cantidad":h,"itemsVendidos.$.totalPriceNoIGV":$,"itemsVendidos.$.totalPrice":v,"itemsVendidos.$.cantidadSC":d.itemsVendidos[u].cantidadSC}},{useFindAndModify:!1,new:!0});case 90:t.ventaGenerada=e.sent;case 91:e.next=100;break;case 93:return S=t.body.cantidad*o.priceIGV,C=t.body.cantidad*o.priceNoIGV,V=d.totalPrice-d.itemsVendidos[u].totalPrice+S,k=d.totalPriceNoIGV-d.itemsVendidos[u].totalPriceNoIGV+C,e.next=99,Ye.findOneAndUpdate({codigo:a.carrito,"itemsVendidos.codigo":o.codigo},{totalPrice:V,totalPriceNoIGV:k,$set:{"itemsVendidos.$.priceIGV":o.priceIGV,"itemsVendidos.$.priceNoIGV":o.priceNoIGV,"itemsVendidos.$.priceCosto":o.costoPropio,"itemsVendidos.$.cantidad":t.body.cantidad,"itemsVendidos.$.totalPriceNoIGV":C,"itemsVendidos.$.totalPrice":S}},{useFindAndModify:!1,new:!0});case 99:t.ventaGenerada=e.sent;case 100:return e.next=102,r.commitTransaction();case 102:return r.endSession(),e.abrupt("return",n.json(t.ventaGenerada));case 106:return e.prev=106,e.t0=e.catch(4),e.next=110,r.abortTransaction();case 110:return r.endSession(),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 112:case"end":return e.stop()}}),e,null,[[4,106]])})));return function(t,n){return e.apply(this,arguments)}}(),et=function(){var e=A()(_().mark((function e(){var t,n,r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Ye.countDocuments({});case 3:for(e.t0=e.sent,t=e.t0+1,n="SD01-000000",r=0;r<t.toString().length;r++)n=n.slice(0,-1);return a=n+t.toString(),e.abrupt("return",a);case 11:return e.prev=11,e.t1=e.catch(0),e.abrupt("return",res.status(500).json({errorMSG:e.t1}));case 14:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(){return e.apply(this,arguments)}}(),tt=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s,c,d,u,p,l,m,g,f,y;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W().startSession();case 2:return(r=e.sent).startTransaction(),e.prev=4,e.next=7,Ye.aggregate([{$match:{codigo:t.carrito_codigo}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$unwind:{path:"$cantidadSC",preserveNullAndEmptyArrays:!0}},{$sort:{codigo:-1}}]);case 7:for(a=e.sent,o=[{cod:0,mensaje:"Item Eliminado"},{cod:1,mensaje:"Cambio de precio"}],i=[],s=[],c="",d=0;d<a.length;d++)a[d].codigo!==c&&s.push(a[d].codigo),c=a[d].codigo;return e.next=15,He.aggregate([{$match:{codigo:{$in:s}}},{$sort:{codigo:-1}}]);case 15:u=e.sent,p=[],l=0,m="",g="",f=_().mark((function e(n){var r,s,c,d;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!u[l].deleted){e.next=8;break}if(m===u[l].codigo){e.next=6;break}return m=u[l].codigo,i.push(Je(Je({},o[0]),{},{item_cod:u[l].codigo,item_name:u[l].name})),e.next=6,Ye.findOneAndUpdate({codigo:t.carrito_codigo},{$inc:{totalPrice:-a[n].cantidad*a[n].priceIGV,totalPriceNoIGV:-a[n].cantidad*a[n].priceNoIGV},$pull:{itemsVendidos:{codigo:m}}},{useFindAndModify:!1,new:!0});case 6:e.next=20;break;case 8:if(u[l].priceIGV===a[n].priceIGV||g===u[l].codigo){e.next=15;break}return g=u[l].codigo,i.push(Je(Je({},o[1]),{},{item_cod:u[l].codigo,item_name:u[l].name})),r=u[l].priceIGV*a[n].cantidad,s=u[l].priceNoIGV*a[n].cantidad,e.next=15,Ye.findOneAndUpdate({codigo:t.carrito_codigo,"itemsVendidos.codigo":u[l].codigo},{$inc:{totalPrice:r-a[n].totalPrice,totalPriceNoIGV:s-a[n].totalPriceNoIGV},$set:{"itemsVendidos.$.totalPrice":r,"itemsVendidos.$.totalPriceNoIGV":s,"itemsVendidos.$.priceIGV":u[l].priceIGV,"itemsVendidos.$.priceNoIGV":u[l].priceNoIGV}},{useFindAndModify:!1,new:!0});case 15:a[n].priceIGV=u[l].priceIGV,a[n].priceNoIGV=u[l].priceNoIGV,a[n].totalPrice=u[l].priceIGV*a[n].cantidad,a[n].totalPriceNoIGV=u[l].priceNoIGV*a[n].cantidad,u[l].subConteo?(c=a[n],d=u[l].subConteo.order.find((function(e){return e.name===c.cantidadSC.name&&e.nameSecond===a[n].cantidadSC.nameSecond})),p.push(Je(Je({},a[n]),{},{cantidadDisponible:d.cantidad,codVent:t.carrito_codigo}))):p.push(Je(Je({},a[n]),{},{cantidadDisponible:u[l].cantidad,codVent:t.carrito_codigo}));case 20:a[n].codigo!==(a[n+1]?a[n+1].codigo:"xxxxx")&&l++;case 21:case"end":return e.stop()}}),e)})),y=0;case 22:if(!(y<a.length)){e.next=27;break}return e.delegateYield(f(y),"t0",24);case 24:y++,e.next=22;break;case 27:return e.next=29,r.commitTransaction();case 29:r.endSession(),n.json({carrito:p,cod_carrito:t.carrito_codigo,estado_carrito:t.estadoCarrito,alerts:i}),e.next=39;break;case 33:return e.prev=33,e.t1=e.catch(4),e.next=37,r.abortTransaction();case 37:return r.endSession(),e.abrupt("return",n.status(500).json({errorMSG:e.t1}));case 39:case"end":return e.stop()}}),e,null,[[4,33]])})));return function(t,n){return e.apply(this,arguments)}}(),nt=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!((a=t.carritoActual[0]).cantidadSC&&a.cantidad-a.cantidadSC.cantidadVenta>0)){e.next=8;break}return e.next=5,Ye.findOneAndUpdate({codigo:t.body.codVent,"itemsVendidos.codigo":t.body.codigo},{$inc:{totalPrice:-a.cantidadSC.cantidadVenta*a.priceIGV,totalPriceNoIGV:-a.cantidadSC.cantidadVenta*a.priceNoIGV,"itemsVendidos.$.cantidad":-a.cantidadSC.cantidadVenta,"itemsVendidos.$.totalPrice":-a.cantidadSC.cantidadVenta*a.priceIGV,"itemsVendidos.$.totalPriceNoIGV":-a.cantidadSC.cantidadVenta*a.priceNoIGV},$pull:{"itemsVendidos.$.cantidadSC":{name:a.cantidadSC.name,nameSecond:a.cantidadSC.nameSecond}}},{useFindAndModify:!1,new:!0});case 5:r=e.sent,e.next=11;break;case 8:return e.next=10,Ye.findOneAndUpdate({codigo:t.body.codVent},{$inc:{totalPrice:-a.cantidad*a.priceIGV,totalPriceNoIGV:-a.cantidad*a.priceNoIGV},$pull:{itemsVendidos:{codigo:a.codigo}}},{useFindAndModify:!1,new:!0});case 10:r=e.sent;case 11:t.newCarrito=r,n.json(r),e.next=18;break;case 15:return e.prev=15,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 18:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(t,n){return e.apply(this,arguments)}}(),rt=function(){var e=A()(_().mark((function e(t,n,r){var a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Qe.findOne({username:t.user.aud.split(" ")[0]});case 3:a=e.sent,t.carrito_codigo=a.carrito,r(),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n,r){return e.apply(this,arguments)}}(),at=function(){var e=A()(_().mark((function e(t,n,r){var a,o;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Ye.findOne({codigo:t.body.codVent});case 3:if(a=e.sent,t.estadoCarrito=a.estado_carrito_comprando,!t.body.cantidadSC){e.next=11;break}return e.next=8,Ye.aggregate([{$match:{codigo:t.body.codVent}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$unwind:{path:"$cantidadSC",preserveNullAndEmptyArrays:!0}},{$match:{codigo:t.body.codigo}},{$match:{"cantidadSC.name":t.body.cantidadSC.name}},{$match:{"cantidadSC.nameSecond":t.body.cantidadSC.nameSecond}},{$sort:{codigo:-1}}]);case 8:o=e.sent,e.next=14;break;case 11:return e.next=13,Ye.aggregate([{$match:{codigo:t.body.codVent}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$unwind:{path:"$cantidadSC",preserveNullAndEmptyArrays:!0}},{$match:{codigo:t.body.codigo}}]);case 13:o=e.sent;case 14:if(0!==o.length){e.next=16;break}return e.abrupt("return",n.status(409).json());case 16:t.carritoActual=o,r(),e.next=23;break;case 20:return e.prev=20,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 23:case"end":return e.stop()}}),e,null,[[0,20]])})));return function(t,n,r){return e.apply(this,arguments)}}(),ot=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Qe.findOne({username:t.user.aud.split(" ")[0]});case 3:return r=e.sent,t.carrito_codigo=r.carrito,a=[],t.body.carrito.forEach((function(e){a.push(e.codigo)})),e.next=9,He.aggregate([{$match:{codigo:{$in:a}}},{$sort:{codigo:-1}}]);case 9:o=e.sent,i=it([],o,t.body.carrito),n.json(i),e.next=17;break;case 14:return e.prev=14,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 17:case"end":return e.stop()}}),e,null,[[0,14]])})));return function(t,n){return e.apply(this,arguments)}}(),it=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(n[o].deleted&&t.push(Je(Je({},Ze[0]),{},{item_cod:n[o].codigo,item_name:n[o].name})),n[o].priceIGV!==r[a].priceIGV&&t.push(Je(Je({},Ze[1]),{},{item_cod:n[o].codigo,item_name:n[o].name})),r[a].cantidadSC){var i=n[o].subConteo.order.find((function(e){return e.name===r[a].cantidadSC.name&&e.nameSecond===r[a].cantidadSC.nameSecond}));i.cantidad-r[a].cantidadSC.cantidad<0&&t.push(Je(Je({},Ze[2]),{},{item_cod:n[o].codigo,item_name:n[o].name+" | "+i.carrito[a].cantidadSC.name+" "+i.carrito[a].cantidadSC.nameSecond}))}else n[o].cantidad-r[a].cantidad<0&&t.push(Je(Je({},Ze[2]),{},{item_cod:n[o].codigo,item_name:n[o].name}));return r[a].codigo!==(r[a+1]?r[a+1].codigo:"xxxxx")&&o++,a+1===r.length?t:(a++,e(t,n,r,a,o))},st=new $.Router;st.post("/agregarItem",me,Xe),st.post("/removeProductoDeCarrito",me,at,nt),st.post("/iniciarCompra",me,ot),st.get("/getCarrito",me,rt,tt);const ct=st,dt=require("@aws-sdk/client-s3"),ut=require("excel4node");var pt=n.n(ut);function lt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var mt=function(){var e=A()(_().mark((function e(t,n,r,a,o,i,s){var c,d,u,p,l,m,g,f,y=arguments;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(c=y.length>7&&void 0!==y[7]?y[7]:[],e.prev=1,d=new(pt().Workbook),u=d.addWorksheet(t,{sheetFormat:{defaultRowHeight:20,defaultColWidth:20},pageSetup:{orientation:"portrait"}}),p=d.createStyle({font:{color:"black",size:12,bold:!0},border:{right:{style:"thin",color:"#15181C"},left:{style:"thin",color:"#15181C"},bottom:{style:"thin",color:"#15181C"},top:{style:"thin",color:"#15181C"}},alignment:{vertical:"center",wrapText:!0},numberFormat:"[$S/-es-PE]#,##0.00"}),l=d.createStyle({font:{color:"black",size:12,bold:!0},border:{right:{style:"thin",color:"#15181C"},left:{style:"thin",color:"#15181C"},bottom:{style:"thin",color:"#15181C"}},alignment:{vertical:"center",wrapText:!0},numberFormat:"[$S/-es-PE]#,##0.00",fill:{type:"pattern",patternType:"solid",fgColor:"#e2f3ff"}}),u.column(1).setWidth(5),u.column(2).setWidth(15),u.column(3).setWidth(15),u.column(4).setWidth(15),u.column(5).setWidth(60),u.column(6).setWidth(15),u.column(7).setWidth(15),u.column(8).setWidth(15),15,m=yt(u,a.itemsVendidos,15,p,l,15,s),ft(d,u,r,14),gt(d,u,n,a,i.observaciones),u.cell(m,7).string("Sub Total").style(p).style({font:{size:14,bold:!0,color:"white"},fill:{type:"pattern",patternType:"solid",fgColor:"#e87200"}}),u.cell(m,8).formula("SUBTOTAL(9,H5:H".concat(m-1,")")).style(p).style({font:{size:14,bold:!0,color:"black"},fill:{type:"pattern",patternType:"solid",fgColor:"white"}}),u.cell(m+1,7).string("IGV").style(p),u.cell(m+1,8).formula("H".concat(m," * ",.18)).style(p),u.cell(m+2,7).string("Envio").style(p).style({font:{size:14,bold:!0,color:"black"},fill:{type:"pattern",patternType:"solid",fgColor:"white"}}),u.cell(m+2,8).number(i.envio||0).style(p).style({font:{size:12,bold:!1,color:"black"},fill:{type:"pattern",patternType:"solid",fgColor:"white"}}),u.cell(m+3,7).string("Otro").style(p).style({font:{size:14,bold:!0,color:"black"},fill:{type:"pattern",patternType:"solid",fgColor:"white"}}),u.cell(m+3,8).number(i.otro||0).style(p).style({font:{size:12,bold:!1,color:"black"},fill:{type:"pattern",patternType:"solid",fgColor:"white"}}),u.cell(m+4,7).string("Total").style(p).style({font:{size:14,bold:!0,color:"white"},fill:{type:"pattern",patternType:"solid",fgColor:"#005087"}}),u.cell(m+4,8).formula("H".concat(m," + H").concat(m+1," + H").concat(m+2," + H").concat(m+3)).style(p).style({font:{size:14,bold:!0,color:"black"},fill:{type:"pattern",patternType:"solid",fgColor:"white"}}),u.cell(m+1,1,m+1,5,!0).style(p).string("BCP - SOLES: 570-2650880-0-39").style({font:{size:12,bold:!0,color:"black"},fill:{type:"pattern",patternType:"solid",fgColor:"#e2f3ff"}}),u.cell(m+2,1,m+2,5,!0).style(p).string("C.C.I. - SOLES: 002-57000265088003903").style({font:{size:12,bold:!0,color:"black"},fill:{type:"pattern",patternType:"solid",fgColor:"#e2f3ff"}}),i.porPagar&&u.cell(m+3,1,m+3,5,!0).style(p).string("SALDO A CANCELAR S/"+(i.porPagar.toString()||"")).style({font:{size:12,bold:!0,color:"black"},fill:{type:"pattern",patternType:"solid",fgColor:"#f1a054"}}),u.row(m).setHeight(20),u.row(m+1).setHeight(20),u.row(m+2).setHeight(20),u.row(m+3).setHeight(20),u.row(m+4).setHeight(20),g=1;g<14;g++)u.row(g).setHeight(20);return u.setPrintArea(1,1,m+4,8),u.addImage({image:o,type:"picture",position:{type:"absoluteAnchor",x:"1.5mm",y:"1.5mm"}}),s&&c.forEach((function(e,t){u.addImage({image:e.Body,type:"picture",position:{type:"twoCellAnchor",from:{col:2,colOff:"1mm",row:15+t,rowOff:"1mm"},to:{col:2,colOff:"35mm",row:15+t,rowOff:"35mm"}}})})),e.next=42,d.writeToBuffer();case 42:return f=e.sent,e.abrupt("return",f);case 46:throw e.prev=46,e.t0=e.catch(1),new Error(e.t0);case 49:case"end":return e.stop()}}),e,null,[[1,46]])})));return function(t,n,r,a,o,i,s){return e.apply(this,arguments)}}(),gt=function(e,t,n,r,a){var o=e.createStyle({font:{color:"white",size:16,bold:!0},alignment:{horizontal:"center",vertical:"center"},fill:{type:"pattern",patternType:"solid",fgColor:"#005087"}});t.cell(4,5,4,8,!0).string(r.codigo).style(o).style({font:{color:"black",size:12,bold:!1},fill:{fgColor:"white"}});var i=new Date(r.date);t.cell(5,5,5,8,!0).date(i.toLocaleDateString()).style(o).style({font:{color:"black",size:14,bold:!1},fill:{fgColor:"white"}}).style({numberFormat:"dd-mm-yyy"}),t.cell(6,5,6,8,!0).string("Sirio Dinar - RUC: 20605746587").style(o).style({font:{color:"#005087",size:12,bold:!0},fill:{fgColor:"white"}}),t.cell(7,5,7,8,!0).link("https://inventario.siriodinar.com").style(o).style({font:{color:"#e87200",size:12,bold:!0},fill:{fgColor:"white"}}),t.cell(9,5,9,8,!0).string("Observaciones:").style(o).style({font:{color:"white",size:12,bold:!0},alignment:{horizontal:"left"},fill:{fgColor:"#005087"},border:{right:{style:"thin",color:"#15181C"},left:{style:"thin",color:"#15181C"},bottom:{style:"thin",color:"#15181C"},top:{style:"thin",color:"#15181C"}}}),t.cell(10,5,13,8,!0).string(a||"").style(o).style({font:{color:"black",size:12,bold:!1},fill:{fgColor:"white"},alignment:{horizontal:"left",vertical:"center"},border:{right:{style:"thin",color:"#15181C"},left:{style:"thin",color:"#15181C"},bottom:{style:"thin",color:"#15181C"},top:{style:"thin",color:"#15181C"}}}),t.cell(10,1,10,4,!0).string("Enviar a:").style(o).style({font:{color:"white",size:12,bold:!0},alignment:{horizontal:"left"},fill:{fgColor:"#005087"},border:{right:{style:"thin",color:"#15181C"},left:{style:"thin",color:"#15181C"},bottom:{style:"thin",color:"#15181C"},top:{style:"thin",color:"#15181C"}}}),t.cell(11,1,13,4,!0).string("".concat(r.documento.name," | ").concat(r.documento.codigo," ").concat(r.cliente_email?"\nemail: "+r.cliente_email:""," ").concat(r.celular_cliente?"\nCelular: "+r.celular_cliente:"")).style(o).style({font:{color:"black",size:12,bold:!1},fill:{fgColor:"white"},alignment:{horizontal:"left",vertical:"center",wrapText:!0},border:{right:{style:"thin",color:"#15181C"},left:{style:"thin",color:"#15181C"},bottom:{style:"thin",color:"#15181C"},top:{style:"thin",color:"#15181C"}}}),t.cell(7,1,7,4,!0).string("Jr. Pardo y Aliaga Nro. 207. Trujillo - Perú").style(o).style({font:{color:"black",size:12,bold:!0},fill:{fgColor:"white"},alignment:{horizontal:"left"}}),t.cell(8,1,8,4,!0).string("+51 977 426 349 | +51 922 412 404").style(o).style({font:{color:"black",size:12,bold:!0},fill:{fgColor:"white"},alignment:{horizontal:"left"}})},ft=function(e,t,n,r){var a,o=e.createStyle({font:{color:"white",size:12,bold:!0},border:{right:{style:"thin",color:"#15181C"},left:{style:"thin",color:"#15181C"},bottom:{style:"thin",color:"#15181C"}},alignment:{horizontal:"center",vertical:"center",wrapText:!0},fill:{type:"pattern",patternType:"solid",fgColor:"#e87200"}}),i=1,s=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return lt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?lt(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}(n);try{for(s.s();!(a=s.n()).done;){var c=a.value;t.cell(r,i).string(c).style(o),i++}}catch(e){s.e(e)}finally{s.f()}t.row(r).filter({firstColumn:1,lastColumn:n.length}),t.row(r).setHeight(40)},yt=function e(t,n,r,a,o,i,s){var c,d=r-i;if(d>=n.length)return i;s?t.row(r).setHeight(85):t.row(r).setHeight(35),c=r%2==0?o:a,t.cell(r,1).number(d+1).style(c).style({numberFormat:"0"}).style({alignment:{horizontal:"center"}}),t.cell(r,2).string("").style(c).style({alignment:{wrapText:!0}}),t.cell(r,3).string(n[d].unidadDeMedida||"UND").style(c).style({alignment:{wrapText:!0,horizontal:"center"}}),t.cell(r,4).string(n[d].name).style(c).style({alignment:{horizontal:"center",wrapText:!0}});var u=n[d].descripcion||"";if(n[d].cantidadSC&&n[d].cantidadSC.length>0){u+=". Detalle:";for(var p=0;p<n[d].cantidadSC.length;p++)n[d].cantidadSC[p].cantidadVenta>0&&(u=u+" ".concat(n[d].cantidadSC[p].name," ").concat(n[d].cantidadSC[p].nameSecond?"- ".concat(n[d].cantidadSC[p].nameSecond,": "):": ")+n[d].cantidadSC[p].cantidadVenta+"".concat(n[d].cantidadSC.length+1<p?",":"."))}return t.cell(r,5).string(u).style(c).style({alignment:{wrapText:!0}}),t.cell(r,6).number(n[d].cantidad).style(c).style({numberFormat:"0"}).style({alignment:{horizontal:"center"}}),t.cell(r,7).number(n[d].priceNoIGV).style(c),t.cell(r,8).formula("F".concat(r," * G").concat(r)).style(c),1+e(t,n,r+1,a,o,i,s)};const bt=require("@babel/runtime/helpers/toConsumableArray");var ht=n.n(bt);const vt=require("luxon"),$t=require("pdfmake");function xt(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return wt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?wt(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function wt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var St=new(n.n($t)())({Courier:{normal:"Courier",bold:"Courier-Bold",italics:"Courier-Oblique",bolditalics:"Courier-BoldOblique"},Helvetica:{normal:"Helvetica",bold:"Helvetica-Bold",italics:"Helvetica-Oblique",bolditalics:"Helvetica-BoldOblique"},Times:{normal:"Times-Roman",bold:"Times-Bold",italics:"Times-Italic",bolditalics:"Times-BoldItalic"},Symbol:{normal:"Symbol"},ZapfDingbats:{normal:"ZapfDingbats"}}),Ct={pageMargins:[40,40,40,50],content:[{style:"tableEnviar",table:{widths:["*","*"],body:[[{image:"",width:100,border:[!1,!1,!1,!1],style:"headerTitle"},{text:[{text:"",fontSize:18,bold:!0},{text:"\nSirio Dinar - RUC: 20605746587",color:"darkblue",fontSize:12},{text:"\ninventario.siriodinar.com",color:"orange",fontSize:12}],rowSpan:2,alignment:"center",style:"headerTitlePrinc",border:[!0,!0,!0,!1]}],[{text:"Jr. Pardo y Aliaga Nro. 207. Trujillo - Perú \n +51 977 426 349 | +51 922 412 404",width:100,height:100,border:[!1,!1,!1,!1],style:"headerTitle"}]]}},{style:"tableEnviar",table:{heights:[15,60],widths:[165,331],body:[[{text:"Enviar a:",fillColor:"#005087",bold:!0,color:"#EAF6FF",style:"tableMargin"},{text:"Observaciones:",fillColor:"#005087",bold:!0,color:"#EAF6FF",style:"tableMargin"}],[{text:"",border:[!0,!0,!0,!1],style:"tableMargin"},{text:"RR",border:[!0,!0,!0,!1],style:"tableMargin"}]]}},{style:"tableHeader",table:{heights:[15],widths:[15,97,35,70,120,35,35,35],body:[[{text:"Nº",style:"tableMarginSH"},{text:"IMAGÉN",style:"tableMarginSH"},{text:"UDM",style:"tableMarginSH"},{text:"NOMBRE",style:"tableMarginSH"},{text:"DESCRIPCIÓN",style:"tableMarginSH"},{text:"CANT.",style:"tableMarginSH"},{text:"P/CU",style:"tableMarginSH"},{text:"TOTAL",style:"tableMarginSH"}]]}},{layout:{paddingTop:function(e,t){return Vt(t,e,"center"),0}},style:{fontSize:10,bold:!1,alignment:"center"},table:{dontBreakRows:!0,heights:40,widths:[15,97,35,70,120,35,35,35],body:[]}},{style:"totales",table:{dontBreakRows:!0,heights:15,widths:[79,79],body:[[{text:"Sub Total:",border:[!0,!1,!1,!0],fillColor:"#E87100",color:"white",style:"totalesMargin"},{text:"S/ 111.00",border:[!0,!1,!0,!0],alignment:"right",style:"totalesMargin"}],[{text:"IGV:",color:"grey",style:"totalesMargin"},{text:"S/ 111.00",alignment:"right",color:"grey",style:"totalesMargin"}],[{text:"Envio:",color:"grey",style:"totalesMargin"},{text:"S/ 111.00",alignment:"right",color:"grey",style:"totalesMargin"}],[{text:"Otro:",color:"grey",style:"totalesMargin"},{text:"S/ 111.00",alignment:"right",color:"grey",style:"totalesMargin"}],[{text:"Total:",fillColor:"#005087",color:"white",style:"totalesMargin"},{text:"S/ 111.00",alignment:"right",style:"totalesMargin"}]]}}],styles:{totalesMargin:{margin:[0,5,0,0]},tableMarginSH:{margin:[0,5,0,0],fillColor:"#E87100",color:"#EAF6FF"},tableMargin:{fontSize:10,margin:[2,5,2,2]},headerTitlePrinc:{margin:[0,40,0,0],fontSize:14},headerTitle:{margin:[0,0,0,5]},header:{fontSize:18,bold:!0,margin:[10,10,10,10]},subheader:{fontSize:16,bold:!0,margin:[0,10,10,10]},tableEnviar:{margin:[0,0,0,0]},tableHeader:{bold:!0,fontSize:10,alignment:"center"},totales:{margin:[338,0,0,0]},marginSN:{margin:[2,12,2,6]}},defaultStyle:{font:"Helvetica",lineHeight:1.2}},Vt=function(e,t,n){var r=e.table.body[t].map((function(t,n){var r=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=function(e){if(void 0===e)return{height:0,width:0};var r,a=0,o=xt(e);try{for(o.s();!(r=o.n()).done;){var i=r.value;(n+=i.width)>t?(a+=i.height,n=i.width):a=Math.max(i.height,a)}}catch(e){o.e(e)}finally{o.f()}return{height:a,width:n}};if(e._offsets&&(n+=e._offsets.total),e._inlines&&e._inlines.length)return r(e._inlines);if(e.stack&&e.stack[0])return e.stack.map((function(e){return r(e._inlines)})).reduce((function(e,t){return{height:e.height+t.height,width:Math.max(e.width+t.width)}}));if(e.table){var a,o=0,i=xt(e.table.body);try{for(i.s();!(a=i.n()).done;){var s=a.value.map((function(e){var r=undefined.findInlineHeight(e,t,n);return n=r.width,r.height}));o=Math.max.apply(Math,ht()(s).concat([o]))}}catch(e){i.e(e)}finally{i.f()}return{height:o,width:n}}return e._height?(n+=e._width,{height:e._height,width:n}):{height:null,width:n}}(t,e.table.widths[n]._calcWidth);return r.height})),a=Math.max.apply(Math,ht()(r));e.table.body[t].forEach((function(e,t){var o;r[t]&&a>r[t]&&("bottom"===n?o=a-r[t]:"center"===n&&(o=(a-r[t])/2),e._margin?e._margin[1]=o:e._margin=[0,o,0,0])}))},kt=function(e,t,n,r,a){Tt(e,t,n),a?(Ct.content[2].table={heights:[15],widths:[15,97,35,70,120,35,35,35],body:[[{text:"Nº",style:"tableMarginSH"},{text:"IMAGÉN",style:"tableMarginSH"},{text:"UDM",style:"tableMarginSH"},{text:"NOMBRE",style:"tableMarginSH"},{text:"DESCRIPCIÓN",style:"tableMarginSH"},{text:"CANT.",style:"tableMarginSH"},{text:"P/CU",style:"tableMarginSH"},{text:"TOTAL",style:"tableMarginSH"}]]},Ct.content[3].table={dontBreakRows:!0,heights:40,widths:[15,97,35,70,120,35,35,35],body:[]}):(Ct.content[2].table={heights:[15],widths:[20,35,83,193,40,40,40],body:[[{text:"Nº",style:"tableMarginSH"},{text:"UDM",style:"tableMarginSH"},{text:"NOMBRE",style:"tableMarginSH"},{text:"DESCRIPCIÓN",style:"tableMarginSH"},{text:"CANT.",style:"tableMarginSH"},{text:"P/CU",style:"tableMarginSH"},{text:"TOTAL",style:"tableMarginSH"}]]},Ct.content[3].table={heights:50,dontBreakRows:!0,widths:[20,35,83,193,40,40,40],body:[]}),jt(t,r,a);var o=0;n.envio&&(o=n.envio);var i=0;return n.otro&&(i=n.otroR),Ct.content[4].table.body[0][1].text="S/ "+t.totalPriceNoIGV.toFixed(2),Ct.content[4].table.body[1][1].text="S/ "+(Math.round(100*(t.totalPrice-t.totalPriceNoIGV))/100).toFixed(2),Ct.content[4].table.body[2][1].text="S/ "+o.toFixed(2),Ct.content[4].table.body[3][1].text="S/ "+i.toFixed(2),Ct.content[4].table.body[4][1].text="S/ "+((n.otro||0)+(n.envio||0)+t.totalPrice).toFixed(2),St.createPdfKitDocument(Ct)},Tt=function(e,t,n){var r=vt.DateTime.fromJSDate(t.date).toFormat("c LL yyyy").toLocaleString();Ct.content[0].table.body[0][0].image=e,Ct.content[0].table.body[0][1].text[0].text="".concat(t.codigo,"\n").concat(r.split(" ").join("/")),Ct.content[1].table.body[1][1].text=n.observaciones,Ct.content[1].table.body[1][0].text="".concat(t.documento.name," | ").concat(t.documento.codigo).concat(t.cliente_email?"\nemail: ".concat(t.cliente_email):"").concat("+51"===t.celular_cliente?"":"\nCelular:".concat(t.celular_cliente))},jt=function(e,t,n){var r=[];e.itemsVendidos.forEach((function(e,a){var o=e.descripcion||"";if(e.cantidadSC&&e.cantidadSC.length>0){o+=". Detalle:";for(var i=0;i<e.cantidadSC.length;i++)e.cantidadSC[i].cantidadVenta>0&&(o=o+" ".concat(e.cantidadSC[i].name," ").concat(e.cantidadSC[i].nameSecond?"- ".concat(e.cantidadSC[i].nameSecond,": "):": ")+e.cantidadSC[i].cantidadVenta+"".concat(e.cantidadSC.length+1<i?",":"."))}n?r.push([{text:a+1,style:"tableMarginN"},{image:t[a].Body,width:95,height:95},{text:e.unidadDeMedida,style:"tableMarginN"},{text:e.name,style:"tableMarginN"},{text:o,alignment:"justify"},{text:e.cantidad.toString(),style:"tableMarginN"},{text:"S/"+e.priceNoIGV.toString(),style:"tableMarginN"},{text:"S/"+e.totalPriceNoIGV.toString(),style:"tableMarginN"}]):r.push([{text:a+1,style:"marginSN"},{text:e.unidadDeMedida,style:"marginSN"},{text:e.name,style:"marginSN"},{text:o,alignment:"justify",style:"marginSN"},{text:e.cantidad.toString(),style:"marginSN"},{text:"S/"+e.priceNoIGV.toString(),style:"marginSN"},{text:"S/"+e.totalPriceNoIGV.toString(),style:"marginSN"}]),Ct.content[3].table.body=r}))};const Nt=new z.Schema({codigo:{type:String,required:!0,trim:!0,unique:!0},totalPrice:{type:Number,trim:!0,required:!0},totalPriceNoIGV:{type:Number,trim:!0,required:!0},estado:{type:String,trim:!0,required:!0},documento:{type:De},itemsVendidos:{type:[Ee],required:!0},date:{type:Date,default:Date.now},vendedor:{type:String},tipoVendedor:{type:String,default:"admin"},cliente_email:{type:String,trim:!0},celular_cliente:{type:String,trim:!0}});function Ot(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return At(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?At(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function At(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var It=W().model("Cotizacion",Nt),_t=new dt.S3Client({credentials:{accessKeyId:m.production.awsID,secretAccessKey:m.production.awsKey},region:"us-east-1"}),Pt=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t.body.venta._id=void 0,t.body.venta.codigo=void 0,r=new It(t.body.venta),e.next=6,Dt();case 6:return r.codigo=e.sent,r.celular_cliente=qt(t.body.venta.celular_cliente),e.next=10,r.save();case 10:a=e.sent,n.json({message:"Cotización generada con el codigo: ".concat(a.codigo),coti:a}),e.next=17;break;case 14:return e.prev=14,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 17:case"end":return e.stop()}}),e,null,[[0,14]])})));return function(t,n){return e.apply(this,arguments)}}(),Et=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"noone"!==t.body.dateOne&&"noone"!==t.body.dateTwo){e.next=7;break}return e.next=4,It.find({estado:t.body.estado}).skip(parseInt(t.body.skip)).limit(parseInt(t.body.limit));case 4:r=e.sent,e.next=10;break;case 7:return e.next=9,It.find({estado:t.body.estado,date:{$gte:new Date(t.body.dateOne),$lt:new Date(t.body.dateTwo)}}).skip(parseInt(t.body.skip)).limit(parseInt(t.body.limit));case 9:r=e.sent;case 10:n.json(r),e.next=16;break;case 13:return e.prev=13,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 16:case"end":return e.stop()}}),e,null,[[0,13]])})));return function(t,n){return e.apply(this,arguments)}}(),Dt=function(){var e=A()(_().mark((function e(){var t,n,r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,It.countDocuments({});case 3:for(e.t0=e.sent,t=e.t0+1,n="COTSD01-000000",r=0;r<t.toString().length;r++)n=n.slice(0,-1);return a=n+t.toString(),e.abrupt("return",a);case 11:return e.prev=11,e.t1=e.catch(0),e.abrupt("return",res.status(500).json({errorMSG:e.t1}));case 14:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(){return e.apply(this,arguments)}}(),qt=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=e.split(" ").join("");return e.startsWith("+")||(t="+51"+e.split(" ").join("")),t},Gt=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,It.findOne({codigo:t.params.cotiCod});case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Mt=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,It.aggregate([{$match:{codigo:t.body.codCoti}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$unwind:{path:"$cantidadSC",preserveNullAndEmptyArrays:!0}},{$match:{$or:[{"cantidadSC.cantidadVenta":{$gt:0}},{cantidadSC:null}]}}]);case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Rt=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,It.aggregate([{$match:{codigo:t.body.codigoCoti}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$match:{codigo:t.body.itemVendido.codigo}},{$count:"thisItem"}]);case 3:if(0===e.sent.length){e.next=14;break}return e.next=7,It.aggregate([{$match:{codigo:t.body.codigoCoti}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$match:{codigo:t.body.itemVendido.codigo}}]);case 7:return r=e.sent,a=Math.round(100*(r[0].totalPrice-t.body.itemVendido.totalPrice+Number.EPSILON))/100*-1,o=Math.round(100*(r[0].totalPriceNoIGV-t.body.itemVendido.totalPriceNoIGV+Number.EPSILON))/100*-1,e.next=12,It.findOneAndUpdate({codigo:t.body.codigoCoti,itemsVendidos:{$elemMatch:{codigo:t.body.itemVendido.codigo}}},{$set:{"itemsVendidos.$":t.body.itemVendido},$inc:{totalPrice:a,totalPriceNoIGV:o}},{useFindAndModify:!1,new:!0});case 12:return i=e.sent,e.abrupt("return",n.json({message:"Cantidades actualizadas",coti:i}));case 14:return e.next=16,It.findOneAndUpdate({codigo:t.body.codigoCoti},{$push:{itemsVendidos:t.body.itemVendido},$inc:{totalPrice:t.body.itemVendido.totalPrice,totalPriceNoIGV:t.body.itemVendido.totalPriceNoIGV}},{useFindAndModify:!1,new:!0});case 16:s=e.sent,n.json({message:"Item agregado correctamente",coti:s}),e.next=23;break;case 20:return e.prev=20,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 23:case"end":return e.stop()}}),e,null,[[0,20]])})));return function(t,n){return e.apply(this,arguments)}}(),Lt=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,It.findOneAndUpdate({codigo:t.body.codigo},{$inc:{totalPrice:-1*t.body.totalPrice,totalPriceNoIGV:-1*t.body.totalPriceNoIGV},$pull:{itemsVendidos:{codigo:t.body.codigoItem}}},{useFindAndModify:!1,new:!0});case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Ut=function(){var e=A()(_().mark((function e(t,n){return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,It.findOneAndUpdate({codigo:t.body.codigo},{estado:"eliminada"});case 3:n.json({eliminada:!0}),e.next=9;break;case 6:return e.prev=6,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 9:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t,n){return e.apply(this,arguments)}}(),Bt=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s,c,d,u,p,l;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=new dt.GetObjectCommand({Bucket:m.production.bucket,Key:"sirio-logo-small.png"}),e.next=4,_t.send(r);case 4:return a=e.sent,e.next=7,It.findOne({codigo:t.body.codigo});case 7:if(o=e.sent,i=[],!t.body.imagen){e.next=30;break}s=Ot(o.itemsVendidos),e.prev=11,s.s();case 13:if((c=s.n()).done){e.next=22;break}return d=c.value,u=new dt.GetObjectCommand({Bucket:m.production.bucket,Key:d.photo}),e.next=18,_t.send(u);case 18:p=e.sent,i.push(p);case 20:e.next=13;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(11),s.e(e.t0);case 27:return e.prev=27,s.f(),e.finish(27);case 30:return e.next=32,mt("Cotización","Temp Coti",["Nº","IMAGÉN","UNIDAD DE MEDIDA","NOMBRE","DESCRIPCIÓN","CANTIDAD","P/CU","TOTAL"],o,a.Body,t.body.extra,t.body.imagen,i);case 32:l=e.sent,n.writeHead(200,{"Content-Type":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","Content-Disposition":"attachment; filename=".concat(o.codigo,".xlsx")}),n.write(l,"binary"),n.end(null,"binary"),e.next=41;break;case 38:return e.prev=38,e.t1=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t1}));case 41:case"end":return e.stop()}}),e,null,[[0,38],[11,24,27,30]])})));return function(t,n){return e.apply(this,arguments)}}(),Ft=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s,c,d,u,p,l;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,It.findOne({codigo:t.body.codigo});case 3:return r=e.sent,a=new dt.GetObjectCommand({Bucket:m.production.bucket,Key:"sirio-logo-small.png"}),e.next=7,_t.send(a);case 7:if(o=e.sent,i=[],!t.body.imagen){e.next=30;break}s=Ot(r.itemsVendidos),e.prev=11,s.s();case 13:if((c=s.n()).done){e.next=22;break}return d=c.value,u=new dt.GetObjectCommand({Bucket:m.production.bucket,Key:d.photo}),e.next=18,_t.send(u);case 18:p=e.sent,i.push(p);case 20:e.next=13;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(11),s.e(e.t0);case 27:return e.prev=27,s.f(),e.finish(27);case 30:l=kt(o.Body,r,t.body.extra,i,t.body.imagen),n.setHeader("Content-Type","application/pdf"),n.setHeader("Content-Disposition","attachment; filename=quote.pdf"),l.pipe(n),l.end(),e.next=40;break;case 37:return e.prev=37,e.t1=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t1}));case 40:case"end":return e.stop()}}),e,null,[[0,37],[11,24,27,30]])})));return function(t,n){return e.apply(this,arguments)}}(),zt=new $.Router;zt.post("/generarCoti",fe,Pt),zt.post("/getPendientes",fe,Et),zt.get("/obtenerCoti/:cotiCod",fe,Gt),zt.post("/cotiForCard",fe,Mt),zt.post("/agregarItemCoti",fe,Rt),zt.post("/eliminarItemCoti",fe,Lt),zt.put("/eliminarCoti",fe,Ut),zt.post("/getPdfCoti",fe,Ft),zt.post("/getExcelCoti",fe,Bt);const Wt=zt;var Kt=x().Router();Kt.post("/enviarMensaje",L);const Jt=Kt,Ht=require("node-fetch");var Yt=n.n(Ht);const Qt=require("@babel/runtime/helpers/classCallCheck");var Zt=n.n(Qt);const Xt=require("@babel/runtime/helpers/createClass");var en=n.n(Xt),tn=function(){function e(t,n){Zt()(this,e),this.operacion="generar_guia",this.tipo_de_comprobante=t,this.serie=7===t?"TTT2":"VVV2",this.numero=n,this.fecha_de_emision=this.getNowDate(),this.enviar_automaticamente_al_cliente=!0,this.formato_de_pdf="TICKET",this.items=[],this.vehiculos_secundarios=[],this.conductores_secundarios=[],this.documento_relacionado=[]}return en()(e,[{key:"addDocumentoRelacionado",value:function(e,t,n){return this.documento_relacionado.push({tipo:e,serie:t,numero:n}),this}},{key:"addCliente",value:function(e,t,n,r,a){return this.cliente_tipo_de_documento=e,this.cliente_numero_de_documento=t,this.cliente_denominacion=n,this.cliente_direccion=r,this.cliente_email=a,this}},{key:"getNowDate",value:function(){var e=DateTime.local().setZone("UTC-5").toLocaleString().split("/"),t=e[0],n=e[1],r=e[2].split(",")[0];return"".concat(t,"-").concat(n,"-").concat(r)}},{key:"addObservaciones",value:function(e){return this.observaciones=e,this}},{key:"addMotivoDeTraslado",value:function(e){return this.motivo_de_traslado=e,this}},{key:"addMotivoDeTrasladoOtros",value:function(e){return this.motivo_de_traslado_otros=e,this}},{key:"addPesoBruto",value:function(e,t){return this.peso_bruto_total=e,this.peso_bruto_unidad_de_medida=t,this}},{key:"addNumeroDeBultos",value:function(e){return this.numero_de_bultos=e,this}},{key:"addTipoDeTransporte",value:function(e){return this.tipo_de_transporte=e,this}},{key:"addFechaDeInicioDeTraslado",value:function(e){return this.fecha_de_inicio_de_traslado=e,this}},{key:"addTransportista",value:function(e,t,n){return this.transportista_documento_tipo=e,this.transportista_documento_numero=t,this.transportista_denominacion=n,this}},{key:"addTransportistaPlacaNumero",value:function(e){return this.transportista_placa_numero=e,this}},{key:"addTucVehiculo",value:function(e){return this.tuc_vehiculo=e,this}},{key:"addConductor",value:function(e,t,n,r,a){return this.conductor_documento_tipo=e,this.conductor_documento_numero=t,this.conductor_nombre=n,this.conductor_apellidos=r,this.conductor_numero_licencia=a,this}},{key:"addDestinatario",value:function(e,t,n){return this.destinatario_documento_tipo=e,this.destinatario_documento_numero=t,this.destinatario_denominacion=n,this}},{key:"addPuntoDePartida",value:function(e,t){return this.punto_de_partida_ubigeo=e,this.punto_de_partida_direccion=t,this}},{key:"addPuntoDeLlegada",value:function(e,t){return this.punto_de_llegada_ubigeo=e,this.punto_de_llegada_direccion=t,this}},{key:"addPuntoDePartidaCodigoEstablecimientoSunat",value:function(e){return this.punto_de_partida_codigo_establecimiento_sunat=e,this}},{key:"addPuntoDeLlegadaCodigoEstablecimientoSunat",value:function(e){return this.punto_de_llegada_codigo_establecimiento_sunat=e,this}},{key:"addItem",value:function(e){return this.items.push(e),this}},{key:"addVehiculoSecundario",value:function(e,t){return this.vehiculos_secundarios.push({placa_numero:e,tuc:t}),this}},{key:"addConductorSecundario",value:function(e,t,n,r,a){return this.conductores_secundarios.push({documento_tipo:e,documento_numero:t,nombre:n,apellidos:r,numero_licencia:a}),this}}]),e}(),nn=function(){function e(t,n,r,a,o,i,s,c,d){Zt()(this,e),this.unidad_de_medida=t,this.codigo=n,this.descripcion=r,this.cantidad=a,this.valor_unitario=o,this.precio_unitario=i,this.subtotal=s,this.tipo_de_igv=1,this.igv=c,this.total=d}return en()(e,[{key:"toString",value:function(){return JSON.stringify(this)}},{key:"toJSON",value:function(e){var t={},n=e||this;Object.getOwnPropertyNames(n).forEach((function(e){var r=n[e];"toJSON"!==e&&"constructor"!==e&&(t[e]="function"!=typeof r?r:r.bind(t))}));var r=Object.getPrototypeOf(n);return null!==r&&Object.keys(this.toJSON(r)).forEach((function(e){t[e]||"constructor"===e||"toJSON"===e||("function"!=typeof r[e]?t[e]=r[e]:t[e]=r[e].bind(t))})),t}}]),e}(),rn=function(){function e(t){Zt()(this,e),this.operacion="generar_comprobante",this.tipo_de_comprobante=t.tipo_de_comprobante,1===this.tipo_de_comprobante?(this.cliente_tipo_de_documento="6",this.serie="FFF2"):(this.cliente_tipo_de_documento="1",this.serie="BBB2"),this.numero=t.numero,this.sunat_transaction=1,this.cliente_numero_de_documento=t.cliente_numero_de_documento,this.cliente_denominacion=t.cliente_denominacion,this.cliente_direccion=t.cliente_direccion||"",this.cliente_email=t.cliente_email||"",this.fecha_de_emision=t.fecha_de_emision,this.moneda=1,this.porcentaje_de_igv=18,this.total_gravada=t.total_gravada,this.total_igv=t.total_igv,this.total=t.total,this.detraccion=!1,this.enviar_automaticamente_a_la_sunat=!0,this.enviar_automaticamente_al_cliente=!1,this.formato_de_pdf="TICKET",this.items=t.items||[],this.guias=t.guias||[],this.codigo_unico=t.codigo_unico||"",this.cliente_email=t.cliente_email||"",this.enviar_automaticamente_al_cliente=t.enviar_automaticamente_al_cliente||!1,this.medio_de_pago=t.medio_de_pago,this.venta_al_credito=t.venta_al_credito||[],this.fecha_de_vencimiento=t.fecha_de_vencimiento||""}return en()(e,[{key:"toString",value:function(){return Object.keys(this)}},{key:"toJSON",value:function(e){var t={},n=e||this;Object.getOwnPropertyNames(n).forEach((function(e){var r=n[e];"toJSON"!==e&&"constructor"!==e&&(t[e]="function"!=typeof r?r:r.bind(t))}));var r=Object.getPrototypeOf(n);return null!==r&&Object.keys(this.toJSON(r)).forEach((function(e){t[e]||"constructor"===e||"toJSON"===e||("function"!=typeof r[e]?t[e]=r[e]:t[e]=r[e].bind(t))})),t}}]),e}(),an=function(){function e(t,n,r,a,o,i){Zt()(this,e),this.tipo_de_comprobante=t,this.numero=n,this.cliente_numero_de_documento=r,this.cliente_denominacion=a,this.fecha_de_emision=this.getNowDate(),this.items=[],this.guias=[],this.codigo_unico=o,this.medio_de_pago=i}return en()(e,[{key:"getNowDate",value:function(){var e=vt.DateTime.local().setZone("UTC-5").toLocaleString().split("/"),t=e[0],n=e[1],r=e[2].split(",")[0];return"".concat(t,"-").concat(n,"-").concat(r)}},{key:"addDireccion",value:function(e){this.cliente_direccion=e}},{key:"addPrecios",value:function(e,t,n){this.total=n,this.total_gravada=e,this.total_igv=t}},{key:"addItem",value:function(e){this.items.push(e)}},{key:"addGuide",value:function(e){this.guias.push(e)}},{key:"build",value:function(){return new rn(this)}},{key:"addCredits",value:function(e){this.venta_al_credito=e}},{key:"setMedioDePago",value:function(e){this.medio_de_pago=e}},{key:"setFechaDeVencimiento",value:function(e){this.fecha_de_vencimiento=e}},{key:"addEmail",value:function(e){this.enviar_automaticamente_al_cliente=!0,this.cliente_email=e}}]),e}();function on(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return sn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?sn(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function sn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var cn=m.production.log(),dn=function(){var e=A()(_().mark((function e(t,n,r){var a,o,i,s,c,d,u,p,l,g,f,y,b,h,v,$,x,w,S,C,V,k,T,j,N,O,A,I,P,E,D,q,G,M,R,L,U,B,F,z,W,K,J,H;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,a=n.locals.venta,o=n.locals.countGuias+1,i=t.body,s=i.tipoDeComprobante,c=i.tipoDeDocumento,d=i.numeroDeDocumento,u=i.denominacion,p=i.direccion,l=i.email,g=i.observaciones,f=i.motivoDeTraslado,y=i.motivoDeTrasladoOtros,b=i.pesoBruto,h=i.pesoBrutoUnidadDeMedida,v=i.numeroDeBultos,$=i.fechaDeInicioDeTraslado,x=i.tipoDeTransporte,w=i.transportistaTipoDeDocumento,S=i.transportistaNumeroDeDocumento,C=i.transportistaDenominacion,V=i.transportistaPlacaNumero,k=i.tucVehiculoPrincipal,T=i.conductorDocumentoTipo,j=i.conductorDocumentoNumero,N=i.conductorDenominacion,O=i.conductorNombre,A=i.conductorApellidos,I=i.conductorNumeroLicencia,P=i.destinatarioDocumentoTipo,E=i.destinatarioDocumentoNumero,D=i.destinatarioDenominacion,q=i.puntoDePartidaUbigeo,G=i.puntoDePartidaDireccion,M=i.puntoDePartidaCodigoEstablecimientoSunat,R=i.puntoDeLlegadaUbigeo,L=i.puntoDeLlegadaDireccion,U=i.puntoDeLlegadaCodigoEstablecimientoSunat,"04"!==(B=new tn(s,o).addCliente(c,d,u,p,l).addObservaciones(g).addPesoBruto(b,h).addFechaDeInicioDeTraslado($).addTransportistaPlacaNumero(V).addPuntoDePartida(q,G).addPuntoDeLlegada(R,L)).motivo_de_traslado&&"18"!==B.motivo_de_traslado||B.addPuntoDePartidaCodigoEstablecimientoSunat(M).addPuntoDeLlegadaCodigoEstablecimientoSunat(U),a.serie&&a.numero&&a.tipoComprobante&&B.addDocumentoRelacionado(a.tipoComprobante,a.serie,a.numero),!a.serie&&!a.numero&&!a.tipoComprobante){F=on(a.itemsVendidos);try{for(F.s();!(z=F.n()).done;)W=z.value,K={unidad_de_medida:"NIU",codigo:W.codigo,descripcion:W.name+" | "+W.descripcion,cantidad:W.cantidad},"UND"===W.unidadDeMedida?K.unidad_de_medida="NIU":"PAR"===W.unidadDeMedida?K.unidad_de_medida="PR":"CAJA"===W.unidadDeMedida&&(K.unidad_de_medida="BX"),B.addItem(K)}catch(e){F.e(e)}finally{F.f()}}return 7===B.tipo_de_comprobante?(B.addMotivoDeTraslado(f),"13"===B.motivo_de_traslado&&B.addMotivoDeTrasladoOtros(y),B.addNumeroDeBultos(v).addTipoDeTransporte(x).addTransportista(w,S,C),"02"===B.tipo_de_transporte&&B.addConductor(T,j,N,O,A,I)):B.addTucVehiculo(k).addConductor(T,j,N,O,A,I).addDestinatario(P,E,D),e.next=11,Yt()("https://api.nubefact.com/api/v1/9e79db57-8322-4c1a-ac73-fa5093668c3c",{method:"post",headers:{"Content-Type":"application/json",Authorization:m.production.nbfToken},body:JSON.stringify(temporalJSON)});case 11:return J=e.sent,e.next=14,J.json();case 14:if(!(H=e.sent).tipo_de_comprobante){e.next=19;break}return cn.info(H),n.locals.guia=H,e.abrupt("return",r());case 19:return cn.error(H),e.abrupt("return",n.status(400).json({message:"Error al crear guía"}));case 23:return e.prev=23,e.t0=e.catch(0),cn.error(e.t0),e.abrupt("return",n.status(500).json({message:"Error desconocido al crear guía"}));case 27:case"end":return e.stop()}}),e,null,[[0,23]])})));return function(t,n,r){return e.apply(this,arguments)}}(),un=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yt()("https://api.nubefact.com/api/v1/9e79db57-8322-4c1a-ac73-fa5093668c3c",{method:"post",headers:{"Content-Type":"application/json",Authorization:m.production.nbfToken},body:JSON.stringify({operacion:"consultar_guia",tipo_de_comprobante:t.params.tipoComprobante,serie:t.params.serie,numero:t.params.numero})});case 3:return r=e.sent,e.next=6,r.json();case 6:if(!(a=e.sent).tipo_de_comprobante){e.next=10;break}return cn.info(a),e.abrupt("return",n.json(a));case 10:return cn.error(a),e.abrupt("return",n.status(400).json({message:"Error obtener guia"}));case 14:return e.prev=14,e.t0=e.catch(0),cn.error(e.t0),e.abrupt("return",n.status(500).json({message:"Error desconocido al obtener guia"}));case 18:case"end":return e.stop()}}),e,null,[[0,14]])})));return function(t,n){return e.apply(this,arguments)}}(),pn=function(){var e=A()(_().mark((function e(){var t,n,r,a,o,i,s=arguments;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=s.length>0&&void 0!==s[0]?s[0]:1,n=s.length>1&&void 0!==s[1]?s[1]:"",r=s.length>2&&void 0!==s[2]?s[2]:0,a=s.length>3&&void 0!==s[3]?s[3]:"",e.prev=4,o={operacion:"generar_anulacion",tipo_de_comprobante:t,serie:n,numero:r,motivo:a},e.next=8,Yt()("https://api.nubefact.com/api/v1/9e79db57-8322-4c1a-ac73-fa5093668c3c",{method:"post",headers:{"Content-Type":"application/json",Authorization:m.production.nbfToken},body:JSON.stringify(o)}).then((function(e){return e.json()}));case 8:return i=e.sent,e.abrupt("return",i.enlace_del_pdf);case 12:throw e.prev=12,e.t0=e.catch(4),e.t0;case 15:case"end":return e.stop()}}),e,null,[[4,12]])})));return function(){return e.apply(this,arguments)}}(),ln=function(e){var t=e.medio_de_pago.split("|")[0],n=e.medio_de_pago.split("|")[1],r="";switch(t){case"efectivo":r="Efectivo";break;case"tarjeta":r="Tarjeta: "+n;break;case"yape":r="Yape: "+n;break;case"otro":r=n}return r},mn=function(e,t,n){var r={};if(cn.info(e.ventResult.documento),"boleta"===e.ventResult.documento.type)r=function(e,t){var n="";if(e.documento.codigo.toString().length<8)for(var r=0;r<8-e.documento.codigo.toString().length;r++)n+="0";var a=e.documento.codigo.toString().length<8?n+e.documento.codigo.toString():e.documento.codigo,o=new an(2,1+t,a,e.documento.name,e.codigo,ln(e));o.addPrecios(e.totalPriceNoIGV,e.totalPrice-e.totalPriceNoIGV,e.totalPrice),o.addCredits(e.credits),o.setFechaDeVencimiento(e.fechaDeVencimiento),e.credits&&e.credits.length>0&&o.setMedioDePago(""),e.cliente_email&&o.addEmail(e.cliente_email),e.itemsVendidos.forEach((function(e){var t=new nn("NIU",e.codigo,e.name+" | "+e.descripcion,e.cantidad,e.priceNoIGV,e.priceIGV,e.totalPriceNoIGV,e.totalPrice-e.totalPriceNoIGV,e.totalPrice);"UND"===e.unidadDeMedida?t.unidad_de_medida="NIU":"PAR"===e.unidadDeMedida?t.unidad_de_medida="PR":"CAJA"===e.unidadDeMedida&&(t.unidad_de_medida="BX"),o.addItem(t.toJSON())}));var i,s=on(e.guias);try{for(s.s();!(i=s.n()).done;){var c=i.value;o.addGuide({guia_tipo:7===c.tipoDeComprobante?1:2,guia_serie_numero:"".concat(c.serie.toString(),"-").concat(c.numero)})}}catch(e){s.e(e)}finally{s.f()}return o.build().toJSON()}(e.ventResult,e.count);else{if("factura"!==e.ventResult.documento.type)return t.json({message:"Success||".concat(e.ventResult.codigo),_sunat:null});r=function(e,t,n){var r="";if(e.documento.codigo.toString().length<11)for(var a=0;a<11-e.documento.codigo.toString().length;a++)r+="0";var o=e.documento.codigo.toString().length<11?r+e.documento.codigo.toString():e.documento.codigo,i=new an(1,1+t,o,e.documento.name,e.codigo,ln(e));i.addPrecios(e.totalPriceNoIGV,e.totalPrice-e.totalPriceNoIGV,e.totalPrice),i.addCredits(e.credits),i.setFechaDeVencimiento(e.fechaDeVencimiento),e.credits&&e.credits.length>0&&i.setMedioDePago(""),e.cliente_email&&i.addEmail(e.cliente_email),e.itemsVendidos.forEach((function(e){var t=new nn("NIU",e.codigo,e.name+" | "+e.descripcion,e.cantidad,e.priceNoIGV,e.priceIGV,e.totalPriceNoIGV,e.totalPrice-e.totalPriceNoIGV,e.totalPrice);"UND"===e.unidadDeMedida?t.unidad_de_medida="NIU":"PAR"===e.unidadDeMedida?t.unidad_de_medida="PR":"CAJA"===e.unidadDeMedida&&(t.unidad_de_medida="BX"),i.addItem(t.toJSON())})),i.addDireccion(e.documento.direccion);var s,c=on(e.guias);try{for(c.s();!(s=c.n()).done;){var d=s.value;newBoleta.addGuide({guia_tipo:7===d.tipoDeComprobante?1:2,guia_serie_numero:"".concat(d.serie.toString(),"-").concat(d.numero)})}}catch(e){c.e(e)}finally{c.f()}return i.build().toJSON()}(e.ventResult,e.count)}cn.info("jsonToSend",r),function r(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Yt()(process.env.NUBE_FACT_API_URL||"https://api.nubefact.com/api/v1/9e79db57-8322-4c1a-ac73-fa5093668c3c",{method:"post",headers:{"Content-Type":"application/json",Authorization:m.production.nbfToken},body:JSON.stringify(o)}).then((function(e){return e.json()})).then((function(t){if((23===t.codigo||"23"===t.codigo)&&a<3)return o.numero=t.numero+1,r(a+1,o);e.sunat=t,n()})).catch((function(n){cn.error(n),t.status(n.status||500).json({message:"Success||".concat(e.ventResult.codigo),_sunat:null})}))}(0,r)},gn=function(){var e=A()(_().mark((function e(t){var n,r,a,o,i,s,c,d;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=new(pt().Workbook),r={sheetFormat:{defaultRowHeight:20,defaultColWidth:20}},a=n.addWorksheet("Gastos",r),o=n.addWorksheet("Ventas",r),i=n.addWorksheet("Balance",r),s=n.createStyle({font:{color:"black",size:12},border:{right:{style:"thin",color:"white"},left:{style:"thin",color:"white"},bottom:{style:"thin",color:"white"}},alignment:{vertical:"center"},numberFormat:"[$S/-es-PE]#,##0.00"}),c=n.createStyle({font:{color:"black",size:12},border:{right:{style:"thin",color:"white"},left:{style:"thin",color:"white"},bottom:{style:"thin",color:"white"}},alignment:{vertical:"center"},numberFormat:"[$S/-es-PE]#,##0.00",fill:{type:"pattern",patternType:"solid",fgColor:"#e2f3ff"}}),a.row(2).setHeight(40),a.column(1).setWidth(10),a.column(5).setWidth(60),o.row(2).setHeight(40),o.column(1).setWidth(10),o.column(5).setWidth(60),i.row(2).setHeight(40),i.column(1).setWidth(10),i.column(5).setWidth(60),fn(n,a,o,i,t.name),yn(n,a,o),bn(a,t,5,s,c,0),hn(o,t,5,s,c,0),e.next=23,n.writeToBuffer();case 23:return d=e.sent,e.abrupt("return",d);case 27:throw e.prev=27,e.t0=e.catch(0),new Error(e.t0);case 30:case"end":return e.stop()}}),e,null,[[0,27]])})));return function(t){return e.apply(this,arguments)}}(),fn=function(e,t,n,r,a){var o=e.createStyle({font:{color:"white",size:16,bold:!0},alignment:{horizontal:"center",vertical:"center"},fill:{type:"pattern",patternType:"solid",fgColor:"#005087"}});t.cell(2,2,2,6,!0).string("Gastos | ".concat(a)).style(o),n.cell(2,2,2,6,!0).string("Ganancias | ".concat(a)).style(o),r.cell(2,2,2,6,!0).string("Balance | ".concat(a)).style(o),t.row(3).setHeight(10),n.row(3).setHeight(10),r.row(3).setHeight(10)},yn=function(e,t,n){for(var r=e.createStyle({font:{color:"white",size:14},border:{right:{style:"thin",color:"white"},left:{style:"thin",color:"white"},bottom:{style:"thin",color:"white"}},alignment:{horizontal:"left",vertical:"center"},fill:{type:"pattern",patternType:"solid",fgColor:"#e87200"}}),a=2,o=0,i=["Fecha","Comentario","Cantidad","Sub Cantidad","Costo"];o<i.length;o++){var s=i[o];t.cell(4,a).string(s).style(r),n.cell(4,a).string(s).style(r),a++}t.row(4).filter({firstColumn:2,lastColumn:3}),n.row(4).filter({firstColumn:2,lastColumn:3})},bn=function e(t,n,r,a,o,i){var s,c=r-5;if((c+=i)>=n.variaciones.length)return 5;if(!1===n.variaciones[c].tipo)return 0+e(t,n,r,a,o,i+1);s=r%2==0?o:a;var d=n.variaciones[c],u=new Date(d.date);t.cell(r,2).date(u.toLocaleDateString()).style(s).style({numberFormat:"dd-mm-yyy",alignment:{horizontal:"left",vertical:"center"}}),t.cell(r,4).string(d.cantidad.toString()).style(s);var p="";d.cantidadSC&&(d.cantidadSC.forEach((function(e){var t=e.cantidadVenta;"new item"===d.comentario&&(t=e.cantidadDisponible);var n="";e.nameSecond&&(n="-"+e.nameSecond),p=p+e.name+n+": "+t+", "})),p.length>1&&(p=p.slice(0,-2))),t.cell(r,5).string(p).style(s);var l=d.costoVar;t.cell(r,6).number(l).style(s);var m=d.comentario;return"new item"===d.comentario?m="Nuevo Item":"anular"===d.comentario.split("|")[0]&&(m="Anulada "+d.comentario.split("|")[1]),t.cell(r,3).string(m).style(s),1+e(t,n,r+1,a,o,i)},hn=function e(t,n,r,a,o,i){var s,c=r-5;if((c+=i)>=n.variaciones.length)return 5;if(!0===n.variaciones[c].tipo)return 0+e(t,n,r,a,o,i+1);s=r%2==0?o:a;var d=n.variaciones[c],u=new Date(d.date);t.cell(r,2).date(u.toLocaleDateString()).style(s).style({numberFormat:"dd-mm-yyy",alignment:{horizontal:"left",vertical:"center"}}),t.cell(r,4).string(d.cantidad.toString()).style(s);var p="";d.cantidadSC&&(d.cantidadSC.forEach((function(e){var t=e.cantidadVenta;"new item"===d.comentario&&(t=e.cantidadDisponible);var n="";e.nameSecond&&(n="-"+e.nameSecond),p=p+e.name+n+": "+t+", "})),p.length>1&&(p=p.slice(0,-2))),t.cell(r,5).string(p).style(s);var l=d.costoVar;t.cell(r,6).number(l).style(s);var m=d.comentario;return"venta"===d.comentario.split("|")[0]&&(m="Venta "+d.comentario.split("|")[1]),t.cell(r,3).string(m).style(s),1+e(t,n,r+1,a,o,i)};const vn=new z.Schema({name:{type:String,required:!0,unique:!0},codigo:{type:String,required:!0,unique:!0},ruc:{type:Number}}),$n=new z.Schema({name:{type:String,required:!0,unique:!0},deleted:{type:Boolean,default:!1}}),xn=new z.Schema({tipoComprobante:{type:Number,required:!0},serie:{type:String,required:!0},numero:{type:Number,required:!0},ventaCod:{type:String},linkComprobante:{type:String}}),wn=require("multer");var Sn=n.n(wn);const Cn=require("multer-s3");var Vn=n.n(Cn);const kn=require("pdfkit");var Tn=n.n(kn),jn=function(e,t){var n=new(Tn())({size:"A4",margin:50});return Nn(n,t),On(n,e),Pn(n,e),En(n),n},Nn=function(e,t){e.image(t,50,30,{width:70}).fillColor("#444444").fontSize(20).fontSize(10).text("Sirio Dinar | RUC: 20605746587",200,50,{align:"right"}).text("Jr. Felipe Pardo Y Aliaga 213, Trujillo.",200,65,{align:"right"}).text("+51 977-426-349",200,80,{align:"right"}).moveDown()},On=function(e,t){e.fillColor("#444444").fontSize(20).text("Comprobante",50,160),An(e,185);e.fontSize(10).text("Codigo:",50,200).font("Helvetica-Bold").text(t.codigo,150,200).font("Helvetica").text("Fecha de emisión:",50,240).text(_n(new Date),150,240).font("Helvetica-Bold").text(t.documento.name,300,200).font("Helvetica").text(t.documento.codigo,300,240).moveDown(),An(e,260)},An=function(e,t){e.strokeColor("#aaaaaa").lineWidth(1).moveTo(50,t).lineTo(550,t).stroke()},In=function(e){return"S/"+e.toFixed(2)},_n=function(e){var t=e.getDate(),n=e.getMonth()+1;return e.getFullYear()+"/"+n+"/"+t},Pn=function(e,t){var n,r=307;for(e.fontSize(8).font("Helvetica-Bold"),Dn(e,r,"Cod","Nombre","Descripcion","Precio","Cantidad","Total"),An(e,25+(r=300)),e.font("Helvetica"),n=0;n<t.itemsVendidos.length;n++){var a=t.itemsVendidos[n],o=a.descripcion;a.cantidadSC.length>0&&(o+="\nCantidades: ");for(var i=0;i<a.cantidadSC.length;i++)a.cantidadSC[i].cantidadVenta>0&&(o=o+a.cantidadSC[i].name+" - "+a.cantidadSC[i].nameSecond+": "+a.cantidadSC[i].cantidadVenta+", ");a.cantidadSC.length>0&&(o=o.slice(0,-2)+".");var s=r+30*(2*n+1);Dn(e,s,a.codigo,a.name,o,In(a.priceNoIGV),a.cantidad,In(a.totalPriceNoIGV)),An(e,s+55)}var c=r+31*(2*n+1);Dn(e,c,"","","","","Subtotal",In(t.totalPriceNoIGV));var d=c+15;Dn(e,d,"","","","","IGV 18%",In(t.totalPrice-t.totalPriceNoIGV));var u=d+15;e.font("Helvetica-Bold"),Dn(e,u,"","","","","Total",In(t.totalPrice)),e.font("Helvetica")},En=function(e){e.fontSize(10).text("siriodinar.com",50,780,{align:"center",width:500})},Dn=function(e,t,n,r,a,o,i,s){e.fontSize(8).text(n,50,t,{width:40}).text(r,100,t,{width:100}).text(a,210,t,{width:180}).text(o,400,t,{width:35,align:"right"}).text(i,460,t,{width:35,align:"right"}).text(s,0,t,{align:"right"})};function qn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Gn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?qn(Object(n),!0).forEach((function(t){_e()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):qn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Mn=n(441),Rn=new dt.S3Client({credentials:{accessKeyId:m.production.awsID,secretAccessKey:m.production.awsKey},region:"us-east-1"}),Ln=function(){var e=A()(_().mark((function e(t){var n,r,a,o;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=new dt.GetObjectCommand({Bucket:m.production.bucket,Key:"sirio-logo.png"}),e.next=4,Rn.send(n);case 4:return r=e.sent,(a=jn(t,r.Body)).end(),o=new dt.PutObjectCommand({Bucket:m.production.bucket,Key:"".concat(t.codigo,".pdf"),Body:a,ContentType:"application/pdf"}),e.next=10,Rn.send(o);case 10:e.next=16;break;case 12:return e.prev=12,e.t0=e.catch(0),m.production.log().error(e.t0),e.abrupt("return",e.t0);case 16:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t){return e.apply(this,arguments)}}(),Un=function(){var e=A()(_().mark((function e(t,n,r){var a,o,i;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"noPhoto.jpg"===t.body.oldPhoto){e.next=9;break}return a=new dt.DeleteObjectCommand({Bucket:m.production.bucket,Key:t.body.oldPhoto}),e.next=5,Rn.send(a);case 5:return o=t.body.oldPhoto.split("."),i=new dt.DeleteObjectCommand({Bucket:m.production.bucket,Key:"".concat(o[0],".webp")}),e.next=9,Rn.send(i);case 9:r(),e.next=15;break;case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t,n,r){return e.apply(this,arguments)}}(),Bn=function(){var e=A()(_().mark((function e(t,n,r){var a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"noPhoto.jpg"===t.photNameToDelete){e.next=5;break}return a=new dt.DeleteObjectCommand({Bucket:m.production.bucket,Key:t.photNameToDelete}),e.next=5,Rn.send(a);case 5:n.json(t.result),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n,r){return e.apply(this,arguments)}}(),Fn=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=new dt.GetObjectCommand({Bucket:m.production.bucket,Key:t.params.pdfName}),e.next=4,Rn.send(r);case 4:a=e.sent,n.writeHead(200,{"Content-Type":"aplication/pdf"}),n.write(a.Body,"binary"),n.end(null,"binary"),e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,n){return e.apply(this,arguments)}}(),zn=Sn()({storage:Vn()({s3:Rn,bucket:m.production.bucket,metadata:function(e,t,n){n(null,Gn({},e.body))},key:function(e,t,n){var r=t.originalname.split(".")[1];n(null,"IMG-"+Date.now().toString()+"."+r)}}),limits:{fileSize:2e6},fileFilter:function(e,t,n){t.originalname.match(/\.(jpg|jpeg|png)$/)||n(new Error("Por favor suba imágenes JPG y PNG!")),t.size>2e6&&n(new Error("Tamaño Excedido!")),n(void 0,!0)}}),Wn=(Sn()({storage:Vn()({s3:Rn,bucket:m.production.bucket,metadata:function(e,t,n){n(null,Gn({},e.body))},key:function(e,t,n){var r=t.originalname.split(".")[1];n(null,"STI_".concat(e.params.codigo,"_").concat(e.params.subCat),"."+r)}}),limits:{fileSize:2e6},fileFilter:function(e,t,n){t.originalname.match(/\.(jpg|jpeg|png)$/)||n(new Error("Por favor suba imágenes JPG y PNG!")),t.size>2e6&&n(new Error("Tamaño Excedido!")),n(void 0,!0)}}),Sn()({storage:Vn()({s3:Rn,bucket:m.production.bucket,metadata:function(e,t,n){n(null,Gn({},e.body))},key:function(e,t,n){n(null,"ficha-"+e.params.codigo+".pdf")}}),limits:{fileSize:1e6},fileFilter:function(e,t,n){t.originalname.match(/\.(pdf)$/)||n(new Error("Por favor suba un archivo PDF!")),n(void 0,!0)}})),Kn=function(){var e=A()(_().mark((function e(t,n,r){var a,o,i,s,c,d,u,p,l;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,a=t.file){e.next=6;break}return(o=new Error("Please upload a file")).httpStatusCode=400,e.abrupt("return",r(o));case 6:return i=a.key.split("."),s=new dt.GetObjectCommand({Bucket:m.production.bucket,Key:a.key}),c=function(e){return new Promise((function(t,n){var r=[];e.on("data",(function(e){return r.push(e)})),e.on("error",n),e.on("end",(function(){return t(Buffer.concat(r))}))}))},e.next=11,Rn.send(s);case 11:return d=e.sent,e.next=14,c(d.Body);case 14:return u=e.sent,e.next=17,Mn(u).webp({quality:50}).toBuffer();case 17:return p=e.sent,l=new dt.PutObjectCommand({Bucket:m.production.bucket,Key:"".concat(i[0],".webp"),Body:p,ACL:"public-read",CacheControl:"max-age=604800",ContentType:"image/webp"}),e.next=21,Rn.send(l);case 21:t.fileName=a.key,t.uploadInfo={statusCode:200,status:"success",uploadedFile:a},r(),e.next=29;break;case 26:return e.prev=26,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:"Ocurrió un error inesperado. Inténtelo de nuevo"}));case 29:case"end":return e.stop()}}),e,null,[[0,26]])})));return function(t,n,r){return e.apply(this,arguments)}}();function Jn(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Hn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Hn(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Hn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Yn=W().model("Item",Ue),Qn=W().model("Marca",vn),Zn=W().model("Venta",We),Xn=W().model("User",Q),er=W().model("Tag",$n),tr=W().model("Comprobante",xn),nr=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=new RegExp(t.body.value+"+[a-z0-9._ ]*$","ig"),e.next=4,Yn.find({name:{$regex:r},deleted:!1}).limit(t.body.limit);case 4:a=e.sent,n.json(a),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),rr=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=new RegExp(t.body.value+"+[a-z0-9._ ]*$","ig"),e.next=4,er.find({name:{$regex:r},deleted:!1}).limit(t.body.limit);case 4:a=e.sent,n.json(a),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),ar=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.find({oferta:{$gt:0},deleted:!1});case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),or=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.find({tipo:t.params.tipo,codigo:{$ne:t.params.codigo},deleted:!1}).limit(8);case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),ir=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=new RegExp(t.params.searchTerms+"+[a-z0-9._ ]*$","ig"),e.next=4,Yn.find({name:{$regex:r},deleted:!1}).limit(8);case 4:a=e.sent,n.json(a),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),sr=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.findOne({codigo:t.params.codigo});case 3:r=e.sent,a=cr(r.variaciones),n.json({message:a}),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),cr=function(e){try{var t,n=0,r=0,a=Jn(e);try{for(a.s();!(t=a.n()).done;){var o=t.value;!0===o.tipo?r+=o.costoVar:n+=o.costoVar}}catch(e){a.e(e)}finally{a.f()}return Math.round(100*(n-r+Number.EPSILON))/100}catch(e){throw new Error(e)}},dr=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.findOne({codigo:t.params.codigo});case 3:return r=e.sent,e.next=6,gn(r);case 6:a=e.sent,n.writeHead(200,{"Content-Type":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","Content-Disposition":"attachment; filename=reporteItem-".concat(r.codigo,".xlsx")}),n.write(a,"binary"),n.end(null,"binary"),e.next=15;break;case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t,n){return e.apply(this,arguments)}}(),ur=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Zn.aggregate([{$match:{codigo:t.body.codVenta}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$unwind:{path:"$cantidadSC",preserveNullAndEmptyArrays:!0}}]);case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),pr=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t.body.itemVendido.ventaCod=t.body.codigoVenta,e.next=4,Zn.aggregate([{$match:{codigo:t.body.codigoVenta}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$match:{codigo:t.body.itemVendido.codigo}},{$count:"thisItem"}]);case 4:if(0===e.sent.length){e.next=15;break}return e.next=8,Zn.aggregate([{$match:{codigo:t.body.codigoVenta}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$match:{codigo:t.body.itemVendido.codigo}}]);case 8:return r=e.sent,a=Math.round(100*(r[0].totalPrice-t.body.itemVendido.totalPrice+Number.EPSILON))/100*-1,o=Math.round(100*(r[0].totalPriceNoIGV-t.body.itemVendido.totalPriceNoIGV+Number.EPSILON))/100*-1,e.next=13,Zn.findOneAndUpdate({codigo:t.body.codigoVenta,itemsVendidos:{$elemMatch:{codigo:t.body.itemVendido.codigo}}},{$set:{"itemsVendidos.$":t.body.itemVendido},$inc:{totalPrice:a,totalPriceNoIGV:o}},{useFindAndModify:!1,new:!0});case 13:return i=e.sent,e.abrupt("return",n.json({message:"Cantidades actualizadas",venta:i}));case 15:return e.next=17,Zn.findOneAndUpdate({codigo:t.body.codigoVenta},{$push:{itemsVendidos:t.body.itemVendido},$inc:{totalPrice:t.body.itemVendido.totalPrice,totalPriceNoIGV:t.body.itemVendido.totalPriceNoIGV}},{useFindAndModify:!1,new:!0});case 17:s=e.sent,n.json({message:"Item agregado correctamente",venta:s}),e.next=24;break;case 21:return e.prev=21,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 24:case"end":return e.stop()}}),e,null,[[0,21]])})));return function(t,n){return e.apply(this,arguments)}}(),lr=function(){var e=A()(_().mark((function e(t,n,r){var a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=new Zn(t.body.venta),e.next=4,hr(a.documento.type);case 4:return a.codigo=e.sent,a.itemsVendidos[0].ventaCod=a.codigo,a.vendedor=t.user.aud.split(" ")[0],e.next=9,a.save();case 9:t.saveResult=e.sent,r(),e.next=16;break;case 13:return e.prev=13,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 16:case"end":return e.stop()}}),e,null,[[0,13]])})));return function(t,n,r){return e.apply(this,arguments)}}(),mr=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s,c,d,u,p,l,m,g,f,y,b;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W().startSession();case 2:return(r=e.sent).startTransaction(),e.prev=4,e.next=7,Zn.findOne({codigo:t.body.codigo});case 7:if("anuladaPost"!==e.sent.estado){e.next=13;break}return e.next=11,r.abortTransaction();case 11:return r.endSession(),e.abrupt("return",n.status(409).json({message:"Ya anulada"}));case 13:a=[],o=[],i=Jn(t.body.itemsVendidos);try{for(i.s();!(s=i.n()).done;)c=s.value,o.push(c.codigo),a.push({date:Date.now(),cantidad:c.cantidad,tipo:!0,comentario:"anular|"+t.body.codigo,costoVar:c.totalPrice,usuario:t.user.aud.split(" ")[0],cantidadSC:c.cantidadSC})}catch(e){i.e(e)}finally{i.f()}d=0,u=Jn(t.body.itemsVendidos),e.prev=19,u.s();case 21:if((p=u.n()).done){e.next=46;break}l=p.value,m=Jn(l.cantidadSC),e.prev=24,m.s();case 26:if((g=m.n()).done){e.next=33;break}if(!((f=g.value).cantidadVenta>0)){e.next=31;break}return e.next=31,Yn.findOneAndUpdate({codigo:l.codigo,"subConteo.order":{$elemMatch:{name:f.name,nameSecond:f.nameSecond}}},{$inc:{"subConteo.order.$.cantidad":f.cantidadVenta}},{useFindAndModify:!1,new:!0,session:r});case 31:e.next=26;break;case 33:e.next=38;break;case 35:e.prev=35,e.t0=e.catch(24),m.e(e.t0);case 38:return e.prev=38,m.f(),e.finish(38);case 41:return e.next=43,Yn.findOneAndUpdate({codigo:l.codigo},{$inc:{cantidad:l.cantidad},$push:{variaciones:a[d]}},{new:!0,useFindAndModify:!1,session:r});case 43:d++;case 44:e.next=21;break;case 46:e.next=51;break;case 48:e.prev=48,e.t1=e.catch(19),u.e(e.t1);case 51:return e.prev=51,u.f(),e.finish(51);case 54:if(y="","noone"===t.body.documento.type){e.next=64;break}if("factura"!==t.body.documento.type){e.next=60;break}return e.next=59,pn(1,t.body.serie,t.body.numero,"Anulación de venta");case 59:y=e.sent;case 60:if("boleta"!==t.body.documento.type){e.next=64;break}return e.next=63,pn(2,t.body.serie,t.body.numero,"Anulación de venta");case 63:y=e.sent;case 64:return e.next=66,Zn.findOneAndUpdate({codigo:t.body.codigo},{estado:"anuladaPost",linkComprobanteAnulado:y||""},{useFindAndModify:!1,new:!0,session:r});case 66:return b=e.sent,e.next=69,r.commitTransaction();case 69:return r.endSession(),e.abrupt("return",n.json({message:"success||".concat(b.codigo)}));case 73:return e.prev=73,e.t2=e.catch(4),e.next=77,r.abortTransaction();case 77:return r.endSession(),e.abrupt("return",n.status(500).json({message:e.t2}));case 79:case"end":return e.stop()}}),e,null,[[4,73],[19,48,51,54],[24,35,38,41]])})));return function(t,n){return e.apply(this,arguments)}}(),gr=function(){var e=A()(_().mark((function e(t,n,r){var a,o,i,s,c,d,u,p,l,m,g;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W().startSession();case 2:return(a=e.sent).startTransaction(),e.prev=4,e.next=7,hr(t.body.venta.documento.type);case 7:return o=e.sent,t.body.venta.itemsVendidos[0].ventaCod=o,e.next=11,Yn.findOne({codigo:t.body.venta.itemsVendidos[0].codigo});case 11:if(i=e.sent,s={date:Date.now(),cantidad:t.body.venta.itemsVendidos[0].cantidad,tipo:!1,comentario:"venta|"+o,usuario:t.user.aud.split(" ")[0],costoVar:t.body.venta.totalPrice,cantidadSC:t.body.venta.itemsVendidos[0].cantidadSC},0===t.body.venta.itemsVendidos[0].cantidadSC.length){e.next=53;break}c=Jn(t.body.venta.itemsVendidos[0].cantidadSC),e.prev=15,c.s();case 17:if((d=c.n()).done){e.next=45;break}if(!((u=d.value).cantidadVenta>0)){e.next=43;break}return e.next=22,Yn.findOneAndUpdate({codigo:t.body.venta.itemsVendidos[0].codigo,"subConteo.order":{$elemMatch:{name:u.name,nameSecond:u.nameSecond}}},{$inc:{"subConteo.order.$.cantidad":-u.cantidadVenta}},{useFindAndModify:!1,new:!0,session:a});case 22:p=e.sent,l=Jn(p.subConteo.order),e.prev=24,l.s();case 26:if((m=l.n()).done){e.next=35;break}if(!(m.value.cantidad<0)){e.next=33;break}return e.next=31,a.abortTransaction();case 31:return a.endSession(),e.abrupt("return",n.status(202).json({message:"La Cantidad Ha Cambiado",item:i}));case 33:e.next=26;break;case 35:e.next=40;break;case 37:e.prev=37,e.t0=e.catch(24),l.e(e.t0);case 40:return e.prev=40,l.f(),e.finish(40);case 43:e.next=17;break;case 45:e.next=50;break;case 47:e.prev=47,e.t1=e.catch(15),c.e(e.t1);case 50:return e.prev=50,c.f(),e.finish(50);case 53:return e.next=55,Yn.findOneAndUpdate({codigo:t.body.venta.itemsVendidos[0].codigo},{$inc:{cantidad:-t.body.venta.itemsVendidos[0].cantidad},$push:{variaciones:s}},{new:!0,useFindAndModify:!1,session:a});case 55:if(!(e.sent.cantidad<0)){e.next=61;break}return e.next=59,a.abortTransaction();case 59:return a.endSession(),e.abrupt("return",n.status(202).json({message:"La Cantidad Ha Cambiado",item:i}));case 61:return(g=new Zn(t.body.venta)).codigo=o,g.vendedor=t.user.aud.split(" ")[0],e.next=66,g.save({session:a});case 66:if(t.ventResult=e.sent,"factura"!==g.documento.type){e.next=73;break}return e.next=70,tr.countDocuments({tipoComprobante:1});case 70:t.count=e.sent,e.next=77;break;case 73:if("boleta"!==g.documento.type){e.next=77;break}return e.next=76,tr.countDocuments({tipoComprobante:2});case 76:t.count=e.sent;case 77:return e.next=79,Ln(g);case 79:return e.next=81,a.commitTransaction();case 81:a.endSession(),r(),e.next=91;break;case 85:return e.prev=85,e.t2=e.catch(4),e.next=89,a.abortTransaction();case 89:return a.endSession(),e.abrupt("return",n.status(500).json({message:e.t2}));case 91:case"end":return e.stop()}}),e,null,[[4,85],[15,47,50,53],[24,37,40,43]])})));return function(t,n,r){return e.apply(this,arguments)}}(),fr=function(){var e=A()(_().mark((function e(t,n,r){var a,o,i,s,c,d,u,p,l,m,g,f,y,b,h,v,$;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W().startSession();case 2:return(a=e.sent).startTransaction(),e.prev=4,o=[],e.next=8,Zn.findOne({codigo:t.body.venta.codigo});case 8:if("ejecutada"!==(i=e.sent).estado){e.next=14;break}return e.next=12,a.abortTransaction();case 12:return a.endSession(),e.abrupt("return",n.status(409).json({message:"La venta ya ha sido ejecutada."}));case 14:s=Jn(i.itemsVendidos);try{for(s.s();!(c=s.n()).done;)"N"!==(d=c.value).codigo.charAt(2)&&"I"!==d.codigo.charAt(3)&&(itemsVendidosCod.push(d.codigo),o.push({date:Date.now(),cantidad:d.cantidad,tipo:!1,comentario:"venta|"+i.codigo,costoVar:d.totalPrice,usuario:t.user.aud.split(" ")[0],cantidadSC:d.cantidadSC}))}catch(e){s.e(e)}finally{s.f()}u=0,p=Jn(i.itemsVendidos),e.prev=18,p.s();case 20:if((l=p.n()).done){e.next=73;break}if("N"===(m=l.value).codigo.charAt(2)||"I"===m.codigo.charAt(3)){e.next=71;break}g=Jn(m.cantidadSC),e.prev=24,g.s();case 26:if((f=g.n()).done){e.next=54;break}if(!((y=f.value).cantidadVenta>0)){e.next=52;break}return e.next=31,Yn.findOneAndUpdate({codigo:m.codigo,"subConteo.order":{$elemMatch:{name:y.name,nameSecond:y.nameSecond}}},{$inc:{"subConteo.order.$.cantidad":-y.cantidadVenta}},{useFindAndModify:!1,new:!0,session:a});case 31:b=e.sent,h=Jn(b.subConteo.order),e.prev=33,h.s();case 35:if((v=h.n()).done){e.next=44;break}if(!(v.value.cantidad<0)){e.next=42;break}return e.next=40,a.abortTransaction();case 40:return a.endSession(),e.abrupt("return",n.status(202).json({message:"La Cantidad Ha Cambiado"}));case 42:e.next=35;break;case 44:e.next=49;break;case 46:e.prev=46,e.t0=e.catch(33),h.e(e.t0);case 49:return e.prev=49,h.f(),e.finish(49);case 52:e.next=26;break;case 54:e.next=59;break;case 56:e.prev=56,e.t1=e.catch(24),g.e(e.t1);case 59:return e.prev=59,g.f(),e.finish(59);case 62:return e.next=64,Yn.findOneAndUpdate({codigo:m.codigo},{$inc:{cantidad:-m.cantidad},$push:{variaciones:o[u]}},{new:!0,useFindAndModify:!1,session:a});case 64:if(!(e.sent.cantidad<0)){e.next=70;break}return e.next=68,a.abortTransaction();case 68:return a.endSession(),e.abrupt("return",n.status(202).json({message:"La Cantidad Ha Cambiado"}));case 70:u++;case 71:e.next=20;break;case 73:e.next=78;break;case 75:e.prev=75,e.t2=e.catch(18),p.e(e.t2);case 78:return e.prev=78,p.f(),e.finish(78);case 81:return e.next=83,Zn.findOneAndUpdate({codigo:t.body.venta.codigo},{estado:"ejecutada",documento:t.body.venta.documento,guia:t.body.venta.guia,cliente_email:t.body.venta.cliente_email,medio_de_pago:t.body.venta.medio_de_pago,credits:t.body.venta.credits||[],fechaDeVencimiento:t.body.venta.fechaDeVencimiento||""},{useFindAndModify:!1,new:!0,session:a,lean:!0});case 83:if($=e.sent,t.ventResult=$,"factura"!==$.documento.type){e.next=91;break}return e.next=88,tr.countDocuments({tipoComprobante:1});case 88:t.count=e.sent,e.next=95;break;case 91:if("boleta"!==$.documento.type){e.next=95;break}return e.next=94,tr.countDocuments({tipoComprobante:2});case 94:t.count=e.sent;case 95:if(!t.body.venta.guia){e.next=99;break}return e.next=98,Zn.countDocuments({guia:{$eq:!0}});case 98:t.countGuia=e.sent;case 99:return e.next=101,Xn.findOneAndUpdate({username:t.user.aud.split(" ")[0]},{$pull:{ventaActiva:t.body.venta.codigo}},{useFindAndModify:!1});case 101:return e.next=103,Ln($);case 103:return e.next=105,a.commitTransaction();case 105:a.endSession(),r(),e.next=116;break;case 109:return e.prev=109,e.t3=e.catch(4),console.log(e.t3),e.next=114,a.abortTransaction();case 114:return a.endSession(),e.abrupt("return",n.status(500).json({message:e.t3}));case 116:case"end":return e.stop()}}),e,null,[[4,109],[18,75,78,81],[24,56,59,62],[33,46,49,52]])})));return function(t,n,r){return e.apply(this,arguments)}}(),yr=function(){var e=A()(_().mark((function e(t,n){return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Zn.findOneAndUpdate({codigo:t.body.venta.codigo},{estado:"anulada"},{useFindAndModify:!1});case 3:return e.next=5,Xn.findOneAndUpdate({username:t.user.aud.split(" ")[0]},{$pull:{ventaActiva:t.body.venta.codigo}},{useFindAndModify:!1});case 5:n.json({message:"success"}),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),br=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,void 0!==t.sunat.enlace_del_pdf){e.next=3;break}return e.abrupt("return",n.status(500).json({message:"No se pudo generar el comprobante"}));case 3:return e.next=5,Zn.findByIdAndUpdate(t.ventResult._id,{numero:t.sunat.numero,serie:t.sunat.serie,tipoComprobante:t.sunat.tipo_de_comprobante,linkComprobante:t.sunat.enlace_del_pdf},{new:!0,useFindAndModify:!1});case 5:return r=e.sent,a=new tr({numero:t.sunat.numero,serie:t.sunat.serie,tipoComprobante:t.sunat.tipo_de_comprobante,ventaCod:t.ventResult.codigo,linkComprobante:t.sunat.enlace_del_pdf}),e.next=9,a.save();case 9:return e.abrupt("return",n.json({venta:r,message:"Success||".concat(t.ventResult.codigo),_sunat:t.sunat}));case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t,n){return e.apply(this,arguments)}}(),hr=function(){var e=A()(_().mark((function e(t){var n,r,a,o;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Zn.countDocuments({});case 3:e.t0=e.sent,n=e.t0+1,r="SD01-000000",e.t1=t,e.next="factura"===e.t1?9:"boleta"===e.t1?11:13;break;case 9:return r="E002-000000",e.abrupt("break",14);case 11:return r="EB02-000000",e.abrupt("break",14);case 13:return e.abrupt("break",14);case 14:for(a=0;a<n.toString().length;a++)r=r.slice(0,-1);return o=r+n.toString(),e.abrupt("return",o);case 19:return e.prev=19,e.t2=e.catch(0),e.abrupt("return",res.status(500).json({message:e.t2}));case 22:case"end":return e.stop()}}),e,null,[[0,19]])})));return function(t){return e.apply(this,arguments)}}(),vr=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.findOne({codigo:t.body.codigo});case 3:if(r=e.sent,t.body.tipo){e.next=8;break}if(!(r.cantidad-t.body.cantidad<0)){e.next=8;break}throw"Cantidad Invalidad";case 8:return a=t.body.cantidad,o={date:Date.now(),cantidad:a,tipo:t.body.tipo,comentario:t.body.tipo?"agregar|"+t.body.comentario:"quitar|"+t.body.comentario,costoVar:t.body.costoVar*a,cantidadSC:[]},e.next=12,Yn.findOneAndUpdate({codigo:t.body.codigo},{$inc:{cantidad:t.body.tipo?t.body.cantidad:-1*t.body.cantidad},$push:{variaciones:o}},{new:!0,useFindAndModify:!1});case 12:i=e.sent,n.json(i),e.next=19;break;case 16:return e.prev=16,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 19:case"end":return e.stop()}}),e,null,[[0,16]])})));return function(t,n){return e.apply(this,arguments)}}(),$r=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s,c,d,u,p,l,m;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=0,e.next=4,Yn.findOne({codigo:t.body.codigo});case 4:a=e.sent,r=t.body.cantidad,o={date:Date.now(),cantidad:r,tipo:t.body.tipo,comentario:t.body.tipo?"agregar|"+t.body.comentario:"quitar|"+t.body.comentario,costoVar:t.body.costoVar*r,cantidadSC:[]},i=[],s=Jn(a.subConteo.order),e.prev=9,d=_().mark((function e(){var n;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=c.value,-1!==t.body.subConteo.order.findIndex((function(e){return e.name===n.name&&e.nameSecond===n.nameSecond}))&&i.push(n);case 3:case"end":return e.stop()}}),e)})),s.s();case 12:if((c=s.n()).done){e.next=16;break}return e.delegateYield(d(),"t0",14);case 14:e.next=12;break;case 16:e.next=21;break;case 18:e.prev=18,e.t1=e.catch(9),s.e(e.t1);case 21:return e.prev=21,s.f(),e.finish(21);case 24:a.subConteo.order=i,u=Jn(t.body.subConteo.order),e.prev=26,l=_().mark((function e(){var n,r,i;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=p.value,r=a.subConteo.order.findIndex((function(e){return e.name===n.name&&e.nameSecond===n.nameSecond})),i=r>-1?a.subConteo.order[r].cantidad:0,!(r>-1)){e.next=13;break}if(!t.body.tipo){e.next=8;break}a.subConteo.order[r].cantidad+=n.cantidad,e.next=11;break;case 8:if(a.subConteo.order[r].cantidad-=n.cantidad,!(a.subConteo.order[r].cantidad<0)){e.next=11;break}throw"Cantidad Invalidad";case 11:e.next=14;break;case 13:a.subConteo.order.push({cantidad:n.cantidad,name:n.name,nameSecond:n.nameSecond||void 0});case 14:o.cantidadSC.push({name:n.name,nameSecond:n.nameSecond,cantidadDisponible:i,cantidadVenta:n.cantidad});case 15:case"end":return e.stop()}}),e)})),u.s();case 29:if((p=u.n()).done){e.next=33;break}return e.delegateYield(l(),"t2",31);case 31:e.next=29;break;case 33:e.next=38;break;case 35:e.prev=35,e.t3=e.catch(26),u.e(e.t3);case 38:return e.prev=38,u.f(),e.finish(38);case 41:if(t.body.tipo){e.next=45;break}if(!(a.cantidad-t.body.cantidad<0)){e.next=45;break}return e.abrupt("return",n.status(400).json({message:"Cantidad Invalidad"}));case 45:return e.next=47,Yn.findOneAndUpdate({codigo:t.body.codigo},{subConteo:a.subConteo,$inc:{cantidad:t.body.tipo?t.body.cantidad:-1*t.body.cantidad},$push:{variaciones:o}},{new:!0,useFindAndModify:!1});case 47:m=e.sent,n.json(m),e.next=54;break;case 51:return e.prev=51,e.t4=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t4}));case 54:case"end":return e.stop()}}),e,null,[[0,51],[9,18,21,24],[26,35,38,41]])})));return function(t,n){return e.apply(this,arguments)}}(),xr=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=new er(t.body),e.next=4,r.save();case 4:return a=e.sent,e.abrupt("return",n.json(a));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),wr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,er.updateMany({name:{$in:t.body}},{deleted:!0});case 3:return r=e.sent,e.abrupt("return",n.json(r));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Sr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,er.find({deleted:!1});case 3:return r=e.sent,e.abrupt("return",n.json(r));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Cr=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,(r=new Qn(t.body)).codigo=Date.now().toString(),e.next=5,r.save();case 5:return a=e.sent,e.abrupt("return",n.json(a));case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 12:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t,n){return e.apply(this,arguments)}}(),Vr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.aggregate([{$match:{codigo:"4SDtT4"}},{$project:{cantidadTotal:{$sum:"$subConteo.order.cantidad"}}}]);case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),kr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=t.params.deleteString.split("_"),e.next=4,Qn.deleteMany({name:{$in:r}});case 4:n.json({message:"success"}),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Tr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Qn.find({});case 3:r=e.sent,n.json(r),e.next=9;break;case 7:e.prev=7,e.t0=e.catch(0);case 9:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),jr=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s,c;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,(r=new Yn(t.body)).priceNoIGV=Mr(r.priceIGV),e.next=5,Nr(r.name,r.tipo);case 5:if(r.codigo=e.sent,r.nameLowerCase=r.name,a={date:Date.now(),cantidad:r.cantidad,tipo:!0,comentario:"new item",costoVar:Math.round(100*(r.costoPropio*r.cantidad+Number.EPSILON))/100,cantidadSC:[]},r.subConteo){o=Jn(r.subConteo.order);try{for(o.s();!(i=o.n()).done;)s=i.value,a.cantidadSC.push({name:s.name,nameSecond:s.nameSecond,cantidadDisponible:s.cantidad,cantidadVenta:0})}catch(e){o.e(e)}finally{o.f()}}return r.variaciones=[a],e.next=12,r.save();case 12:return c=e.sent,e.abrupt("return",n.json(c));case 16:return e.prev=16,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 19:case"end":return e.stop()}}),e,null,[[0,16]])})));return function(t,n){return e.apply(this,arguments)}}(),Nr=function(){var e=A()(_().mark((function e(){var t,n,r,a=arguments;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:"",n=a.length>1&&void 0!==a[1]?a[1]:"",e.prev=2,e.next=5,Yn.countDocuments({});case 5:return r=e.sent,e.abrupt("return",r.toString()+"SD"+t.charAt(0)+n.charAt(0)+Math.floor(10*Math.random()).toString());case 9:return e.prev=9,e.t0=e.catch(2),e.abrupt("return",new Error(e.t0));case 12:case"end":return e.stop()}}),e,null,[[2,9]])})));return function(){return e.apply(this,arguments)}}(),Or=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.find({deleted:!1}).sort({orderNumber:1});case 3:return r=e.sent,e.abrupt("return",n.json(r));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Ar=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.findOneAndUpdate({codigo:t.body.codigo},{oferta:1},{new:!0,useFindAndModify:!1});case 3:return r=e.sent,e.abrupt("return",n.json(r));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Ir=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.findOneAndUpdate({codigo:t.body.codigo},{oferta:0},{new:!0,useFindAndModify:!1});case 3:return r=e.sent,e.abrupt("return",n.json(r));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),_r=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.find({tipo:t.params.tipo,deleted:!1});case 3:return r=e.sent,e.abrupt("return",n.json(r));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Pr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.find({subTipo:t.params.subTipo,tipo:t.params.tipo,deleted:!1}).sort({orderNumber:1});case 3:return r=e.sent,e.abrupt("return",n.json(r));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Er=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r={},e.prev=1,e.t0=t.params.tipo,e.next="cod"===e.t0?5:"name"===e.t0?9:"tipo"===e.t0?13:17;break;case 5:return e.next=7,Yn.findOne({codigo:t.params.codigo});case 7:case 11:case 15:return r=e.sent,e.abrupt("break",19);case 9:return e.next=11,Yn.find({name:t.body.name});case 13:return e.next=15,Yn.find({tipo:t.body.tipo});case 17:return r={message:"Not A Type Of Search"},e.abrupt("break",19);case 19:return e.abrupt("return",n.json(r));case 22:return e.prev=22,e.t1=e.catch(1),e.abrupt("return",n.status(500).json({message:e.t1}));case 25:case"end":return e.stop()}}),e,null,[[1,22]])})));return function(t,n){return e.apply(this,arguments)}}(),Dr=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,(r=t.body).priceIGV&&(r.priceNoIGV=Mr(r.priceIGV)),e.next=5,Yn.findOneAndUpdate({codigo:t.body.codigo},r,{new:!0,useFindAndModify:!1});case 5:a=e.sent,n.json(a),e.next=12;break;case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 12:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t,n){return e.apply(this,arguments)}}(),qr=function(){var e=A()(_().mark((function e(t,n,r){var a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.findOneAndUpdate({codigo:t.params.codigo},{deleted:!0},{new:!0,useFindAndModify:!1});case 3:a=e.sent,t.result=a,t.photNameToDelete=a.photo,r(),e.next=12;break;case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 12:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t,n,r){return e.apply(this,arguments)}}(),Gr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.findOneAndUpdate({codigo:t.params.codigo},{photo:t.fileName},{new:!0,useFindAndModify:!1});case 3:r=e.sent,n.status(200).json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Mr=function(e){var t=e/1.18;return Math.round(100*(t+Number.EPSILON))/100},Rr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.findOneAndUpdate({codigo:t.params.codigo},{ficha:!0},{new:!0,useFindAndModify:!1});case 3:r=e.sent,n.status(200).json({res:r,uploadInfo:t.uploadInfo}),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Lr=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,r=[],a=t.gananciaPorItem.filter((function(e){return!(6===e.name.length&&"N"===e.name.split("")[2]&&"I"===e.name.split("")[3])})).slice(0,4),-1!==(o=a.findIndex((function(e){return"3SDKP7"===e.name})))?a.splice(o,1):a.pop(),i=0;case 6:if(!(i<a.length)){e.next=15;break}return e.next=9,Yn.findOne({codigo:a[i].name});case 9:s=e.sent,a[i].name=s.name,r.push({name:a[i].name,series:[{name:"Ventas",value:a[i].totalVenta},{name:"Ganancias",value:a[i].value}]});case 12:i++,e.next=6;break;case 15:n.json(r),e.next=21;break;case 18:return e.prev=18,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 21:case"end":return e.stop()}}),e,null,[[0,18]])})));return function(t,n){return e.apply(this,arguments)}}(),Ur=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.aggregate([{$match:{deleted:!1}},{$project:{_id:0,codigo:1,name:1,variaciones:1}},{$unwind:"$variaciones"},{$match:{"variaciones.tipo":!1}},{$project:{variaciones:1,codVar:{$split:["$variaciones.comentario","|"]}}},{$project:{variaciones:1,firstPartVar:{$arrayElemAt:["$codVar",0]}}},{$match:{firstPartVar:"quitar"}},{$group:{_id:null,totalVarQuitar:{$sum:"$variaciones.costoVar"}}}]);case 3:return r=e.sent,e.next=6,Yn.aggregate([{$match:{deleted:!1}},{$project:{_id:0,codigo:1,name:1,variaciones:1}},{$unwind:"$variaciones"},{$match:{"variaciones.tipo":!0}},{$group:{_id:{codigo:"$codigo",name:"$name"},posVar:{$sum:"$variaciones.costoVar"}}},{$project:{_id:0,codigo:"$_id.codigo",name:"$_id.name",posVar:1}},{$sort:{name:1}},{$group:{_id:null,totalVarPos:{$sum:"$posVar"}}}]);case 6:return a=e.sent,e.next=9,Yn.aggregate([{$match:{deleted:!1}},{$project:{_id:0,codigo:1,name:1,variaciones:1}},{$unwind:"$variaciones"},{$match:{"variaciones.tipo":!1}},{$group:{_id:{codigo:"$codigo",name:"$name"},posVar:{$sum:"$variaciones.costoVar"}}},{$project:{_id:0,codigo:"$_id.codigo",name:"$_id.name",posVar:1}},{$sort:{name:1}},{$group:{_id:null,totalVarNeg:{$sum:"$posVar"}}}]);case 9:return o=e.sent,e.next=12,Yn.aggregate([{$match:{deleted:!1}},{$project:{_id:0,codigo:1,name:1,variaciones:1}},{$unwind:"$variaciones"},{$match:{"variaciones.tipo":!0}},{$project:{variaciones:1,codVar:{$split:["$variaciones.comentario","|"]}}},{$project:{variaciones:1,firstPartVar:{$arrayElemAt:["$codVar",0]}}},{$match:{firstPartVar:"anular"}},{$group:{_id:null,totalVarAnular:{$sum:"$variaciones.costoVar"}}}]);case 12:i=e.sent,n.json({gastosInventario:a[0].totalVarPos-((r[0]?r[0].totalVarQuitar:0)+(i[0]?i[0].totalVarAnular:0)),gananciasInventario:o[0].totalVarNeg-((r[0]?r[0].totalVarQuitar:0)+(i[0]?i[0].totalVarAnular:0))}),e.next=19;break;case 16:return e.prev=16,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 19:case"end":return e.stop()}}),e,null,[[0,16]])})));return function(t,n){return e.apply(this,arguments)}}(),Br=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.aggregate([{$match:{deleted:!1}},{$project:{_id:0,codigo:1,name:1,variaciones:1}},{$unwind:"$variaciones"},{$match:{"variaciones.tipo":!1}},{$project:{variaciones:1,codVar:{$split:["$variaciones.comentario","|"]}}},{$project:{variaciones:1,firstPartVar:{$arrayElemAt:["$codVar",0]}}},{$match:{firstPartVar:"quitar"}},{$group:{_id:null,totalVarQuitar:{$sum:"$variaciones.costoVar"}}}]);case 3:return r=e.sent,e.next=6,Yn.aggregate([{$match:{deleted:!1}},{$project:{_id:0,codigo:1,name:1,variaciones:1}},{$unwind:"$variaciones"},{$match:{"variaciones.tipo":!0}},{$project:{variaciones:1,codVar:{$split:["$variaciones.comentario","|"]}}},{$project:{variaciones:1,firstPartVar:{$arrayElemAt:["$codVar",0]}}},{$match:{firstPartVar:"anular"}},{$group:{_id:null,totalVarAnular:{$sum:"$variaciones.costoVar"}}}]);case 6:return a=e.sent,e.next=9,Yn.aggregate([{$match:{deleted:!1}},{$project:{_id:0,codigo:1,name:1,variaciones:1}},{$unwind:"$variaciones"},{$match:{"variaciones.tipo":!0}},{$group:{_id:{codigo:"$codigo",name:"$name"},posVar:{$sum:"$variaciones.costoVar"}}},{$project:{_id:0,codigo:"$_id.codigo",name:"$_id.name",posVar:1}},{$sort:{name:1}},{$group:{_id:null,totalVarPos:{$sum:"$posVar"}}}]);case 9:return o=e.sent,e.next=12,Zn.aggregate([{$match:{date:{$gte:new Date("2021-01-01")},estado:"ejecutada"}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$project:{codigo:1,codArray:{$split:["$codigo","NI"]},totalPrice:1,codSize:{$strLenCP:"$codigo"},costoTotalPropio:{$multiply:["$priceCosto","$cantidad"]}}},{$match:{codSize:6}},{$set:{arrayCodSize:{$size:"$codArray"}}},{$match:{arrayCodSize:2}},{$project:{codigo:1,costoTotalPropio:1,totalPrice:1,primeraParteLen:{$strLenCP:{$arrayElemAt:["$codArray",0]}},segundaParteLen:{$strLenCP:{$arrayElemAt:["$codArray",0]}}}},{$match:{primeraParteLen:2,segundaParteLen:2}},{$group:{_id:null,costoTotalPropio:{$sum:"$costoTotalPropio"},ingresoTotal:{$sum:"$totalPrice"}}}]);case 12:return i=e.sent,e.next=15,Yn.aggregate([{$match:{deleted:!1}},{$project:{_id:0,codigo:1,name:1,variaciones:1}},{$unwind:"$variaciones"},{$match:{"variaciones.tipo":!1}},{$group:{_id:{codigo:"$codigo",name:"$name"},posVar:{$sum:"$variaciones.costoVar"}}},{$project:{_id:0,codigo:"$_id.codigo",name:"$_id.name",posVar:1}},{$sort:{name:1}},{$group:{_id:null,totalVarNeg:{$sum:"$posVar"}}}]);case 15:s=e.sent,n.json({gastoTotalHistorico:o[0].totalVarPos-((r[0]?r[0].totalVarQuitar:0)+(a[0]?a[0].totalVarAnular:0))+i[0].costoTotalPropio,ingresoTotalHistorico:s[0].totalVarNeg-((r[0]?r[0].totalVarQuitar:0)+(a[0]?a[0].totalVarAnular:0))+i[0].ingresoTotal}),e.next=22;break;case 19:return e.prev=19,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 22:case"end":return e.stop()}}),e,null,[[0,19]])})));return function(t,n){return e.apply(this,arguments)}}(),Fr=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.aggregate([{$match:{deleted:!1}},{$project:{_id:0,cantidad:1,priceIGV:1,total:{$multiply:["$priceIGV","$cantidad"]}}},{$group:{_id:null,totalPotencial:{$sum:"$total"}}}]);case 3:return r=e.sent,e.next=6,Yn.aggregate([{$match:{deleted:!1}},{$project:{_id:0,cantidad:1,costoPropio:1,total:{$multiply:["$costoPropio","$cantidad"]}}},{$group:{_id:null,totalPotencial:{$sum:"$total"}}}]);case 6:a=e.sent,n.json({ventasPosibles:r[0].totalPotencial,costoPropioTotalAprox:a[0].totalPotencial,gananciaAprox:r[0].totalPotencial-a[0].totalPotencial}),e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,n){return e.apply(this,arguments)}}(),zr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.aggregate([{$match:{deleted:!1}},{$unwind:"$variaciones"},{$project:{_id:0,codigo:1,name:1,variaciones:1,costoVarTrue:{$cond:[{$eq:["$variaciones.tipo",!0]},"$variaciones.costoVar",0]},costoVarFalse:{$cond:[{$eq:["$variaciones.tipo",!1]},"$variaciones.costoVar",0]}}},{$group:{_id:{name:"$name",codigo:"$codigo"},totalTrue:{$sum:"$costoVarTrue"},totalFalse:{$sum:"$costoVarFalse"}}},{$project:{_id:0,name:"$_id.name",codigo:"$_id.codigo",totalTrue:1,totalFalse:1,balance:{$subtract:["$totalFalse","$totalTrue"]}}},{$sort:{balance:1}}]);case 3:r=e.sent,n.json({peor:r[0],mejor:r[r.length-1]}),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Wr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.aggregate([{$match:{deleted:!1}},{$project:{codigo:1,name:1,cantidad:1,costoPropio:1,priceIGV:1,totalIngreso:{$multiply:["$cantidad","$priceIGV"]},totalCosto:{$multiply:["$cantidad","$costoPropio"]}}},{$project:{codigo:1,name:1,cantidad:1,costoPropio:1,priceIGV:1,balance:{$subtract:["$totalIngreso","$totalCosto"]}}}]).sort({balance:-1}).limit(1);case 3:r=e.sent,n.json(r[0]),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Kr=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Zn.aggregate([{$match:{date:{$gte:new Date("2021-01-01")},estado:"ejecutada"}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$project:{codigo:1,codArray:{$split:["$codigo","NI"]},totalPrice:1,codSize:{$strLenCP:"$codigo"},costoTotalPropio:{$multiply:["$priceCosto","$cantidad"]}}},{$match:{codSize:6}},{$set:{arrayCodSize:{$size:"$codArray"}}},{$match:{arrayCodSize:2}},{$project:{codigo:1,costoTotalPropio:1,totalPrice:1,primeraParteLen:{$strLenCP:{$arrayElemAt:["$codArray",0]}},segundaParteLen:{$strLenCP:{$arrayElemAt:["$codArray",1]}}}},{$match:{primeraParteLen:2,segundaParteLen:2}},{$group:{_id:null,costoTotalPropio:{$sum:"$costoTotalPropio"},ingresoTotal:{$sum:"$totalPrice"}}}]);case 3:return r=e.sent,e.next=6,Zn.aggregate([{$match:{date:{$gte:new Date("2021-01-01")},estado:"ejecutada"}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$project:{codigo:1,totalPrice:1,costoTotalPropio:{$multiply:["$priceCosto","$cantidad"]}}},{$group:{_id:null,costoTotalPropio:{$sum:"$costoTotalPropio"},ingresoTotal:{$sum:"$totalPrice"}}}]);case 6:a=e.sent,n.json({gananciaEnVentasFueraTienda:r[0].ingresoTotal-r[0].costoTotalPropio,gananciaEnVentas:a[0].ingresoTotal-a[0].costoTotalPropio,gananciaEnVentasDeTienda:a[0].ingresoTotal-r[0].ingresoTotal-(a[0].costoTotalPropio-r[0].costoTotalPropio)}),e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,n){return e.apply(this,arguments)}}(),Jr=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Zn.aggregate([{$match:{date:{$gte:new Date("2021-01-01")},estado:"ejecutada"}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$group:{_id:"$codigo",cantidad:{$sum:1}}},{$sort:{cantidad:-1}}]);case 3:return r=e.sent,e.next=6,Yn.findOne({codigo:r[0]._id});case 6:a=e.sent,n.json(a),e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,n){return e.apply(this,arguments)}}(),Hr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Zn.aggregate([{$match:{date:{$gte:new Date("2021-01-01")},estado:"ejecutada"}},{$unwind:"$documento"},{$replaceRoot:{newRoot:"$documento"}},{$match:{codigo:{$ne:null}}},{$group:{_id:{codigo:"$codigo",name:"$name"},cantidad:{$sum:1}}},{$sort:{cantidad:-1}}]);case 3:r=e.sent,n.json({cliente:r[0]._id.name,numero:r[0].cantidad}),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Yr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.findOneAndUpdate({codigo:t.body.itemCod},{$pull:{caracteristicas:{$in:t.body.deleteArray}}},{useFindAndModify:!1,new:!0});case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Qr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.findOneAndUpdate({codigo:t.body.itemCod},{$push:{caracteristicas:t.body.newCaracteristica}},{useFindAndModify:!1,new:!0});case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Zr=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W().startSession();case 2:return(r=e.sent).startTransaction(),e.prev=4,e.next=7,Yn.countDocuments({deleted:!1,subTipo:t.body.itemReOrder[0].subTipo,tipo:t.body.itemReOrder[0].tipo});case 7:if(e.sent===t.body.itemReOrder.length){e.next=10;break}throw"Variacion Invalida";case 10:a=0;case 11:if(!(a<t.body.itemReOrder.length)){e.next=17;break}return e.next=14,Yn.findOneAndUpdate({codigo:t.body.itemReOrder[a].codigo},{orderNumber:a},{useFindAndModify:!1});case 14:a++,e.next=11;break;case 17:return e.next=19,r.commitTransaction();case 19:r.endSession(),n.json({message:"done"}),e.next=29;break;case 23:return e.prev=23,e.t0=e.catch(4),e.next=27,r.abortTransaction();case 27:return r.endSession(),e.abrupt("return",n.status(500).json({message:e.t0}));case 29:case"end":return e.stop()}}),e,null,[[4,23]])})));return function(t,n){return e.apply(this,arguments)}}(),Xr=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.find({deleted:!1,$and:[{cantidad:{$lt:5}},{cantidad:{$gt:0}}]});case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),ea=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.find({deleted:!1,cantidad:0});case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),ta=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.aggregate([{$match:{codigo:t.params.codigoItem}},{$unwind:"$variaciones"},{$project:{variaciones:1,codVar:{$split:["$variaciones.comentario","|"]}}},{$set:{firstPartVar:{$arrayElemAt:["$codVar",0]}}},{$set:{cantidadVarNI:{$cond:[{$eq:["$firstPartVar","new item"]},"$variaciones.cantidad",0]},cantidadVarQuitar:{$cond:[{$eq:["$firstPartVar","quitar"]},"$variaciones.cantidad",0]},cantidadVarAgregar:{$cond:[{$eq:["$firstPartVar","agregar"]},"$variaciones.cantidad",0]},cantidadVarAnular:{$cond:[{$eq:["$firstPartVar","anular"]},"$variaciones.cantidad",0]},cantidadVarVenta:{$cond:[{$eq:["$firstPartVar","venta"]},"$variaciones.cantidad",0]}}},{$group:{_id:null,totalCantidadNI:{$sum:"$cantidadVarNI"},totalCantidadQuitar:{$sum:"$cantidadVarQuitar"},totalCantidadAgregar:{$sum:"$cantidadVarAgregar"},totalCantidadVenta:{$sum:"$cantidadVarVenta"},totalCantidadAnular:{$sum:"$cantidadVarAnular"}}}]);case 3:return r=e.sent,e.next=6,Yn.aggregate([{$match:{codigo:t.params.codigoItem}},{$unwind:"$variaciones"},{$project:{_id:0,codigo:1,name:1,variaciones:1,costoVarTrue:{$cond:[{$eq:["$variaciones.tipo",!0]},"$variaciones.costoVar",0]},costoVarFalse:{$cond:[{$eq:["$variaciones.tipo",!1]},"$variaciones.costoVar",0]}}},{$group:{_id:{name:"$name",codigo:"$codigo"},totalTrue:{$sum:"$costoVarTrue"},totalFalse:{$sum:"$costoVarFalse"}}}]);case 6:return a=e.sent,e.next=9,Yn.aggregate([{$match:{codigo:t.params.codigoItem}},{$project:{_id:0,codigo:1,name:1,variaciones:1}},{$unwind:"$variaciones"},{$match:{"variaciones.tipo":!1}},{$project:{variaciones:1,codVar:{$split:["$variaciones.comentario","|"]}}},{$project:{variaciones:1,firstPartVar:{$arrayElemAt:["$codVar",0]}}},{$match:{firstPartVar:"quitar"}},{$group:{_id:null,totalVarQuitar:{$sum:"$variaciones.costoVar"}}}]);case 9:return o=e.sent,e.next=12,Yn.aggregate([{$match:{codigo:t.params.codigoItem}},{$project:{_id:0,codigo:1,name:1,variaciones:1}},{$unwind:"$variaciones"},{$match:{"variaciones.tipo":!0}},{$project:{variaciones:1,codVar:{$split:["$variaciones.comentario","|"]}}},{$project:{variaciones:1,firstPartVar:{$arrayElemAt:["$codVar",0]}}},{$match:{firstPartVar:"anular"}},{$group:{_id:null,totalVarAnular:{$sum:"$variaciones.costoVar"}}}]);case 12:i=e.sent,n.json({itemVendidos:r[0].totalCantidadVenta-r[0].totalCantidadAnular,cantidadHistorica:r[0].totalCantidadNI+r[0].totalCantidadAgregar-r[0].totalCantidadQuitar,totalCosto:a[0].totalTrue-((o[0]?o[0].totalVarQuitar:0)+(i[0]?i[0].totalVarAnular:0)),totalIngreso:a[0].totalFalse-((o[0]?o[0].totalVarQuitar:0)+(i[0]?i[0].totalVarAnular:0))}),e.next=19;break;case 16:return e.prev=16,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 19:case"end":return e.stop()}}),e,null,[[0,16]])})));return function(t,n){return e.apply(this,arguments)}}(),na=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.aggregate([{$match:{codigo:t.params.codigoItem}},{$unwind:"$variaciones"},{$project:{variaciones:1,codVar:{$split:["$variaciones.comentario","|"]}}},{$set:{firstPartVar:{$arrayElemAt:["$codVar",0]}}},{$set:{cantidadVarAnular:{$cond:[{$eq:["$firstPartVar","anular"]},"$variaciones.cantidad",0]},cantidadVarVenta:{$cond:[{$eq:["$firstPartVar","venta"]},"$variaciones.cantidad",0]},dateVar:{$dateToString:{format:"%Y-%m",date:"$variaciones.date",timezone:"-05:00"}}}},{$group:{_id:"$dateVar",valueVenta:{$sum:"$cantidadVarVenta"},valueAnular:{$sum:"$cantidadVarAnular"}}},{$project:{_id:0,name:"$_id",value:{$subtract:["$valueVenta","$valueAnular"]}}},{$sort:{name:1}}]);case 3:r=e.sent,a=[{name:"Cantidad",series:r}],n.json(a),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),ra=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Yn.aggregate([{$match:{deleted:!1}},{$unwind:"$variaciones"},{$project:{name:1,codigo:1,cantidad:1,variaciones:1,priceIGV:1,costoPropio:1,codVar:{$split:["$variaciones.comentario","|"]}}},{$set:{firstPartVar:{$arrayElemAt:["$codVar",0]}}},{$set:{cantidadVarAgregar:{$cond:[{$eq:["$firstPartVar","agregar"]},"$variaciones.costoVar",0]},cantidadVarNewItem:{$cond:[{$eq:["$firstPartVar","new item"]},"$variaciones.costoVar",0]},cantidadVarQuitar:{$cond:[{$eq:["$firstPartVar","quitar"]},"$variaciones.costoVar",0]},cantidadVarAnular:{$cond:[{$eq:["$firstPartVar","anular"]},"$variaciones.costoVar",0]},cantidadVarVenta:{$cond:[{$eq:["$firstPartVar","venta"]},"$variaciones.costoVar",0]}}},{$group:{_id:{name:"$name",codigo:"$codigo",cantidad:"$cantidad",priceIGV:"$priceIGV",costoPropio:"$costoPropio"},valueAgregar:{$sum:"$cantidadVarAgregar"},valueVenta:{$sum:"$cantidadVarVenta"},valueAnular:{$sum:"$cantidadVarAnular"},valueNewItem:{$sum:"$cantidadVarNewItem"},valueQuitar:{$sum:"$cantidadVarQuitar"}}},{$project:{_id:0,name:"$_id.name",codigo:"$_id.codigo",cantidad:"$_id.cantidad",priceIGV:"$_id.priceIGV",costoPropio:"$_id.costoPropio",valueQuitar:1,preValueGasto:{$sum:["$valueAgregar","$valueNewItem"]},valueIngreso:{$subtract:["$valueVenta","$valueAnular"]}}},{$project:{_id:0,name:1,codigo:1,cantidad:1,priceIGV:1,costoPropio:1,valueGasto:{$subtract:["$preValueGasto","$valueQuitar"]},valueIngreso:1}},{$sort:{valueIngreso:-1}}]);case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),aa=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t.body.rating<=5&&t.body.rating>=1){e.next=3;break}return e.abrupt("return",n.status(400).json({message:"Rating no valido"}));case 3:return e.next=5,Yn.aggregate([{$match:{codigo:t.body.codigo}},{$unwind:"$variaciones"},{$match:{"variaciones.usuario":t.user.aud.split(" ")[0]}},{$limit:4}]);case 5:if(0!==e.sent.length){e.next=8;break}return e.abrupt("return",n.status(403).json({message:"No has comprado el item."}));case 8:return r=new Date,e.next=11,Yn.findOne({codigo:t.body.codigo});case 11:if(a=e.sent,o=!1,a.reviews.length>0&&(o=a.reviews.some((function(e){return e.user===t.user.aud.split(" ")[0]}))),!o){e.next=19;break}return e.next=17,Yn.findOneAndUpdate({codigo:t.body.codigo,"reviews.user":t.user.aud.split(" ")[0]},{$set:{"reviews.$.date":r.toISOString(),"reviews.$.rating":t.body.rating}},{new:!0,useFindAndModify:!1});case 17:return i=e.sent,e.abrupt("return",n.json(i));case 19:return e.next=21,Yn.findOneAndUpdate({codigo:t.body.codigo},{$push:{reviews:{user:t.user.aud.split(" ")[0],rating:t.body.rating,date:r.toISOString()}}},{new:!0,useFindAndModify:!1});case 21:return s=e.sent,e.abrupt("return",n.json(s));case 25:return e.prev=25,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 28:case"end":return e.stop()}}),e,null,[[0,25]])})));return function(t,n){return e.apply(this,arguments)}}();const oa=new z.Schema({name:{type:String,required:!0,unique:!0,trim:!0},date:{type:Date,default:Date.now},codigo:{type:String},subTipo:{type:[String],trim:!0},subTipoLink:{type:[String],trim:!0},deleted:{type:Boolean,default:!1},link:{type:String,default:"noPhoto.jpg"},order:{type:Number,default:-1}});var ia=W().model("Tipo",oa),sa=W().model("Item",Ue),ca=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s,c,d;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,(r=new Date).setDate(r.getDate()-7),e.next=5,ia.find({deleted:!1});case 5:return a=e.sent,e.next=8,sa.find({deleted:!1});case 8:for(o=e.sent,i=[{url:"store/main",priority:1,changefreq:"monthly"},{url:"servicio-al-cliente/contactanos",priority:.8,changefreq:"monthly"},{url:"carrito",priority:.7,changefreq:"monthly"},{url:"servicio-al-cliente/terminos-y-condiciones",priority:.3,changefreq:"monthly"},{url:"servicio-al-cliente/politica-de-privacidad",priority:.3,changefreq:"monthly"},{url:"servicio-al-cliente/politica-de-devolucion",priority:.3,changefreq:"monthly"},{url:"servicio-al-cliente/politica-de-envio",priority:.3,changefreq:"monthly"},{url:"/",priority:1,changefreq:"monthly"},{url:"store/categorias",priority:.9,changefreq:"weekly"}],s=0;s<a.length;s++)for(i.push({url:"store/categorias/"+a[s].name,priority:.7,changefreq:"daily"}),c=0;c<a[s].subTipo.length;c++)i.push({url:"store/categorias/"+a[s].name+"/"+a[s].subTipo[c],priority:.6,changefreq:"daily"});for(d=0;d<o.length;d++)i.push({url:"store/categorias/"+o[d].tipo+"/"+o[d].subTipo+"/"+o[d].codigo,priority:.5,changefreq:"daily"});n.json(i),e.next=18;break;case 15:return e.prev=15,e.t0=e.catch(0),e.abrupt("return",n.status(500).end());case 18:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(t,n){return e.apply(this,arguments)}}(),da=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,(r=new ia(t.body)).codigo=Date.now().toString(),r.subTipo=[],e.next=6,r.save();case 6:return a=e.sent,e.abrupt("return",n.json(a));case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,n){return e.apply(this,arguments)}}(),ua=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ia.findOne({name:t.body.codigo});case 3:if(!((r=e.sent).subTipo.indexOf(t.body.subTipo)>-1)){e.next=6;break}return e.abrupt("return",n.json(null));case 6:return e.next=8,ia.updateOne({codigo:r.codigo},{$push:{subTipo:t.body.subTipo,subTipoLink:"noPhoto.jpg"}});case 8:return e.abrupt("return",n.json({message:"success"}));case 11:return e.prev=11,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 14:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(t,n){return e.apply(this,arguments)}}(),pa=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ia.find({deleted:!1}).sort({order:1});case 3:return r=e.sent,e.abrupt("return",n.json(r));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),la=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ia.findOne({name:t.params.tipoCod}).select("subTipo -_id");case 3:return r=e.sent,e.abrupt("return",n.json(r));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),ma=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ia.findOne({name:t.params.codigo});case 3:return r=e.sent,e.abrupt("return",n.json(r));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),ga=function(){var e=A()(_().mark((function e(t,n){var r,a,o;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W().startSession();case 2:return(r=e.sent).startTransaction(),e.prev=4,e.next=7,ia.findOne({codigo:t.body.codigo});case 7:return a=e.sent,t.beforeName=a.name,e.next=11,ia.findOneAndUpdate({codigo:t.body.codigo},{name:t.body.tipoName},{new:!0,useFindAndModify:!1});case 11:return o=e.sent,t.newTipo=o,e.next=15,sa.updateMany({tipo:t.beforeName},{tipo:t.body.tipoName},{new:!0,useFindAndModify:!1,runValidators:!0});case 15:return e.next=17,r.commitTransaction();case 17:r.endSession(),n.json(t.newTipo),e.next=27;break;case 21:return e.prev=21,e.t0=e.catch(4),e.next=25,r.abortTransaction();case 25:return r.endSession(),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 27:case"end":return e.stop()}}),e,null,[[4,21]])})));return function(t,n){return e.apply(this,arguments)}}(),fa=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W().startSession();case 2:return(r=e.sent).startTransaction(),e.prev=4,e.next=7,ia.findOne({name:t.body.codigo});case 7:if(!((a=e.sent).subTipo.indexOf(t.body.newSubName)>-1)){e.next=10;break}return e.abrupt("return",n.json(null));case 10:return o=a.subTipo.indexOf(t.body.antiguoSubName),a.subTipo[o]=t.body.newSubName,e.next=14,ia.findOneAndUpdate({name:t.body.codigo},{subTipo:a.subTipo},{new:!0,useFindAndModify:!1});case 14:return e.next=16,sa.updateMany({subTipo:t.body.antiguoSubName},{subTipo:t.body.newSubName},{new:!0,useFindAndModify:!1});case 16:return i=e.sent,e.next=19,r.commitTransaction();case 19:r.endSession(),n.json(i),e.next=29;break;case 23:return e.prev=23,e.t0=e.catch(4),e.next=27,r.abortTransaction();case 27:return r.endSession(),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 29:case"end":return e.stop()}}),e,null,[[4,23]])})));return function(t,n){return e.apply(this,arguments)}}(),ya=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W().startSession();case 2:return(r=e.sent).startTransaction(),e.prev=4,e.next=7,ia.findOne({name:t.params.codigo});case 7:return a=e.sent,o=a.subTipo.indexOf(t.params.subTipoName),a.subTipo.splice(o,1),e.next=12,ia.findOneAndUpdate({name:t.params.codigo},{subTipo:a.subTipo},{new:!0,useFindAndModify:!1});case 12:return e.next=14,sa.updateMany({subTipo:t.params.subTipoName},{deleted:!0});case 14:return i=e.sent,e.next=17,r.commitTransaction();case 17:return r.endSession(),e.abrupt("return",n.json(i));case 21:return e.prev=21,e.t0=e.catch(4),e.next=25,r.abortTransaction();case 25:return r.endSession(),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 27:case"end":return e.stop()}}),e,null,[[4,21]])})));return function(t,n){return e.apply(this,arguments)}}(),ba=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ia.findOneAndUpdate({codigo:t.params.codigo},{link:t.fileName},{new:!0,useFindAndModify:!1});case 3:r=e.sent,n.status(200).json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),ha=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ia.findOne({name:t.params.codigo});case 3:return r=e.sent,a=r.subTipo.findIndex((function(e){return e===t.params.subCat})),r.subTipoLink[a]=t.fileName,e.next=8,ia.findOneAndUpdate({name:t.params.codigo},{subTipoLink:r.subTipoLink},{new:!0,useFindAndModify:!1});case 8:e.sent,n.status(200).json({newPhoto:r.subTipoLink[a]}),e.next=15;break;case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t,n){return e.apply(this,arguments)}}(),va=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W().startSession();case 2:return(r=e.sent).startTransaction(),e.prev=4,e.next=7,ia.findOneAndUpdate({codigo:t.params.codigo},{deleted:!0},{new:!0,useFindAndModify:!1});case 7:return a=e.sent,t.tipoDeleted=a,e.next=11,sa.updateMany({tipo:t.tipoDeleted.name},{deleted:!0});case 11:return e.next=13,r.commitTransaction();case 13:r.endSession(),n.json(t.tipoDeleted),e.next=23;break;case 17:return e.prev=17,e.t0=e.catch(4),e.next=21,r.abortTransaction();case 21:return r.endSession(),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 23:case"end":return e.stop()}}),e,null,[[4,17]])})));return function(t,n){return e.apply(this,arguments)}}(),$a=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W().startSession();case 2:return(r=e.sent).startTransaction(),e.prev=4,e.next=7,ia.countDocuments({deleted:!1});case 7:if(e.sent===t.body.tiposReOrder.length){e.next=10;break}throw"Variacion Invalida";case 10:a=0;case 11:if(!(a<t.body.tiposReOrder.length)){e.next=17;break}return e.next=14,ia.findOneAndUpdate({codigo:t.body.tiposReOrder[a].codigo},{order:a},{useFindAndModify:!1});case 14:a++,e.next=11;break;case 17:return e.next=19,r.commitTransaction();case 19:r.endSession(),n.json({message:"done"}),e.next=29;break;case 23:return e.prev=23,e.t0=e.catch(4),e.next=27,r.abortTransaction();case 27:return r.endSession(),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 29:case"end":return e.stop()}}),e,null,[[4,23]])})));return function(t,n){return e.apply(this,arguments)}}(),xa=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ia.findOne({name:t.body.tipoCodigo});case 3:if(e.sent.subTipo.length===t.body.subTipoList.length){e.next=6;break}throw"Variacion Invalida";case 6:return e.next=8,ia.findOneAndUpdate({name:t.body.tipoCodigo},{subTipoLink:t.body.linksList,subTipo:t.body.subTipoList},{useFindAndModify:!1,new:!0});case 8:r=e.sent,n.json(r),e.next=15;break;case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t,n){return e.apply(this,arguments)}}(),wa=function(){var e=A()(_().mark((function e(t,n){var r,a,o;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W().startSession();case 2:return(r=e.sent).startTransaction(),e.prev=4,e.next=7,sa.findOneAndUpdate({codigo:t.body.codigo},{subTipo:t.body.newSubTipo,tipo:t.body.newTipo,orderNumber:-2},{useFindAndModify:!1,new:!0});case 7:return a=e.sent,e.next=10,ia.findOne({name:t.body.newTipo});case 10:if(null!==(o=e.sent)){e.next=13;break}throw"Tipo Ya No Existe";case 13:if(-1!==o.subTipo.indexOf(t.body.newSubTipo)){e.next=15;break}throw"Sub Tipo Ya No Existe";case 15:return e.next=17,r.commitTransaction();case 17:r.endSession(),n.json(a),e.next=27;break;case 21:return e.prev=21,e.t0=e.catch(4),e.next=25,r.abortTransaction();case 25:return r.endSession(),e.abrupt("return",n.status(500).json({errorMSG:e.t0}));case 27:case"end":return e.stop()}}),e,null,[[4,21]])})));return function(t,n){return e.apply(this,arguments)}}(),Sa=new $.Router;Sa.get("/getTipos",pa),Sa.get("/getTipo/:codigo",ma),Sa.get("/getSubTipos/:tipoCod",la),Sa.get("/getItem/:tipo/:codigo",Er),Sa.get("/getItems",Or),Sa.get("/getItemsDestacados",ar),Sa.get("/getItemsByType/:tipo",_r),Sa.get("/getItemsSubTipo/:tipo/:subTipo",Pr),Sa.get("/getItemsRelacionados/:tipo/:codigo",or),Sa.get("/getItemsSearch/:searchTerms",ir),Sa.get("/pdf/:pdfName",Fn),Sa.get("/getTags",Sr),Sa.get("/marcas/getAll",Tr),Sa.get("/getSiteMap",ca),Sa.post("/getListOfItemsFilteredByRegex",nr),Sa.post("/getListOfTagsFilteredByRegex",rr),Sa.post("/addTipo",fe,da),Sa.put("/updateTipo",fe,ga),Sa.put("/addSubTipo",fe,ua),Sa.put("/uptateSupTipos",fe,fa),Sa.post("/addItem",ge,jr),Sa.put("/updateItem",fe,Dr),Sa.post("/addItemReview",ye,aa),Sa.post("/addCaracteristica",fe,Qr),Sa.post("/deteleCaracteristicas",fe,Yr),Sa.post("/addTag",fe,xr),Sa.post("/deteleTags",fe,wr),Sa.post("/toFavorite",fe,Ar),Sa.post("/toUnFavorite",fe,Ir),Sa.put("/uploadVariationSC",fe,$r),Sa.put("/uploadVariationSimple",fe,vr),Sa.post("/marcas/add",fe,Cr),Sa.post("/changeFolder",fe,wa),Sa.post("/reorderItems",fe,Zr),Sa.post("/reorderTipos",fe,$a),Sa.post("/reorderSubTipos",fe,xa),Sa.delete("/deleteItem/:codigo",le,qr,Bn),Sa.delete("/deleteTipo/:codigo",le,va),Sa.delete("/deleteSupTipo/:codigo/:subTipoName",le,ya),Sa.delete("/marcas/delete/:deleteString",fe,kr),Sa.get("/getItemMayorGananciaPosible",ge,Wr),Sa.get("/getItemsLowStock",ge,Xr),Sa.get("/getItemsNoStock",ge,ea),Sa.get("/getClienteConMasCompras",ge,Hr),Sa.get("/getItemsMasVendido",ge,Jr),Sa.get("/getGananciasTotalesSNS",ge,Kr),Sa.get("/gananciasInvercionTotal",ge,Br),Sa.get("/getPeorMejorItem",ge,zr),Sa.get("/getVariacionPosnegAll",ge,Ur),Sa.get("/ventasPotenciales",ge,Fr),Sa.get("/getItemBalance/:codigo",ge,sr),Sa.get("/getItemReport/:codigo",ge,dr),Sa.get("/getTableInfItem",ge,ra),Sa.get("/getItemVentasPorMes/:codigoItem",ge,na),Sa.get("/getItemGIC/:codigoItem",ge,ta),Sa.post("/uploads/image/:codigo",fe,zn.single("img"),Kn,Un,Gr),Sa.post("/uploads/imageCat/:codigo",fe,zn.single("img"),Kn,Un,ba),Sa.post("/uploads/imageSubCat/:codigo/:subCat",fe,zn.single("img"),Kn,Un,ha),Sa.post("/uploads/ficha/:codigo",fe,Wn.single("pdf"),(function(e,t,n){var r=e.file;if(!r){var a=new Error("Please upload a file");return a.httpStatusCode=400,n(a)}e.uploadInfo={statusCode:200,status:"success",uploadedFile:r},n()}),Rr);const Ca=Sa,Va=require("axios");var ka=n.n(Va);function Ta(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var ja=function(){var e=A()(_().mark((function e(t,n,r,a){var o,i,s,c,d,u;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=new(pt().Workbook),i=o.addWorksheet(t,{sheetFormat:{defaultRowHeight:20,defaultColWidth:20}}),s=o.createStyle({font:{color:"black",size:12},border:{right:{style:"thin",color:"white"},left:{style:"thin",color:"white"},bottom:{style:"thin",color:"white"}},alignment:{vertical:"center"},numberFormat:"[$S/-es-PE]#,##0.00"}),c=o.createStyle({font:{color:"black",size:12},border:{right:{style:"thin",color:"white"},left:{style:"thin",color:"white"},bottom:{style:"thin",color:"white"}},alignment:{vertical:"center"},numberFormat:"[$S/-es-PE]#,##0.00",fill:{type:"pattern",patternType:"solid",fgColor:"#e2f3ff"}}),i.row(2).setHeight(40),i.row(4).setHeight(20),i.column(1).setWidth(10),i.column(4).setWidth(60),Na(o,i,n),Oa(o,i,r),d=Aa(i,a,5,s,c),i.cell(d,6).string("Total").style(s).style({font:{size:14,bold:!0,color:"white"},fill:{type:"pattern",patternType:"solid",fgColor:"#e87200"}}),i.cell(d,7).formula("SUBTOTAL(9,F5:F".concat(d-1,")")).style(s).style({font:{size:14,bold:!0,color:"black"},fill:{type:"pattern",patternType:"solid",fgColor:"white"}}),e.next=16,o.writeToBuffer();case 16:return u=e.sent,e.abrupt("return",u);case 20:throw e.prev=20,e.t0=e.catch(0),new Error(e.t0);case 23:case"end":return e.stop()}}),e,null,[[0,20]])})));return function(t,n,r,a){return e.apply(this,arguments)}}(),Na=function(e,t,n){var r=e.createStyle({font:{color:"white",size:16,bold:!0},alignment:{horizontal:"center",vertical:"center"},fill:{type:"pattern",patternType:"solid",fgColor:"#005087"}});t.cell(2,2,2,7,!0).string(n).style(r),t.row(3).setHeight(10)},Oa=function(e,t,n){var r,a=e.createStyle({font:{color:"white",size:14},border:{right:{style:"thin",color:"white"},left:{style:"thin",color:"white"},bottom:{style:"thin",color:"white"}},alignment:{horizontal:"left",vertical:"center"},fill:{type:"pattern",patternType:"solid",fgColor:"#e87200"}}),o=2,i=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Ta(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ta(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}(n);try{for(i.s();!(r=i.n()).done;){var s=r.value;t.cell(4,o).string(s).style(a),o++}}catch(e){i.e(e)}finally{i.f()}t.row(4).filter({firstColumn:2,lastColumn:7})},Aa=function e(t,n,r,a,o){var i,s=r-5;if(s>=n.length)return 5;t.row(r).setHeight(20),i=r%2==0?o:a;var c=new Date(n[s].date);t.cell(r,2).date(c.toLocaleDateString()).style(i).style({numberFormat:"dd-mm-yyy",alignment:{horizontal:"left",vertical:"center"}}),t.cell(r,3).string(n[s].codigo).style(i);var d="";return n[s].documento.name&&(d=n[s].documento.name+" | "+n[s].documento.codigo),t.cell(r,4).string(d).style(i),t.cell(r,5).string(n[s].vendedor).style(i),t.cell(r,6).number(n[s].totalPriceNoIGV).style(i),t.cell(r,7).number(n[s].totalPrice).style(i),1+e(t,n,r+1,a,o)};const Ia=new z.Schema({tipoComprobante:{type:Number,required:!0},serie:{type:String,required:!0},numero:{type:Number,required:!0}});function _a(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Pa(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Pa(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Pa(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Ea=m.production.sunatToken,Da=W().model("Venta",We),qa=W().model("Guia",Ia),Ga=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Da.findOneAndUpdate({codigo:t.params.codigo},{contratoAprobado:!0,documento:t.body.documento,pagosDeContrato:t.body.pagosDeContrato},{new:!0,useFindAndModify:!0});case 3:return r=e.sent,e.abrupt("return",n.json(r));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Ma=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Da.findOneAndUpdate({codigo:t.params.codigo},{pagosDeContrato:t.body},{new:!0,useFindAndModify:!0});case 3:return r=e.sent,e.abrupt("return",n.json(r));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Ra=function(){var e=A()(_().mark((function e(t,n,r){var a,o;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Da.findOne({codigo:t.body.saleCode});case 3:return a=e.sent,e.next=6,qa.countDocuments({});case 6:return o=e.sent,n.locals.venta=a,n.locals.countGuias=o,e.abrupt("return",r());case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t,n,r){return e.apply(this,arguments)}}(),La=function(){var e=A()(_().mark((function e(t,n){var r,a,o;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=n.locals.guia,a=new qa({tipoComprobante:r.tipo_de_comprobante,serie:r.serie,numero:r.numero}),e.next=5,a.save();case 5:return e.next=7,Da.findOneAndUpdate({codigo:t.body.ventaCod},{$push:{guias:{serie:r.serie,numero:r.numero,tipoComprobante:r.tipo_de_comprobante}}},{new:!0});case 7:return o=e.sent,e.abrupt("return",n.json(o));case 11:return e.prev=11,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 14:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(t,n){return e.apply(this,arguments)}}(),Ua=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=new RegExp(t.params.vendedor,"i"),e.next=4,Da.find({vendedor:r}).sort({date:-1}).limit(20);case 4:a=e.sent,n.json(a),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),Ba=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s,c,d,u,p;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Da.findOne({codigo:t.body.codigo});case 3:r=e.sent,a=Math.round(100*(r.totalPrice-t.body.totalPriceSC+Number.EPSILON))/100,o=za(a),i=0,s=0,c=_a(r.itemsVendidos),e.prev=9,c.s();case 11:if((d=c.n()).done){e.next=19;break}if(u=d.value,t.body.itemCodigo!==u.codigo){e.next=17;break}return i=Math.round(100*(u.totalPrice-t.body.totalPriceSC+Number.EPSILON))/100,s=za(i),e.abrupt("break",19);case 17:e.next=11;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(9),c.e(e.t0);case 24:return e.prev=24,c.f(),e.finish(24);case 27:return e.next=29,Da.findOneAndUpdate({codigo:t.body.codigo,itemsVendidos:{$elemMatch:{codigo:t.body.itemCodigo}}},{$pull:{"itemsVendidos.$.cantidadSC":{name:t.body.name,nameSecond:t.body.nameSecond}},$inc:{"itemsVendidos.$.cantidad":-t.body.cantidadVenta},$set:{"itemsVendidos.$.totalPrice":i,"itemsVendidos.$.totalPriceNoIGV":s,totalPrice:a,totalPriceNoIGV:o}},{new:!0,useFindAndModify:!1});case 29:p=e.sent,n.json(p),e.next=36;break;case 33:return e.prev=33,e.t1=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t1}));case 36:case"end":return e.stop()}}),e,null,[[0,33],[9,21,24,27]])})));return function(t,n){return e.apply(this,arguments)}}(),Fa=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Da.findOne({codigo:t.body.codigo});case 3:if(-1!==(r=e.sent).itemsVendidos.findIndex((function(e){return e.codigo===t.body.itemCodigo}))){e.next=7;break}return e.abrupt("return",n.status(409).json({message:"El item ya a sido eliminado"}));case 7:return a=Math.round(100*(r.totalPrice-t.body.totalItemPrice+Number.EPSILON))/100,o=za(a),e.next=11,Da.findOneAndUpdate({codigo:t.body.codigo},{$pull:{itemsVendidos:{codigo:t.body.itemCodigo}},$set:{totalPrice:a,totalPriceNoIGV:o}},{new:!0,useFindAndModify:!1});case 11:return i=e.sent,e.abrupt("return",n.json(i));case 15:return e.prev=15,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 18:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(t,n){return e.apply(this,arguments)}}(),za=function(e){var t=e/1.18;return Math.round(100*(t+Number.EPSILON))/100},Wa=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Da.findOne({codigo:t.params.ventaCod});case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Ka=function(){var e=A()(_().mark((function e(t,n){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=t.query.tipoVenta,e.next=4,Da.find({estado:"pendiente",vendedor:t.user.aud.split(" ")[0],tipoVenta:r});case 4:a=e.sent,n.json(a),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}(),Ja=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s,c;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,(a={})[t.body.orden]=t.body.ordenOrden,o=t.body.tiposDeVenta||["venta","contrato"],i=new RegExp(t.body.busqueda||"","gi"),s=new RegExp(t.body.busquedaItemCodigo||"","gi"),c=new RegExp(t.body.busquedaUsername||"","gi"),"noone"!==t.body.dateOne&&"noone"!==t.body.dateTwo){e.next=13;break}return e.next=10,Da.find({estado:{$in:t.body.estado},tipoVenta:{$in:o},"itemsVendidos.codigo":{$regex:s},vendedor:{$regex:c},$or:[{"documento.name":{$regex:i}},{"documento.codigo":Number(t.body.busqueda)||-1}],"documento.type":{$in:t.body.tipo}}).skip(parseInt(t.body.skip)).limit(parseInt(t.body.limit)).sort(a);case 10:r=e.sent,e.next=16;break;case 13:return e.next=15,Da.find({estado:{$in:t.body.estado},tipoVenta:{$in:o},"itemsVendidos.codigo":{$regex:s},vendedor:{$regex:c},$or:[{"documento.name":{$regex:i}},{"documento.codigo":Number(t.body.busqueda)||-1}],"documento.type":{$in:t.body.tipo},date:{$gte:new Date(t.body.dateOne),$lte:new Date(t.body.dateTwo)}}).skip(parseInt(t.body.skip)).limit(parseInt(t.body.limit)).sort(a);case 15:r=e.sent;case 16:n.json(r),e.next=22;break;case 19:return e.prev=19,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 22:case"end":return e.stop()}}),e,null,[[0,19]])})));return function(t,n){return e.apply(this,arguments)}}(),Ha=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,a=new RegExp(t.body.busqueda||"","gi"),o=new RegExp(t.body.busquedaItemCodigo||"","gi"),i=new RegExp(t.body.busquedaUsername||"","gi"),"noone"!==t.body.dateOne&&"noone"!==t.body.dateTwo){e.next=10;break}return e.next=7,Da.aggregate([{$match:{estado:{$in:t.body.estado},"itemsVendidos.codigo":{$regex:o},vendedor:{$regex:i},$or:[{"documento.name":{$regex:a}},{"documento.codigo":Number(t.body.busqueda)||-1}],"documento.type":{$in:t.body.tipo}}},{$count:"cantidadVentas"}]);case 7:r=e.sent,e.next=13;break;case 10:return e.next=12,Da.aggregate([{$match:{estado:{$in:t.body.estado},"itemsVendidos.codigo":{$regex:o},vendedor:{$regex:i},$or:[{"documento.name":{$regex:a}},{"documento.codigo":Number(t.body.busqueda)||-1}],"documento.type":{$in:t.body.tipo},date:{$gte:new Date(t.body.dateOne),$lt:new Date(t.body.dateTwo)}}},{$count:"cantidadVentas"}]);case 12:r=e.sent;case 13:n.json(r[0]),e.next=19;break;case 16:return e.prev=16,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 19:case"end":return e.stop()}}),e,null,[[0,16]])})));return function(t,n){return e.apply(this,arguments)}}(),Ya=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ka().post("https://api.migo.pe/api/v1/dni",{token:Ea,dni:t.params.dni});case 3:r=e.sent,n.json(r.data),e.next=18;break;case 7:if(e.prev=7,e.t0=e.catch(0),422!==e.t0.response.status){e.next=13;break}return e.abrupt("return",n.status(422).json({message:"Numero Invalido"}));case 13:if(404!==e.t0.response.status){e.next=17;break}return e.abrupt("return",n.status(404).json({message:"Documento No Encontrado"}));case 17:return e.abrupt("return",n.status(500).json({message:e.t0}));case 18:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Qa=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ka().post("https://api.migo.pe/api/v1/ruc",{token:Ea,ruc:t.params.ruc});case 3:r=e.sent,n.json(r.data),e.next=18;break;case 7:if(e.prev=7,e.t0=e.catch(0),422!==e.t0.response.status){e.next=13;break}return e.abrupt("return",n.status(422).json({message:"Numero Invalido"}));case 13:if(404!==e.t0.response.status){e.next=17;break}return e.abrupt("return",n.status(404).json({message:"Documento No Encontrado"}));case 17:return e.abrupt("return",n.status(500).json({message:e.t0}));case 18:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),Za=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=new RegExp(t.body.busqueda||"","gi"),a=new RegExp(t.body.busquedaItemCodigo||"","gi"),o=new RegExp(t.body.busquedaUsername||"","gi"),e.next=6,Da.find({estado:{$in:t.body.estado},"documento.type":{$in:t.body.tipo},"itemsVendidos.codigo":{$regex:a},vendedor:{$regex:o},date:{$gte:new Date(t.body.dateOne),$lte:new Date(t.body.dateTwo)},$or:[{"documento.name":{$regex:r}},{"documento.codigo":Number(t.body.busqueda)||-1}]});case 6:return i=e.sent,e.next=9,ja("Ventas","Reporte De Ventas",["Fecha","Codigo","Para","Vendido Por","Precio No IGV","Precio"],i);case 9:s=e.sent,n.writeHead(200,{"Content-Type":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","Content-Disposition":"attachment; filename=reporte.xlsx"}),n.write(s,"binary"),n.end(null,"binary"),e.next=18;break;case 15:return e.prev=15,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 18:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(t,n){return e.apply(this,arguments)}}(),Xa=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Da.aggregate([{$match:{date:{$gte:new Date("2021-01-01")},estado:"ejecutada"}},{$project:{codigo:"$documento.codigo",name:"$documento.name",_id:0,totalPrice:1}},{$group:{_id:"$name",value:{$sum:"$totalPrice"}}},{$match:{_id:{$ne:null,$exists:!0}}},{$match:{_id:{$ne:""}}},{$project:{_id:0,name:"$_id",value:1}},{$sort:{value:-1}},{$limit:4}]);case 3:r=e.sent,n.json(r),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),eo=function(){var e=A()(_().mark((function e(t,n){var r;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Da.aggregate([{$match:{estado:"ejecutada"}},{$unwind:"$itemsVendidos"},{$match:{"itemsVendidos.codigo":t.params.codigoItem}},{$group:{_id:null,totalVenta:{$sum:{$multiply:["$itemsVendidos.priceIGV","$itemsVendidos.cantidad"]}},totalGasto:{$sum:{$multiply:["$itemsVendidos.priceCosto","$itemsVendidos.cantidad"]}}}},{$project:{_id:0,totalVenta:1,value:{$subtract:["$totalVenta","$totalGasto"]}}}]);case 3:r=e.sent,n.json(r[0]?r[0]:{value:0,totalVenta:0}),e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}(),to=function(){var e=A()(_().mark((function e(t,n){var r,a,o;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Da.aggregate([{$match:{estado:"ejecutada"}},{$unwind:"$itemsVendidos"},{$match:{"itemsVendidos.codigo":t.params.codigoItem}},{$set:{mesVenta:{$dateToString:{format:"%Y-%m",date:"$date",timezone:"-05:00"}}}},{$group:{_id:"$mesVenta",totalVenta:{$sum:{$multiply:["$itemsVendidos.priceIGV","$itemsVendidos.cantidad"]}},totalGasto:{$sum:{$multiply:["$itemsVendidos.priceCosto","$itemsVendidos.cantidad"]}}}},{$project:{name:"$_id",_id:0,value:{$trunc:[{$subtract:["$totalVenta","$totalGasto"]},0]}}},{$sort:{name:1}}]);case 3:return r=e.sent,e.next=6,Da.aggregate([{$match:{estado:"ejecutada"}},{$unwind:"$itemsVendidos"},{$match:{"itemsVendidos.codigo":t.params.codigoItem}},{$set:{mesVenta:{$dateToString:{format:"%Y-%m",date:"$date",timezone:"-05:00"}}}},{$group:{_id:"$mesVenta",totalVenta:{$sum:{$multiply:["$itemsVendidos.priceIGV","$itemsVendidos.cantidad"]}},totalGasto:{$sum:{$multiply:["$itemsVendidos.priceCosto","$itemsVendidos.cantidad"]}}}},{$project:{name:"$_id",_id:0,value:"$totalVenta"}},{$sort:{name:1}}]);case 6:a=e.sent,o=[{name:"Ingresos",series:a},{name:"Ganancia",series:r}],n.json(o),e.next=14;break;case 11:return e.prev=11,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 14:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(t,n){return e.apply(this,arguments)}}(),no=function(){var e=A()(_().mark((function e(t,n,r){var a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Da.aggregate([{$match:{date:{$gte:new Date("2021-01-01")},estado:"ejecutada"}},{$unwind:"$itemsVendidos"},{$replaceRoot:{newRoot:"$itemsVendidos"}},{$group:{_id:"$codigo",totalVenta:{$sum:{$multiply:["$priceIGV","$cantidad"]}},totalGasto:{$sum:{$multiply:["$priceCosto","$cantidad"]}}}},{$project:{name:"$_id",_id:0,totalVenta:1,value:{$trunc:[{$subtract:["$totalVenta","$totalGasto"]},0]}}},{$sort:{value:-1}}]);case 3:a=e.sent,t.gananciaPorItem=a,r(),e.next=11;break;case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,n,r){return e.apply(this,arguments)}}(),ro=function(){var e=A()(_().mark((function e(t,n){var r,a,o;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Da.aggregate([{$match:{date:{$gte:new Date("2021-01-01")},estado:"ejecutada"}},{$project:{month:{$dateToString:{format:"%Y-%m",date:"$date",timezone:"-05:00"}},date:1,totalPrice:1,totalPriceNoIGV:1}},{$group:{_id:"$month",value:{$sum:"$totalPrice"}}},{$project:{_id:0,value:{$trunc:["$value",0]},name:"$_id"}},{$sort:{name:1}}]);case 3:return r=e.sent,e.next=6,Da.aggregate([{$match:{date:{$gte:new Date("2021-01-01")},estado:"ejecutada"}},{$project:{month:{$dateToString:{format:"%Y-%m",date:"$date",timezone:"-05:00"}},itemsVendidos:1}},{$unwind:"$itemsVendidos"},{$group:{_id:"$month",itemsVendidosPorMes:{$push:{$subtract:[{$multiply:["$itemsVendidos.cantidad","$itemsVendidos.priceIGV"]},{$multiply:["$itemsVendidos.cantidad","$itemsVendidos.priceCosto"]}]}}}},{$project:{_id:0,value:{$trunc:[{$sum:"$itemsVendidosPorMes"},0]},name:"$_id"}},{$sort:{name:1}}]);case 6:return a=e.sent,o=[{name:"Ventas",series:r},{name:"Ganancias",series:a}],e.abrupt("return",n.json(o));case 11:return e.prev=11,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 14:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(t,n){return e.apply(this,arguments)}}(),ao=function(){var e=A()(_().mark((function e(t,n){var r,a,o,i,s,c,d;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=oo(parseInt(t.params.month),parseInt(t.params.year)),e.next=4,Da.aggregate([{$match:{date:{$gte:new Date("2021-01-01")},estado:"ejecutada"}},{$project:{_id:0,codigo:1,totalPrice:1,day:{$dayOfMonth:"$date"},gastosVenta:{$sum:{$map:{input:"$itemsVendidos",as:"itemVendido",in:{$multiply:["$$itemVendido.cantidad","$$itemVendido.priceCosto"]}}}},year:{$year:"$date"},month:{$month:"$date"}}},{$match:{year:parseInt(t.params.year),month:parseInt(t.params.month)}},{$project:{_id:0,codigo:1,totalPrice:1,day:1,gastosVenta:1,gananciasVenta:{$subtract:["$totalPrice","$gastosVenta"]}}},{$group:{_id:"$day",ganancias:{$sum:"$gananciasVenta"},ventas:{$sum:"$totalPrice"}}},{$sort:{_id:1}}]);case 4:a=e.sent,o=[],i=0,s=0,c=0;case 9:if(!(c<r)){e.next=22;break}if((d=a[s]?a[s]._id:-1)!==c+1){e.next=16;break}"ganancia"===t.params.calcular?i+=a[s].ganancias:"venta"===t.params.calcular&&(i+=a[s].ventas),s++,e.next=18;break;case 16:if(-1!==d){e.next=18;break}return e.abrupt("break",22);case 18:o.push({name:c+1,value:i.toFixed(2)});case 19:c++,e.next=9;break;case 22:n.json(o),e.next=28;break;case 25:return e.prev=25,e.t0=e.catch(0),e.abrupt("return",n.status(500).json({message:e.t0}));case 28:case"end":return e.stop()}}),e,null,[[0,25]])})));return function(t,n){return e.apply(this,arguments)}}(),oo=function(e,t){return new Date(t,e,0).getDate()},io=new $.Router;io.get("/getLastVentas/:vendedor",ye,Ua),io.get("/getGananciaTotalPorItem/:codigoItem",ge,eo),io.get("/getItemGananciaIngreso/:codigoItem",ge,to),io.get("/getVentasPorDiaMes/:month/:year/:calcular",ge,ao),io.get("/getMejoresClientes",ge,Xa),io.get("/getItemsGanancias",ge,no,Lr),io.get("/getInfoToPlotVentasOverTime",ge,ro),io.put("/eliminarItemVenta",fe,Fa),io.put("/eliminarItemSCVenta",fe,Ba),io.put("/anularVentaPost",fe,mr),io.get("/dni/:dni",ye,Ya),io.post("/createExcelReport",ge,Za),io.post("/getEjecutadas",ge,Ja),io.post("/getCantidadVentas",ge,Ha),io.get("/testTotal",ge,Vr),io.get("/ruc/:ruc",ye,Qa),io.get("/obtenerVenta/:ventaCod",ge,Wa),io.post("/ventaSimple",fe,gr,mn,br),io.post("/agregarVenta",fe,je,lr,ke),io.get("/ventasActivasFull",ge,Ka),io.get("/ventasActivasList",ge,Te),io.post("/agregarItemVenta",fe,pr),io.post("/ventasForCard",ge,ur),io.post("/ejecutarVenta",fe,fr,mn,br),io.post("/sunat-guide",fe,Ra,dn,La),io.get("/sunat-guide/:serie/:numero/:tipo_de_comprobante",fe,un),io.put("/:codigo/aprobarContrato",fe,Ga),io.put("/:codigo/actualizarCuotas",fe,Ma),io.put("/anularVenta",fe,yr);const so=io,co=require("swagger-ui-express");var uo=n.n(co);const po=JSON.parse('{"openapi":"3.0.2","info":{"license":{"name":"MIT","url":"https://github.com/TacEtarip/sirioinventarioserver/blob/master/LICENSE"},"contact":{"email":"hu3rtas@outlook.com","name":"Luis Huertas","url":"https://github.com/TacEtarip/sirioinventarioserver"},"title":"Sirio Dinar Inventario API","version":"1.0","description":"Rest API para el uso del inventari de la empresa Sirio Dinar. Front End: https://inventario.siriodinar.com/"},"servers":[{"url":"https://inventario-sirio-dinar.herokuapp.com"},{"url":"http://localhost:5000"}],"tags":[{"name":"tipos","description":"Manejar los tipos de items."},{"name":"items","description":"Manejar los items"},{"name":"ventas","description":"Manejar las ventas"},{"name":"reportes","description":"Reportes sobre inventario."},{"name":"organizar","description":"Organizar la presentación de los tipos, sub-tipo e items."},{"name":"utilidades","description":"Utilidades para el inventario."},{"name":"auth","description":"Manejar la autenticación y usuarios."}],"components":{"responses":{"500":{"description":"Ocurrio un error en el servidor","content":{"aplication/json":{"schema":{"type":"object","properties":{"errorMSG":{"type":"string"}}}}}},"Error-401":{"description":"No exite un token de autorización valido"},"Succes":{"description":"Exito al procesar request"}},"securitySchemes":{"JWT TOKEN TRANSACCIONAL":{"type":"http","scheme":"bearer","bearerFormat":"JWT #token #usuario #tipo"},"JWT TOKEN ADMIN":{"type":"http","scheme":"bearer","bearerFormat":"JWT #token #usuario #tipo"},"JWT TOKEN ALL":{"type":"http","scheme":"bearer","bearerFormat":"JWT #token #usuario #tipo"}},"schemas":{"error401":{"description":"NO AUTORIZADO","type":"object","properties":{"message":{"type":"string"}}},"tipo":{"type":"object","required":["name"],"properties":{"name":{"type":"string","description":"Nombre del tipo"},"date":{"type":"string","description":"Fecha de creación del tipo","readOnly":true},"codigo":{"type":"string","description":"Codigo del tipo"},"subTipo":{"type":"array","description":"Listado de sub-tipos","items":{"type":"string","description":"Nombre del sub-tipo"}},"subTipoLink":{"type":"array","description":"Listado las imagenes de los sub-tipos","items":{"type":"string","description":"URL de imagén del sub-tipo"}},"deleted":{"type":"boolean"},"link":{"type":"string","description":"URL de imagén del tipo"},"order":{"type":"number","default":-1,"description":"Orden en que se muestra el tipo"}},"example":{"subTipo":["Respiradores 3M","Filtros 3M","Respiradores Master","Mascarillas","Respiradores Astara","Retenedores para filtros"],"name":"Pro. Respiratoria","date":"2021-01-14T20:04:04.125+00:00","codigo":"1610645929520","deleted":false,"link":"img-1610645929520-1621997665489.png","subTipoLink":["IMG-1622763250845.png","img-1622747657121.png","IMG-1622763288076.png","IMG-1622763339734.png","IMG-1631032975632.jpg","IMG-1630012297019.jpg"],"order":1}},"review":{"type":"object","required":["name"],"properties":{"user":{"type":"string","description":"Username de quien realizo la review"},"rating":{"type":"number","description":"Rating del item de 1 a 5"},"date":{"type":"string","description":"Fecha de publicación de la review"}}},"cantidadSC":{"type":"object","required":["name"],"properties":{"name":{"type":"string","description":"Nombre de la sub cantidad"},"nameSecond":{"type":"string","description":"Segundo nombre de la sub cantidad"},"cantidadDisponible":{"type":"number","description":"Cantidad disponible al momento de la variación"},"cantidadVenta":{"type":"number","description":"Cantidad"}}},"order":{"type":"object","required":["name"],"properties":{"name":{"type":"string","description":"Nombre especifico de la sub cantidad"},"nameSecond":{"type":"string","description":"Segundo especifico nombre de la sub cantidad"},"cantidad":{"type":"number","description":"Cantidad del subconteo"}}},"subConteo":{"type":"object","required":["name"],"properties":{"name":{"type":"string","description":"Nombre de la sub cantidad"},"nameSecond":{"type":"string","description":"Segundo nombre de la sub cantidad"},"order":{"type":"array","items":{"$ref":"#/components/schemas/order"}}}},"variacion":{"type":"object","properties":{"date":{"type":"string","description":"Fecha de la variación ISO STRING","readOnly":true},"tipo":{"type":"boolean","description":"Variación positiva o negativa"},"comentario":{"type":"string","description":"Comentario sobre la variación"},"costoVar":{"type":"number","description":"Costo de la variación"},"cantidad":{"type":"number","description":"Cantidad de variación"},"cantidadSC":{"type":"array","items":{"$ref":"#/components/schemas/cantidadSC"}},"usuario":{"type":"string","description":"Nombre del usuario que realizo la variación"}}},"item":{"type":"object","required":["name","priceIGV","tipo"],"properties":{"codigo":{"type":"string","description":"Codigo del producto, es auto generado."},"name":{"type":"string","description":"Nombre del producto"},"nameLowerCase":{"type":"string","description":"Nombre en minusculas"},"priceIGV":{"type":"number","description":" Precio del producto sin IGV"},"cantidad":{"type":"number","description":"Cantidad de items disponibles del producto"},"subConteo":{"$ref":"#/components/schemas/subConteo"},"variaciones":{"type":"array","items":{"$ref":"#/components/schemas/variacion"}},"tipo":{"type":"string","description":"Tipo al que pertenece el producto"},"subTipo":{"type":"string","description":"Sub tipo al que pertenece el producto"},"unidadDeMedida":{"type":"string","description":"Unidad de medida del item"},"oferta":{"type":"number","description":"Oferta del item"},"date":{"type":"string","description":"Fecha de creación del item ISO STRING","readOnly":true},"description":{"type":"string","description":"Descripción del producto"},"photo":{"type":"string","description":"URL de la foto de este item"},"ficha":{"type":"boolean","description":"Tiene una ficha este producto?"},"marca":{"type":"string","description":"Marca del item"},"costoPropio":{"type":"number","description":"Costo de compra de item"},"multiSearchParams":{"type":"string","description":"Parametros por los cuales puede ser buscado este item","deprecated":true},"deleted":{"type":"boolean","description":"Este item existe?"},"tags":{"type":"array","items":{"type":"string","description":"Tags del item"}},"caracteristicas":{"type":"array","items":{"type":"string","description":"Caracteristicas del item"}},"orderNumber":{"type":"number","description":"En que POS se muestra el nuemro"},"reviews":{"type":"array","items":{"$ref":"#/components/schemas/review"}},"googleCategory":{"type":"string","description":"Categoria del item segun google","default":"2047"}},"example":{"cantidad":425,"subTipo":"LENTES SPIDER","unidadDeMedida":"UND","oferta":0,"photo":"img-14SDLP4-1610836257167.jpeg","ficha":false,"marca":"CLUTE","deleted":false,"tags":[],"caracteristicas":["Lente de policarbonato de alta transparencia.","Proteccion de 99.9% de la radiacion UV.","Tratamiento anti-empañante que reduce la obstrucción de la visibilidad en ambientes húmedos y cambios bruscos de temperatura.","Tratamiento anti-rayadura que prolonga la vida útil del policarbonato."],"orderNumber":-2,"googleCategory":"2047","_id":"600368bd53a848001fc98ea4","name":"Lentes Alpine","priceIGV":35,"description":"Alipme","costoPropio":27,"tipo":"Protec. Visual","variaciones":[{"cantidad":432,"tipo":true,"usuario":"desconocido","date":"2021-01-16T22:29:17.386Z","comentario":"new item","costoVar":10800,"cantidadSC":[]},{"cantidad":1,"tipo":false,"usuario":"desconocido","date":"2021-02-17T22:49:35.594Z","comentario":"venta|SD01-000333","costoVar":35,"cantidadSC":[]},{"cantidad":1,"tipo":true,"usuario":"desconocido","date":"2021-02-17T23:01:24.220Z","comentario":"anular|SD01-000333","costoVar":35,"cantidadSC":[]},{"cantidad":2,"tipo":false,"usuario":"desconocido","date":"2021-06-08T22:44:08.841Z","comentario":"quitar|Actualización","costoVar":54,"cantidadSC":[]},{"cantidad":1,"tipo":false,"usuario":"desconocido","date":"2021-06-21T20:14:08.578Z","comentario":"venta|SD01-001013","costoVar":35,"cantidadSC":[]},{"cantidad":1,"tipo":false,"usuario":"admin","date":"2021-07-15T15:26:49.169Z","comentario":"venta|SD01-001157","costoVar":25,"cantidadSC":[]},{"cantidad":2,"tipo":false,"usuario":"desconocido","date":"2021-07-30T22:07:45.576Z","comentario":"quitar|Actualización","costoVar":54,"cantidadSC":[]},{"cantidad":1,"tipo":false,"usuario":"admin","date":"2021-08-27T22:15:32.180Z","comentario":"venta|SD01-001438","costoVar":35,"cantidadSC":[]}],"date":"2021-01-16T22:29:17.383Z","priceNoIGV":29.66,"codigo":"14SDLP4","nameLowerCase":"lentes alpine","__v":0,"reviews":[]}},"marca":{"type":"object","properties":{"name":{"type":"string","description":"Nombre de la marca"},"codigo":{"type":"string","description":"Codigo de la marca"},"ruc":{"type":"string"}}},"tag":{"type":"object","properties":{"name":{"type":"string","description":"Nombre del tag"},"deleted":{"type":"boolean"}}},"user":{"required":["username","email","created_date"],"type":"object","properties":{"username":{"type":"string"},"type":{"type":"string"},"created_date":{"type":"string"},"displayName":{"type":"string"},"email":{"type":"string"},"dirOne":{"type":"string"},"dirTwo":{"type":"string"},"reference":{"type":"string"},"ciudad":{"type":"string"},"nombre":{"type":"string"},"apellido":{"type":"string"},"nomape":{"type":"string"},"googleCod":{"type":"string"},"documento":{"type":"string"},"tipoPersona":{"type":"string"},"verified":{"type":"boolean"},"celular":{"type":"string"},"ventaActiva":{"type":"array","items":{"type":"string"}},"carrito":{"type":"string"}}},"login":{"type":"object","properties":{"username":{"type":"string"},"password":{"type":"string"}}},"authToken":{"type":"object","properties":{"displayName":{"type":"string"},"username":{"type":"string"},"message":{"type":"string"},"type":{"type":"string"},"token":{"type":"string"}}},"document":{"type":"object","properties":{"type":{"type":"string"},"name":{"type":"string"},"codigo":{"type":"number"},"direccion":{"type":"string"}}},"itemvendido":{"type":"object","properties":{"codigo":{"type":"string"},"tipo":{"type":"string"},"name":{"type":"string"},"descripcion":{"type":"string"},"priceIGV":{"type":"number"},"priceNoIGV":{"type":"number"},"priceCosto":{"type":"number"},"cantidad":{"type":"number"},"cantidadSC":{"type":"array","items":{"$ref":"#/components/schemas/cantidadSC"}},"totalPrice":{"type":"number"},"totalPriceNoIGV":{"type":"number"},"unidadDeMedida":{"type":"string"},"photo":{"type":"string"},"ventaCod":{"type":"string"}}},"venta":{"type":"object","properties":{"codigo":{"type":"string"},"totalPrice":{"type":"number"},"totalPriceNoIGV":{"type":"number"},"estado":{"type":"string"},"documento":{"$ref":"#/components/schemas/document"},"itemsVendidos":{"type":"array","items":{"$ref":"#/components/schemas/itemvendido"}},"date":{"type":"string"},"vendedor":{"type":"string"},"tipoVendedor":{"type":"string"},"medio_de_pago":{"type":"string"},"linkComprobante":{"type":"string"},"serie":{"type":"string"},"tipoComprobante":{"type":"string"},"numero":{"type":"number"},"cliente_email":{"type":"string"},"guia_serie":{"type":"string"},"guia_numero":{"type":"string"},"guia":{"type":"boolean"},"guia_link":{"type":"string"},"carrito_venta":{"type":"boolean"},"estado_carrito_comprando":{"type":"boolean"}}}}},"paths":{"/inventario/getTipos":{"get":{"tags":["tipos"],"summary":"Optener todos los tipos","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/tipo"}}}}}}}},"/inventario/getTipo/{nameTipo}":{"get":{"tags":["tipos"],"summary":"Obtener un tipo en especifico","parameters":[{"name":"nameTipo","in":"path","required":true,"allowEmptyValue":false,"example":"Pro. Respiratoria","schema":{"type":"string","description":"Nombre del tipo que deseamos"}}],"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/tipo"}}}}}}},"/inventario/addTipo":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["tipos"],"summary":"Agregar tipo","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/tipo"},"example":{"name":"Nuevo Tipo"}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/tipo"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/updateTipo":{"put":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["tipos"],"summary":"Actualizar tipo","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"codigo":{"type":"string","description":"Codigo del tipo"},"tipoName":{"type":"string","description":"Nuevo nombre del tipo"}}},"example":{"codigo":"123123","tipoName":"Tipo Editado"}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/tipo"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/deleteTipo/{codigo}":{"delete":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"parameters":[{"name":"codigo","in":"path","required":true,"allowEmptyValue":false,"example":"123456","schema":{"type":"string","description":"Codigo del tipo que deseamos eliminar"}}],"tags":["tipos"],"summary":"Elimina el tipo y todos los sub-tipos e items dentro del él.","responses":{"200":{"description":"Ok, Tipo eliminado","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/tipo"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getSubTipos/{nameTipo}":{"get":{"tags":["tipos"],"summary":"Optener todos los sub-tipos","parameters":[{"name":"nameTipo","in":"path","required":true,"allowEmptyValue":false,"example":"Pro. Respiratoria","schema":{"type":"string","description":"Nombre del tipo que deseamos"}}],"responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","properties":{"subTipo":{"type":"array","items":{"type":"string"}}},"example":{"subTipo":["Respiradores 3M","Filtros 3M"]}}}}}}}},"/inventario/addSubTipo":{"put":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["tipos"],"summary":"Agregar sub-tipo","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"codigo":{"type":"string","description":"Codigo del tipo"},"subTipo":{"type":"string","description":"Nombre del sub-tipo"}}},"example":{"codigo":"123123","subTipo":"SubTipo Nuevo"}}}},"responses":{"200":{"$ref":"#/components/responses/Succes"},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/uptateSupTipos":{"put":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["tipos"],"summary":"Editar sub-tipo","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"codigo":{"type":"string","description":"Codigo del tipo"},"newSubName":{"type":"string","description":"Nuevo nombre del sub-tipo"},"antiguoSubName":{"type":"string","description":"Antiguo nombre del sub-tipo"}}},"example":{"codigo":"123123","newSubName":"SubTipo Nuevo","antiguoSubName":"SubTipo Antiguo"}}}},"responses":{"200":{"$ref":"#/components/responses/Succes"},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/deleteSupTipo/{codigo}/{subTipoName}":{"delete":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"parameters":[{"name":"codigo","in":"path","required":true,"allowEmptyValue":false,"example":"123456","schema":{"type":"string","description":"Codigo del tipo del sub-tipo que deseamos eliminar"}},{"name":"subTipoName","in":"path","required":true,"allowEmptyValue":false,"example":"Pro. Respiratoria","schema":{"type":"string","description":"Nombre del sub-tipo que se desea eliminar."}}],"tags":["tipos"],"summary":"Elimina el sub-tipo y todos los items dentro del él.","responses":{"200":{"description":"Ok, sub-tipo eliminado","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/tipo"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getItem/cod/{codigo}":{"get":{"tags":["items"],"parameters":[{"name":"codigo","in":"path","required":true,"allowEmptyValue":false,"example":"1SDRP4","schema":{"type":"string","description":"Codigo del item"}}],"summary":"Obtener un item","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"$ref":"#/components/schemas/item"}}}}}}},"/inventario/getItems":{"get":{"tags":["items"],"deprecated":true,"summary":"Optener todos los items. No usar.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/item"}}}}}}}},"/inventario/getItemsDestacados":{"get":{"tags":["items"],"summary":"Obtener los items destacados","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/item"}}}}}}}},"/inventario/getItemsByType/{nameTipo}":{"get":{"tags":["items"],"parameters":[{"name":"nameTipo","in":"path","required":true,"allowEmptyValue":false,"example":"Pro. Respiratoria","schema":{"type":"string","description":"Nombre del tipo que deseamos"}}],"summary":"Obtener los items de un tipo","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/item"}}}}}}}},"/inventario/getItemsSubTipo/{nameTipo}/{subTipo}":{"get":{"tags":["items"],"parameters":[{"name":"nameTipo","in":"path","required":true,"allowEmptyValue":false,"example":"Pro. Respiratoria","schema":{"type":"string","description":"Nombre del tipo que deseamos"}},{"name":"subTipo","in":"path","required":true,"allowEmptyValue":false,"example":"Respiradores Master","schema":{"type":"string","description":"Nombre del sub-tipo que deseamos"}}],"summary":"Obtener los items de un sub-tipo","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/item"}}}}}}}},"/inventario/getItemsRelacionados/{tipo}/{codigo}":{"get":{"tags":["items"],"parameters":[{"name":"tipo","in":"path","required":true,"allowEmptyValue":false,"example":"Pro. Respiratoria","schema":{"type":"string","description":"Tipo del que buscar"}},{"name":"codigo","in":"path","required":true,"allowEmptyValue":false,"example":"1SDRP4","schema":{"type":"string","description":"Codigo del item del que queremos sacar items relacionados."}}],"summary":"Obtener los items realacionados, NOT COMPLETE","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/item"}}}}}}}},"/inventario/getItemsSearch/{searchTerms}":{"get":{"tags":["items"],"parameters":[{"name":"searchTerms","in":"path","required":true,"allowEmptyValue":false,"example":"Cualquier texto","schema":{"type":"string","description":"Terminos que se desean buscar"}}],"summary":"Obtener los items segun regex","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/item"}}}}}}}},"/inventario/addItem":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["items"],"summary":"Agregar item","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/item"},"example":{"cantidad":425,"subTipo":"LENTES SPIDER","unidadDeMedida":"UND","marca":"CLUTE","deleted":false,"googleCategory":"2047","name":"Lentes Alpine TEST","priceIGV":35,"description":"Alipme","costoPropio":27,"tipo":"Protec. Visual","priceNoIGV":29.66}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/item"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/updateItem":{"put":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["items"],"summary":"Actualizar item","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/item"},"example":{"codigo":"1SDRP4","cantidad":425,"unidadDeMedida":"UND","marca":"CLUTE","name":"Lentes Alpine TEST","priceIGV":35,"description":"Alipme","costoPropio":27,"tags":["Clute"]}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/item"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/uploadVariationSC":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["items"],"summary":"Actualizar item","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"codigo":{"type":"string"},"cantidad":{"type":"number"},"comentario":{"type":"string"},"tipo":{"type":"boolean"},"subConteo":{"$ref":"#/components/schemas/subConteo"}}}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/item"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/uploadVariationSimple":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["items"],"summary":"Actualizar item","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"codigo":{"type":"string"},"cantidad":{"type":"number"},"comentario":{"type":"string"},"tipo":{"type":"boolean"}}}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/item"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/addItemReview":{"post":{"security":[{"JWT TOKEN ALL":[]}],"tags":["items"],"summary":"Agrega una review al item.","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/item"},"example":{"codigo":"1SDRP4","rating":5}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/item"}}}},"400":{"description":"Numero no valido","content":{"aplication/json":{"schema":{"type":"array","properties":{"errorMSG":{"description":"Mensaje de error"}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/addCaracteristica":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["items"],"summary":"Agrega una caracteristica","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"itemCod":{"type":"string"}}},"example":{"itemCod":"1SDRP4"}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/item"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/deteleCaracteristicas":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["items"],"summary":"Eliminar caracteristica de item","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"itemCod":{"type":"string"},"deleteArray":{"type":"array","items":{"type":"string"}}}}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/item"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/toFavorite":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["items"],"summary":"Agregar item a favoritos o destacados","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/item"},"example":{"codigo":"1SDRP4"}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/item"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/toUnFavorite":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["items"],"summary":"Quitar item de favoritos o destacados","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/item"},"example":{"codigo":"1SDRP4"}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/item"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/deleteItem/{codigo}":{"delete":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["items"],"parameters":[{"name":"codigo","in":"path","required":true,"allowEmptyValue":false,"example":"1SDRP4","schema":{"type":"string","description":"Codigo del item que deseamos eliminar"}}],"summary":"Eliminar item","responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/item"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/uploads/image/{codigo}":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["items"],"summary":"Agregar o modificar imagen de item","requestBody":{"required":true,"content":{"form-data":{"schema":{"type":"object","properties":{"img":{"type":"string","description":"File Type"},"oldPhoto":{"type":"string","description":"URL de la imagén antigua."}}}}}},"parameters":[{"name":"codigo","in":"path","required":true,"allowEmptyValue":false,"example":"1SDRP4","schema":{"type":"string","description":"Codigo del item que queremos modificar la imagén"}}],"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/item"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/uploads/imageCat/{codigo}":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["tipos"],"summary":"Agregar o modificar imagen de tipo","requestBody":{"required":true,"content":{"form-data":{"schema":{"type":"object","properties":{"img":{"type":"string","description":"File Type"},"oldPhoto":{"type":"string","description":"URL de la imagén antigua."}}}}}},"parameters":[{"name":"codigo","in":"path","required":true,"allowEmptyValue":false,"example":"1SDRP4","schema":{"type":"string","description":"Codigo del tipo que queremos modificar la imagén"}}],"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/tipo"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/uploads/imageSubCat/{codigo}/{subCat}":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["tipos"],"summary":"Agregar o modificar imagen de sub-tipo","requestBody":{"required":true,"content":{"form-data":{"schema":{"type":"object","properties":{"img":{"type":"string","description":"File Type"},"oldPhoto":{"type":"string","description":"URL de la imagén antigua."}}}}}},"parameters":[{"name":"codigo","in":"path","required":true,"allowEmptyValue":false,"example":"1SDRP4","schema":{"type":"string","description":"Codigo del tipo del sub-tipo que queremos modificar la imagén"}},{"name":"subCat","in":"path","required":true,"allowEmptyValue":false,"example":"Un Sub Tipo","schema":{"type":"string","description":"Sub-tipo del que queremos modificar la imagén"}}],"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"type":"object","properties":{"newPhoto":{"type":"string","description":"Link de la nueva foto"}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/changeFolder":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["organizar"],"summary":"Modificar a que tipo/sub-tipo un item pertenece.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["codigo"],"properties":{"codigo":{"type":"string","description":"Codigo del item"},"newTipo":{"type":"string","description":"Nombre del nuevo tipo."},"newSubTipo":{"type":"string","description":"Nombre del nuevo sub tipo"}}}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/item"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/reorderItems":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["organizar"],"summary":"Ordenar items.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["codigo"],"properties":{"itemReOrder":{"type":"array","items":{"$ref":"#/components/schemas/item"}}}}}}},"responses":{"200":{"$ref":"#/components/responses/Succes"},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/reorderTipos":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["organizar"],"summary":"Ordenar tipos.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["codigo"],"properties":{"tiposReOrder":{"type":"array","items":{"$ref":"#/components/schemas/tipo"}}}}}}},"responses":{"200":{"$ref":"#/components/responses/Succes"},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/reorderSubTipos":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["organizar"],"summary":"Ordenar sub-tipos.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["codigo"],"properties":{"tipoCodigo":{"type":"string","description":"Codigo del tipo al que pertenecen los sub-tipos"},"linksList":{"type":"array","items":{"type":"string"}},"subTipoList":{"type":"array","items":{"type":"string"}}}}}}},"responses":{"200":{"$ref":"#/components/responses/Succes"},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getItemMayorGananciaPosible":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["reportes"],"summary":"Optener item con la mayor ganancia posible.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"object","properties":{"name":{"type":"string","description":"Nombre del item"},"balance":{"type":"number","description":"Balance del item en soles (S/)"}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getItemsLowStock":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["reportes"],"summary":"Optener items con poca cantidad.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/item"}}}}}}}},"/inventario/getItemsNoStock":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["reportes"],"summary":"Optener items agotados.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/item"}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getClienteConMasCompras":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["reportes"],"summary":"Optener clientes que más han comprado.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"object","properties":{"cliente":{"type":"string","description":"Nombre del cliente"},"numero":{"type":"number","description":"Cantidad de compras"}}}}}}}}},"/inventario/getItemsMasVendido":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["reportes"],"summary":"Optener item más vendido.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/item"}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getGananciasTotalesSNS":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["reportes"],"summary":"Optener ganancias por ventas.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"object","properties":{"gananciaEnVentasFueraTienda":{"type":"number","description":"Ganancias por items no registrados en el inventario."},"gananciaEnVentas":{"type":"number","description":"Ganancias por ventas totales."},"gananciaEnVentasDeTienda":{"type":"number","description":"Ganancias por items registardos en el inventario."}}}}}}}}},"/inventario/gananciasInvercionTotal":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["reportes"],"summary":"Optener ganancias y gastos totales.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"object","properties":{"gastoTotalHistorico":{"type":"number","description":"Total de gastos registrados."},"ingresoTotalHistorico":{"type":"number","description":"Total de ganancias registradas."}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getPeorMejorItem":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["reportes"],"summary":"Optener los items con el mejor y peor rendimiento.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"object","properties":{"peor":{"type":"object","description":"Peor item.","properties":{"name":{"type":"string"},"balance":{"type":"number"}}},"mejor":{"type":"object","description":"Mejor item.","properties":{"name":{"type":"string"},"balance":{"type":"number"}}}}}}}}}}},"/inventario/ventasPotenciales":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["reportes"],"summary":"Optener ventas potenciales.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"object","properties":{"ventasPosibles":{"type":"number","description":"Ventas potenciales de los items"},"costoPropioTotalAprox":{"type":"number","description":"Cuanto han costado todos los items"},"gananciaAprox":{"type":"number","description":"Ganancias aproximadas"}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getTableInfItem":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["reportes"],"summary":"Obtener JSON con información necesaria para realizar un reporte por cada item.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"type":"object","properties":{"name":{"type":"string"},"codigo":{"type":"string"},"cantidad":{"type":"number"},"priceIGV":{"type":"number"},"costoPropio":{"type":"number"},"valueIngreso":{"type":"number"},"valueGasto":{"type":"number"}}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getItemBalance/{codigo}":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"parameters":[{"name":"codigo","in":"path","required":true,"allowEmptyValue":false,"example":"123dDF","schema":{"type":"string","description":"Codigo del item"}}],"tags":["reportes"],"summary":"Obtener balance de un item.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"number","description":"Balance del item"}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getItemReport/{codigo}":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"parameters":[{"name":"codigo","in":"path","required":true,"allowEmptyValue":false,"example":"123dDF","schema":{"type":"string","description":"Codigo del item"}}],"tags":["reportes"],"summary":"Obtener un excel con el reporte de variaciones del item.","responses":{"200":{"description":"Ok","content":{"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":{}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getItemVentasPorMes/{codigo}":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"parameters":[{"name":"codigo","in":"path","required":true,"allowEmptyValue":false,"example":"123dDF","schema":{"type":"string","description":"Codigo del item"}}],"tags":["reportes"],"externalDocs":{"url":"https://swimlane.gitbook.io/ngx-charts/"},"summary":"Obtener ventas por mes para ser graficadas usando ngx-charts.","responses":{"200":{"$ref":"#/components/responses/Succes"},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getItemGIC/{codigo}":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"parameters":[{"name":"codigo","in":"path","required":true,"allowEmptyValue":false,"example":"123dDF","schema":{"type":"string","description":"Codigo del item"}}],"tags":["reportes"],"summary":"Obtener ganancias, ingresos y costos de item.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"object","properties":{"itemVendidos":{"type":"number"},"cantidadHistorica":{"type":"number"},"totalCosto":{"type":"number"},"totalIngreso":{"type":"number"}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/marcas/getAll":{"get":{"tags":["utilidades"],"summary":"Obtener todas las marcas.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/marca"}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/marcas/add":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["utilidades"],"summary":"Agregar una marca.","requestBody":{"content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/marca"},"example":{"nombre":"Marca X"}}}},"responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"$ref":"#/components/schemas/marca"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/marcas/delete/{deleteString}":{"delete":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["utilidades"],"summary":"Eliminar un listado de marcas.","parameters":[{"name":"deleteString","in":"path","required":true,"allowEmptyValue":false,"example":"marca marsa marxa marza","schema":{"type":"string","description":"String de marcas a elminar separados por un espacio en blanco"}}],"responses":{"200":{"$ref":"#/components/responses/Succes"},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getTags":{"get":{"tags":["utilidades"],"summary":"Obtener todas los tags.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/tag"}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getListOfTagsFilteredByRegex":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["utilidades"],"summary":"Obtener todas los tags.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"value":{"type":"string","description":"Regex para buscar"}}}}}},"responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/tag"}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/addTag":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["utilidades"],"summary":"Agregar un tag.","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/tag"},"example":{"name":"TAGX"}}}},"responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"$ref":"#/components/schemas/tag"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/deteleTags":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["utilidades"],"summary":"Eliminar tags.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"array","items":{"type":"string"}}}}},"responses":{"200":{"$ref":"#/components/responses/Succes"},"401":{"$ref":"#/components/responses/Error-401"}}}},"/auth/login":{"post":{"tags":["auth"],"summary":"Realizar login.","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/login"}}}},"responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"$ref":"#/components/schemas/authToken"}}}},"400":{"$ref":"#/components/responses/Error-401"}}}},"/auth/google":{"get":{"tags":["auth"],"summary":"Te redirije a el sistema de autorizacion de login de google.","externalDocs":{"url":"https://cloud.google.com/nodejs/getting-started/authenticate-users?hl=es"},"responses":{"302":{"description":"Redirijiendo"},"400":{"$ref":"#/components/responses/Error-401"}}}},"/auth/google/callback":{"get":{"tags":["auth"],"summary":"Callback a donde te redirije google. Detectara si ir a la pagina de registro o iniciar sesión.","externalDocs":{"url":"https://cloud.google.com/nodejs/getting-started/authenticate-users?hl=es"},"responses":{"302":{"description":"Redirijiendo."},"400":{"$ref":"#/components/responses/Error-401"}}}},"/auth/google/loginfast":{"post":{"tags":["auth"],"summary":"Usando un token se realiza el inicio de sesión.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"loginToken":{"type":"string"}}}}}},"responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"$ref":"#/components/schemas/authToken"}}}},"400":{"$ref":"#/components/responses/Error-401"}}}},"/auth/google/getLoginInfoFromToken":{"post":{"tags":["auth"],"summary":"Usando un token adquiera la información de usuario dada por google.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"loginToken":{"type":"string"}}}}}},"responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"type":"boolean","properties":{"given_name":{"type":"string"},"family_name":{"type":"string"},"email":{"type":"string"},"sub":{"type":"string","description":"Codigo de google"}}}}}},"400":{"$ref":"#/components/responses/Error-401"}}}},"/auth/google/registerlow":{"post":{"tags":["auth"],"summary":"Registra a un usuario, ademas envia un email de confirmación.","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/user"}}}},"responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"$ref":"#/components/schemas/user"}}}},"400":{"$ref":"#/components/responses/Error-401"}}}},"/auth/cambiarContrasena":{"post":{"security":[{"JWT TOKEN ALL":[]}],"tags":["auth"],"summary":"Cambiar contraseña de usuario","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"id":{"type":"string","description":"ID del usuario"},"passwordOld":{"type":"string","description":"Contraseña antigua"}}}}}},"responses":{"200":{"$ref":"#/components/responses/Succes"},"400":{"$ref":"#/components/responses/Error-401"}}}},"/auth/actCelular":{"post":{"tags":["auth"],"security":[{"JWT TOKEN ALL":[]}],"summary":"Cambiar celular de usuario","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"id":{"type":"string","description":"ID del usuario"},"celular":{"type":"string","description":"Contraseña antigua"}}}}}},"responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"$ref":"#/components/schemas/user"}}}},"400":{"$ref":"#/components/responses/Error-401"}}}},"/auth/agregarDireccion":{"post":{"tags":["auth"],"security":[{"JWT TOKEN ALL":[]}],"summary":"Agregar o cambiar dirección de usuario.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"id":{"type":"string","description":"ID del usuario"},"dirOne":{"type":"string"},"dirTwo":{"type":"string"},"reference":{"type":"string"}}}}}},"responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"$ref":"#/components/schemas/user"}}}},"400":{"$ref":"#/components/responses/Error-401"}}}},"/auth/agregarDocumento":{"post":{"tags":["auth"],"security":[{"JWT TOKEN ALL":[]}],"summary":"Agregar o cambiar documento de usuario.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"id":{"type":"string","description":"ID del usuario"},"documento":{"type":"string"},"tipoPersona":{"type":"string","enum":["dni","ruc"]}}}}}},"responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"$ref":"#/components/schemas/user"}}}},"400":{"$ref":"#/components/responses/Error-401"}}}},"/auth/getUserInfo/{username}":{"get":{"security":[{"JWT TOKEN ALL":[]}],"parameters":[{"name":"username","in":"path","required":true,"allowEmptyValue":false,"example":"DWEWQX123D2D","schema":{"type":"string","description":"Codigo del usario"}}],"tags":["reportes"],"summary":"Obtener usuario.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"$ref":"#/components/schemas/user"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/auth/getOwnUser":{"get":{"security":[{"JWT TOKEN ALL":[]}],"tags":["reportes"],"summary":"Obtener usuario propio.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"$ref":"#/components/schemas/user"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/auth/userEx":{"get":{"security":[{"JWT TOKEN ALL":[]}],"parameters":[{"name":"username","in":"path","required":true,"allowEmptyValue":false,"example":"DWEWQX123D2D","schema":{"type":"string","description":"Codigo del usario"}}],"tags":["reportes"],"summary":"Buscar si el usuario existe.","responses":{"200":{"description":"Ok","content":{"application/json":{"schema":{"$ref":"#/components/schemas/user"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/ventas/ventaSimple":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["ventas"],"summary":"Realiza una venta con solo 1 item.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"venta":{"$ref":"#/components/schemas/venta"}}}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"type":"object","properties":{"venta":{"$ref":"#/components/schemas/venta"},"message":{"type":"string"},"_sunat":{"type":"object"}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/ventas/agregarVenta":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["ventas"],"summary":"Crear una nueva venta con 1 item.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"venta":{"$ref":"#/components/schemas/venta"}}}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"type":"object","properties":{"venta":{"$ref":"#/components/schemas/venta"},"message":{"type":"string"}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/ventas/agregarItemVenta":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["ventas"],"summary":"Agregar un item a una venta.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"codigoVenta":{"type":"string"},"itemVendido":{"$ref":"#/components/schemas/itemvendido"}}}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"type":"object","properties":{"venta":{"$ref":"#/components/schemas/venta"},"message":{"type":"string"}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/ventas/ejecutarVenta":{"post":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["ventas"],"summary":"Ejecutar venta.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"venta":{"$ref":"#/components/schemas/venta"}}}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"type":"object","properties":{"venta":{"$ref":"#/components/schemas/venta"},"message":{"type":"string"},"_sunat":{"type":"object"}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/ventas/anularVentaPost":{"put":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["ventas"],"summary":"Anular venta post ejecución.","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/venta"}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"type":"object","properties":{"message":{"type":"string"}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/ventas/anularVenta":{"put":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["ventas"],"summary":"Anular venta.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"venta":{"$ref":"#/components/schemas/venta"}}}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"type":"object","properties":{"message":{"type":"string"}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/ventas/eliminarItemVenta":{"put":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["ventas"],"summary":"Eliminar item de venta.","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/venta"}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/venta"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/ventas/eliminarItemSCVenta":{"put":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["ventas"],"summary":"Eliminar item de venta cuando el item tiene un sub-conteo.","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/venta"}}}},"responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/venta"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/ventas/getVentasActivasList":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["ventas"],"summary":"Obetener listado de las ventas activas del usuario.","responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"type":"array","items":{"type":"string"}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/ventas/ventasActivasFull":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"tags":["ventas"],"summary":"Obetener listado detallado de las ventas activas del usuario.","responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/venta"}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/ventas/obtenerVenta/{ventaCod}":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"parameters":[{"name":"ventaCod","in":"path","required":true,"allowEmptyValue":false,"example":"SD222","schema":{"type":"string","description":"Codigo de la venta."}}],"tags":["ventas"],"summary":"Obetener venta.","responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"$ref":"#/components/schemas/venta"}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/ventas/getGananciaTotalPorItem/{codigoItem}":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"parameters":[{"name":"codigoItem","in":"path","required":true,"allowEmptyValue":false,"example":"SD222","schema":{"type":"string","description":"Codigo del item."}}],"tags":["reportes"],"summary":"Obetener ganancia total por item.","responses":{"200":{"description":"Ok","content":{"aplication/json":{"schema":{"type":"object","properties":{"value":{"type":"number"},"totalVenta":{"type":"number"}}}}}},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getItemGananciaIngreso/{codigoItem}":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"parameters":[{"name":"codigoItem","in":"path","required":true,"allowEmptyValue":false,"example":"SD222","schema":{"type":"string","description":"Codigo del item."}}],"tags":["reportes"],"externalDocs":{"url":"https://swimlane.gitbook.io/ngx-charts/"},"summary":"Obtener ventas por mes para ser graficadas usando ngx-charts.","responses":{"200":{"$ref":"#/components/responses/Succes"},"401":{"$ref":"#/components/responses/Error-401"}}}},"/inventario/getItemsGanancias":{"get":{"security":[{"JWT TOKEN TRANSACCIONAL":[]}],"parameters":[{"name":"codigoItem","in":"path","required":true,"allowEmptyValue":false,"example":"SD222","schema":{"type":"string","description":"Codigo del item."}}],"tags":["reportes"],"externalDocs":{"url":"https://swimlane.gitbook.io/ngx-charts/"},"summary":"Obtener ventas por mes para ser graficadas usando ngx-charts.","responses":{"200":{"$ref":"#/components/responses/Succes"},"401":{"$ref":"#/components/responses/Error-401"}}}}}}'),lo=require("morgan");var mo=n.n(lo);N().key=m.production.tinyKey;var go=x()(),fo=m.production.log();go.use(S()({contentSecurityPolicy:!1})),go.use(f()()),go.use(b()()),go.use(mo()(":method :url")),go.use(v()({credentials:!0,origin:"*"})),go.use(x().json()),go.use(x().urlencoded({extended:!0})),go.use((function(e,t,n){if(e.headers&&e.headers.authorization&&"Bearer"===e.headers.authorization.split(" ")[0]){var r=e.headers.authorization;V().verify(r.split(" ")[1],m.production.jwtKey,{audience:r.split(" ")[2]+" "+r.split(" ")[3]},(function(r,a){if(r)return e.user=void 0,t.status(401).json({message:"Usuario No Autorizado"});e.user=a,n()}))}else e.user=void 0,n()})),go.use("/inventario",Ca),go.use("/carrito",ct),go.use("/auth",Ae),go.use("/ventas",so),go.use("/email",Jt),go.use("/coti",Wt),go.use("/api-docs",uo().serve,uo().setup(po)),go.get("/",(function(e,t){return t.redirect("/api-docs")})),go.use("/static",x().static(T().join(__dirname,"uploads"))),go.use((function(e,t,n,r){return n.status(e.status||500),fo.error(e),fo.info(e),n.json({error:{message:e.message}})}));const yo=go;var bo=m.production.log();const ho=function(){var e=A()(_().mark((function e(t){return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,W().connect(t,{useNewUrlParser:!0,useUnifiedTopology:!0,useCreateIndex:!0});case 3:return e.abrupt("return",bo.info("Connected To DataBase"));case 6:return e.prev=6,e.t0=e.catch(0),e.abrupt("return",bo.error(e.t0));case 9:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t){return e.apply(this,arguments)}}();n(142).config();var vo=a().createServer(yo),$o=m.production.PORT,xo=m.production.log(),wo=process.env.WEB_CONCURRENCY||1;yo.set("port",$o),i()({worker:function(e,t){xo.info("Id Worker ".concat(e)),vo.listen($o||0),ho(m.production.mongoKey)},count:wo}),vo.on("listening",(function(){xo.info("Hi there! I'm listening on port ".concat(vo.address().port," in ").concat(yo.get("env")," mode."))}))},502:e=>{e.exports=require("core-js/stable")},142:e=>{e.exports=require("dotenv")},936:e=>{e.exports=require("regenerator-runtime/runtime")},441:e=>{e.exports=require("sharp")}},t={};function n(r){var a=t[r];if(void 0!==a)return a.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n(502),n(936),n(77)})();